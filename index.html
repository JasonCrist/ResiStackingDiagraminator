<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residential Tower Stacking Tool</title>
    
    <!-- ExcelJS for Excel export with formulas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    
    <!-- Google Fonts - Distinctive architectural feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #f8f7f4;
            --bg-secondary: #ffffff;
            --bg-accent: #1a1a1a;
            --text-primary: #1a1a1a;
            --text-secondary: #5a5a5a;
            --text-light: #ffffff;
            --border-color: #e0ddd8;
            --border-dark: #c0bdb8;
            --accent-blue: #2563eb;
            --accent-green: #059669;
            --accent-orange: #d97706;
            --accent-purple: #7c3aed;
            --accent-red: #dc2626;
            --accent-teal: #0891b2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .header-subtitle {
            font-size: 0.875rem;
            opacity: 0.7;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
            position: sticky;
            top: 80px;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.375rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: inherit;
            background: var(--bg-secondary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group input[type="range"] {
            padding: 0;
            height: 6px;
            -webkit-appearance: none;
            background: var(--border-color);
            border-radius: 3px;
            border: none;
        }

        .form-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
        }

        .range-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-top: 0.25rem;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue);
        }

        .checkbox-group span {
            font-size: 0.875rem;
        }

        /* Radio Group */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .radio-option:hover {
            background: var(--bg-primary);
        }

        .radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-blue);
        }

        .radio-option span {
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-sm {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
        }

        .btn-full {
            width: 100%;
        }

        /* Content Area */
        .content {
            padding: 1.5rem 2rem;
            overflow-y: auto;
        }

        /* Floor Types Section */
        .floor-types-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .floor-types-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .floor-type-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .floor-type-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .floor-type-header:hover {
            background: var(--bg-primary);
        }

        .floor-type-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .floor-type-badge {
            padding: 0.25rem 0.625rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .floor-type-badge.residential { background: #dcfce7; color: #166534; }
        .floor-type-badge.parking { background: #f3f4f6; color: #374151; }
        .floor-type-badge.retail { background: #dbeafe; color: #1e40af; }
        .floor-type-badge.amenity { background: #f3e8ff; color: #6b21a8; }
        .floor-type-badge.mechanical { background: #ffedd5; color: #c2410c; }
        .floor-type-badge.office { background: #cffafe; color: #0e7490; }

        .floor-type-name {
            font-weight: 600;
        }

        .floor-type-range {
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .floor-type-actions {
            display: flex;
            gap: 0.5rem;
        }

        .floor-type-body {
            display: none;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .floor-type-card.expanded .floor-type-body {
            display: block;
        }

        .floor-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .floor-type-grid .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* Preview Table */
        .preview-section {
            margin-top: 2rem;
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .preview-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .preview-table-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .preview-table th {
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
        }

        .preview-table th.number {
            text-align: right;
        }

        .preview-table td {
            padding: 0.625rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .preview-table td.number {
            text-align: right;
            font-family: 'Space Mono', monospace;
            font-size: 0.8125rem;
        }

        .preview-table tr:last-child td {
            border-bottom: none;
        }

        .preview-table tr:hover {
            background: var(--bg-primary);
        }

        .preview-table tr.totals {
            background: var(--bg-accent);
            color: var(--text-light);
            font-weight: 600;
        }

        .preview-table tr.totals td {
            border-bottom: none;
        }

        /* Row colors by use type */
        .preview-table tr.use-residential { background: #f0fdf4; }
        .preview-table tr.use-parking { background: #f9fafb; }
        .preview-table tr.use-retail { background: #eff6ff; }
        .preview-table tr.use-amenity { background: #faf5ff; }
        .preview-table tr.use-mechanical { background: #fff7ed; }
        .preview-table tr.use-office { background: #ecfeff; }

        .preview-table tr.use-residential:hover { background: #dcfce7; }
        .preview-table tr.use-parking:hover { background: #f3f4f6; }
        .preview-table tr.use-retail:hover { background: #dbeafe; }
        .preview-table tr.use-amenity:hover { background: #f3e8ff; }
        .preview-table tr.use-mechanical:hover { background: #ffedd5; }
        .preview-table tr.use-office:hover { background: #cffafe; }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-sm);
        }

        .summary-card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .summary-card-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-card-unit {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-left: 0.25rem;
        }

        /* Parking Summary */
        .parking-summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-top: 1.5rem;
        }

        .parking-summary h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .parking-summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .parking-stat {
            text-align: center;
        }

        .parking-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .parking-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .parking-stat-value.surplus { color: var(--accent-green); }
        .parking-stat-value.deficit { color: var(--accent-red); }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-mono {
            font-family: 'Space Mono', monospace;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .floor-type-card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                top: 0;
                max-height: none;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .floor-type-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Default Heights Table */
        .default-heights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .default-height-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.375rem 0;
            font-size: 0.8125rem;
        }

        .default-height-item label {
            color: var(--text-secondary);
        }

        .default-height-item input {
            width: 70px;
            padding: 0.25rem 0.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            text-align: right;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .toast.success {
            background: var(--accent-green);
        }

        .toast.error {
            background: var(--accent-red);
        }

        /* Drag and Drop Styles */
        .floor-type-card.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }

        .floor-type-card.drag-over {
            border: 2px dashed var(--accent-blue);
            background: rgba(37, 99, 235, 0.05);
        }

        .drag-handle {
            cursor: grab;
            padding: 0.5rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Floor action buttons */
        .floor-inline-actions {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .add-type-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-right: 0.5rem;
        }

        .add-type-label strong {
            color: var(--text-primary);
        }

        .floor-inline-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 3px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .floor-inline-actions button:hover {
            background: var(--bg-primary);
            border-color: var(--border-dark);
        }

        .floor-inline-actions button.add-btn {
            color: var(--accent-green);
        }

        .floor-inline-actions button.add-btn:hover {
            background: #dcfce7;
        }

        .floor-inline-actions button.delete-btn {
            color: var(--accent-red);
        }

        .floor-inline-actions button.delete-btn:hover {
            background: #fee2e2;
        }

        /* Floor count adjuster */
        .floor-count-adjuster {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .floor-count-adjuster button {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .floor-count-adjuster button:hover {
            background: var(--bg-primary);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .floor-count-adjuster .count-display {
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
            min-width: 60px;
            text-align: center;
            padding: 0.375rem 0.5rem;
            background: var(--bg-primary);
            border-radius: 4px;
        }

        /* Info tooltip */
        .info-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--border-color);
            color: var(--text-secondary);
            font-size: 0.625rem;
            font-weight: 700;
            cursor: help;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

        .info-tooltip:hover {
            background: var(--accent-blue);
            color: white;
        }

        .info-tooltip .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 400;
            line-height: 1.5;
            text-align: left;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            transition: opacity 0.2s, visibility 0.2s;
        }

        .info-tooltip .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: var(--bg-accent) transparent transparent transparent;
        }

        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .checkbox-with-info {
            display: flex;
            align-items: center;
        }

        /* SF input with inline GSF checkbox */
        .sf-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sf-input-group input[type="number"] {
            flex: 1;
        }

        .checkbox-inline {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            cursor: pointer;
        }

        .checkbox-inline input[type="checkbox"] {
            width: 14px;
            height: 14px;
            margin: 0;
        }

        .checkbox-inline span {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div>
            <h1>Residential Tower Stacking Tool</h1>
            <div class="header-subtitle">Generate Excel stacking diagrams with live formulas</div>
        </div>
        <div class="header-actions">
            <button class="btn btn-success" onclick="generateExcel()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download Excel
            </button>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Project Settings -->
            <div class="sidebar-section">
                <h3>Project Information</h3>
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" value="My Residential Tower" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label for="projectCity">City, State</label>
                    <input type="text" id="projectCity" value="Dallas, TX" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label for="projectNumber">Project Number</label>
                    <input type="text" id="projectNumber" value="00000.000" oninput="updatePreview()">
                </div>
            </div>

            <!-- Building Settings -->
            <div class="sidebar-section">
                <h3>Building Settings</h3>
                <div class="form-group">
                    <label for="efficiency">Typical Floor Residential Efficiency Goal</label>
                    <input type="range" id="efficiency" min="70" max="95" value="85" oninput="updateEfficiencyDisplay()">
                    <div class="range-value" id="efficiencyValue">85%</div>
                </div>
                <div class="form-group">
                    <label for="efficiencyGoal">Overall Efficiency Goal</label>
                    <input type="range" id="efficiencyGoal" min="70" max="95" value="80" oninput="updateEfficiencyGoalDisplay()">
                    <div class="range-value" id="efficiencyGoalValue">80%</div>
                </div>
                <div class="form-group">
                    <div class="checkbox-with-info">
                        <label class="checkbox-group">
                            <input type="checkbox" id="skip13" checked onchange="updatePreview()">
                            <span>Skip Floor 13</span>
                        </label>
                        <div class="info-tooltip">
                            i
                            <div class="tooltip-text">
                                <strong>Triskaidekaphobia</strong> is the fear of the number 13. Many residential buildings skip the 13th floor in their numbering (going directly from 12 to 14) to avoid superstitious concerns from potential residents and to improve marketability. This practice is common in high-rise residential towers.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parking Calculator -->
            <div class="sidebar-section">
                <h3>Parking Calculator</h3>
                <div class="form-group">
                    <label for="sfPerCar">SF per Car</label>
                    <input type="number" id="sfPerCar" value="410" min="100" max="600" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>Parking Ratio Method</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="parkingMethod" value="beds" checked onchange="updateParkingMethod()">
                            <span>Cars per Bed</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="parkingMethod" value="units" onchange="updateParkingMethod()">
                            <span>Cars per Unit</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="parkingMethod" value="fixed" onchange="updateParkingMethod()">
                            <span>Fixed Count</span>
                        </label>
                    </div>
                </div>
                <div class="form-group" id="parkingRatioGroup">
                    <label for="parkingRatio">Cars per Bed Ratio</label>
                    <input type="number" id="parkingRatio" value="0.9" min="0.1" max="3" step="0.1" oninput="updatePreview()">
                </div>
                <div class="form-group hidden" id="fixedParkingGroup">
                    <label for="fixedParking">Required Cars</label>
                    <input type="number" id="fixedParking" value="150" min="1" oninput="updatePreview()">
                </div>
            </div>

            <!-- Default Heights -->
            <div class="sidebar-section">
                <h3>Default Heights</h3>
                <div class="default-heights-grid">
                    <div class="default-height-item">
                        <label>Below Grade</label>
                        <input type="text" id="defaultHeightBelowGrade" value="10' 0&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Ground</label>
                        <input type="text" id="defaultHeightGround" value="18' 0&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>P2 (Van)</label>
                        <input type="text" id="defaultHeightP2" value="11' 0&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>P3+ Parking</label>
                        <input type="text" id="defaultHeightParking" value="9' 8&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Residential</label>
                        <input type="text" id="defaultHeightResidential" value="10' 8&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Amenity</label>
                        <input type="text" id="defaultHeightAmenity" value="12' 0&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Penthouse</label>
                        <input type="text" id="defaultHeightPenthouse" value="11' 8&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Mechanical</label>
                        <input type="text" id="defaultHeightMechanical" value="15' 0&quot;" oninput="updatePreview()">
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="sidebar-section">
                <button class="btn btn-secondary btn-full" onclick="resetToDefaults()">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    Reset &amp; Start Over
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-card-label">Total Floors</div>
                    <div class="summary-card-value" id="summaryFloors">0<span class="summary-card-unit">floors</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total Height</div>
                    <div class="summary-card-value" id="summaryHeight">0<span class="summary-card-unit">ft</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total GSF</div>
                    <div class="summary-card-value" id="summaryGSF">0<span class="summary-card-unit">SF</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total RSF</div>
                    <div class="summary-card-value" id="summaryRSF">0<span class="summary-card-unit">SF</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Efficiency</div>
                    <div class="summary-card-value" id="summaryEfficiency">0<span class="summary-card-unit">%</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total Parking</div>
                    <div class="summary-card-value" id="summaryParking">0<span class="summary-card-unit">cars</span></div>
                </div>
            </div>

            <!-- Floor Types Configuration -->
            <div class="floor-types-header">
                <h2>Floor Type Configuration</h2>
                <button class="btn btn-primary" onclick="addFloorType()">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Floor Type
                </button>
            </div>

            <div id="floorTypesContainer">
                <!-- Floor type cards will be rendered here -->
            </div>

            <button class="btn btn-secondary" onclick="renumberFloors()" style="margin-top: 1rem;">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Renumber Floors
            </button>

            <!-- Preview Table -->
            <div class="preview-section">
                <div class="preview-header">
                    <h2>Building Preview</h2>
                </div>
                
                <div class="preview-table-wrapper">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Floor</th>
                                <th>Type</th>
                                <th>Primary Use</th>
                                <th class="number">Height</th>
                                <th class="number">Primary Area</th>
                                <th class="number">GSF</th>
                                <th class="number">Constr. GSF</th>
                                <th class="number">Efficiency</th>
                                <th class="number">RSF</th>
                                <th class="number">Parking SF</th>
                                <th class="number">Calc Cars</th>
                                <th class="number">Actual Cars Drawn</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- Preview rows will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <!-- Parking Summary -->
                <div class="parking-summary">
                    <h3>
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                        Parking Summary
                    </h3>
                    <div class="parking-summary-grid">
                        <div class="parking-stat">
                            <div class="parking-stat-label">Parking Provided</div>
                            <div class="parking-stat-value" id="parkingProvided">0</div>
                        </div>
                        <div class="parking-stat">
                            <div class="parking-stat-label">Parking Required</div>
                            <div class="parking-stat-value" id="parkingRequired">0</div>
                        </div>
                        <div class="parking-stat">
                            <div class="parking-stat-label">Surplus / (Deficit)</div>
                            <div class="parking-stat-value" id="parkingSurplus">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        let state = {
            floorTypes: [],
            projectName: 'My Residential Tower',
            projectCity: 'Dallas, TX',
            projectNumber: '00000.000',
            efficiency: 0.85,
            efficiencyGoal: 0.80,
            skip13: true,
            sfPerCar: 410,
            parkingMethod: 'beds',
            parkingRatio: 0.9,
            fixedParking: 150,
            defaultHeights: {
                belowGrade: 10.0,
                ground: 18.0,
                p2: 11.0,
                parking: 9.67,
                residential: 10.67,
                amenity: 12.0,
                penthouse: 11.67,
                mechanical: 15.0
            }
        };

        const USE_TYPES = ['Residential', 'Parking', 'Retail', 'Amenity', 'Mechanical', 'Office'];

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function feetInchesToDecimal(str) {
            if (!str) return 10.0;
            str = str.toString().trim();
            
            // If already a number
            if (!str.includes("'") && !str.includes('"')) {
                return parseFloat(str) || 10.0;
            }
            
            // Parse feet and inches
            const match = str.match(/(\d+)'?\s*(\d+)?/);
            if (match) {
                const feet = parseInt(match[1]) || 0;
                const inches = parseInt(match[2]) || 0;
                return feet + (inches / 12);
            }
            return 10.0;
        }

        function decimalToFeetInches(decimal) {
            const feet = Math.floor(decimal);
            const inches = Math.round((decimal - feet) * 12);
            return `${feet}' ${inches}"`;
        }

        function parseFloorLabel(label) {
            label = String(label).trim().toUpperCase();
            
            // Plenum
            if (label.includes('PLENUM')) {
                const baseLabel = label.replace('PLENUM', '').trim();
                return parseFloorLabel(baseLabel) - 0.5;
            }
            
            // Below grade (B1, B2, etc) - negative numbers
            if (label.startsWith('B')) {
                const nums = label.match(/\d+/);
                if (nums) return -1000 - parseInt(nums[0]);
                return -1000;
            }
            
            // Parking levels (P2, P3, etc) - these ARE part of floor sequence
            // P2 = floor 2, P3 = floor 3, etc.
            if (label.startsWith('P')) {
                const nums = label.match(/\d+/);
                if (nums) return parseInt(nums[0]);
                return 2;
            }
            
            // Ground floor = floor 1
            if (['G', 'GROUND', 'GF'].includes(label)) {
                return 1;
            }
            
            // Numbered floors
            const nums = label.match(/\d+/);
            if (nums) return parseInt(nums[0]);
            
            return 1;
        }

        // Format floor number with leading zero
        function formatFloorNumber(num) {
            if (num < 10 && num > 0) {
                return '0' + num;
            }
            return String(num);
        }

        // Format P-level with leading zero
        function formatPLevel(num) {
            if (num < 10 && num > 0) {
                return 'P0' + num;
            }
            return 'P' + num;
        }

        function generateFloorRange(start, end, skip13 = false) {
            const startNum = parseFloorLabel(start);
            const endNum = parseFloorLabel(end);
            const floors = [];
            
            const isPRange = String(start).toUpperCase().startsWith('P') || String(end).toUpperCase().startsWith('P');
            
            // Below grade range (B1 -> B3, shallow to deep)
            if (startNum < 0 && endNum < 0) {
                const startB = Math.abs(startNum + 1000);
                const endB = Math.abs(endNum + 1000);
                for (let i = Math.min(startB, endB); i <= Math.max(startB, endB); i++) {
                    floors.push(`B${i}`);
                }
            }
            // P-levels (parking above grade, part of floor sequence)
            else if (isPRange) {
                const startP = parseInt(String(start).match(/\d+/)?.[0]) || 2;
                const endP = parseInt(String(end).match(/\d+/)?.[0]) || 2;
                for (let i = startP; i <= endP; i++) {
                    if (skip13 && i === 13) continue;
                    floors.push(formatPLevel(i));
                }
            }
            // Mixed range (below grade to above grade)
            else if (startNum <= 0 && endNum >= 0) {
                // Below grade portion
                if (startNum < 0) {
                    const startB = Math.abs(startNum + 1000);
                    for (let i = 1; i <= startB; i++) {
                        floors.push(`B${i}`);
                    }
                }
                // Ground
                floors.push('G');
                // Above grade
                for (let i = 2; i <= endNum; i++) {
                    if (skip13 && i === 13) continue;
                    floors.push(formatFloorNumber(i));
                }
            }
            // Above grade only
            else {
                const minNum = Math.min(startNum, endNum);
                const maxNum = Math.max(startNum, endNum);
                for (let i = minNum; i <= maxNum; i++) {
                    if (skip13 && i === 13) continue;
                    if (i === 1) {
                        floors.push('G');
                    } else {
                        floors.push(formatFloorNumber(i));
                    }
                }
            }
            
            return floors;
        }

        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        // ============================================
        // UI RENDERING
        // ============================================

        function renderFloorTypes() {
            const container = document.getElementById('floorTypesContainer');
            container.innerHTML = '';
            
            // Create a sorted copy for display (roof at top, basement at bottom)
            const sortedIndices = state.floorTypes.map((ft, idx) => ({
                idx,
                sortOrder: parseFloorLabel(ft.startFloor)
            })).sort((a, b) => b.sortOrder - a.sortOrder);
            
            sortedIndices.forEach(({idx: index}, displayIndex) => {
                const ft = state.floorTypes[index];
                const floorCount = countFloorsInRange(ft.startFloor, ft.endFloor);
                
                const card = document.createElement('div');
                card.className = `floor-type-card ${ft.expanded ? 'expanded' : ''}`;
                card.dataset.index = index;
                
                // Drop target events on the card
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragleave', handleDragLeave);
                
                // Build additional uses badges for header
                const additionalBadges = ft.additionalUses ? ft.additionalUses
                    .filter(au => au.enabled && au.use)
                    .map(au => `<span class="floor-type-badge ${au.use.toLowerCase()}" style="opacity: 0.7; font-size: 0.65rem;">+${au.use}</span>`)
                    .join('') : '';
                
                // Build additional uses HTML
                let additionalUsesHTML = '';
                if (ft.additionalUses) {
                    for (let i = 0; i < 4; i++) {
                        const au = ft.additionalUses[i] || { enabled: false, use: 'Residential', sf: 0, countsInGSF: true };
                        // Show checkbox if: first one OR previous one is enabled
                        const showCheckbox = i === 0 || (ft.additionalUses[i-1] && ft.additionalUses[i-1].enabled);
                        
                        if (showCheckbox) {
                            additionalUsesHTML += `
                            <div class="form-group full-width" style="${i === 0 ? 'border-top: 1px dashed var(--border-color); padding-top: 1rem; margin-top: 0.5rem;' : ''}">
                                <label class="checkbox-group">
                                    <input type="checkbox" ${au.enabled ? 'checked' : ''} onchange="toggleAdditionalUse(${index}, ${i}, this.checked)">
                                    <span style="font-weight: 600;">Additional Use ${i + 1}</span>
                                </label>
                            </div>
                            `;
                            
                            if (au.enabled) {
                                additionalUsesHTML += `
                                <div class="form-group">
                                    <label>Additional Use ${i + 1}</label>
                                    <select onchange="updateAdditionalUseType(${index}, ${i}, this.value)">
                                        ${USE_TYPES.map(u => `<option value="${u}" ${au.use === u ? 'selected' : ''}>${u}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Additional Use ${i + 1} Area per Floor</label>
                                    <div class="sf-input-group">
                                        <input type="number" value="${au.sf || ''}" placeholder="0" onchange="updateAdditionalUseSF(${index}, ${i}, this.value)">
                                        <label class="checkbox-inline">
                                            <input type="checkbox" ${au.countsInGSF ? 'checked' : ''} onchange="updateAdditionalUseGSF(${index}, ${i}, this.checked)">
                                            <span>GSF</span>
                                        </label>
                                    </div>
                                </div>
                                `;
                            }
                        }
                    }
                }
                
                card.innerHTML = `
                    <div class="floor-type-header" onclick="toggleFloorType(${index})">
                        <div class="floor-type-info">
                            <div class="drag-handle" draggable="true" data-index="${index}" title="Drag to reorder">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/>
                                    <circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/>
                                </svg>
                            </div>
                            <span class="floor-type-badge ${ft.use.toLowerCase()}">${ft.use}</span>
                            ${additionalBadges}
                            <span class="floor-type-name">${ft.name}</span>
                            <span class="floor-type-range">${ft.startFloor} → ${ft.endFloor} (${floorCount} floor${floorCount !== 1 ? 's' : ''})</span>
                        </div>
                        <div class="floor-inline-actions" onclick="event.stopPropagation()">
                            <span class="add-type-label">Add <strong>TYPE</strong></span>
                            <button class="add-btn" onclick="addFloorTypeAt(${index}, 'above')" title="Add floor type above">+ Above</button>
                            <button class="add-btn" onclick="addFloorTypeAt(${index}, 'below')" title="Add floor type below">+ Below</button>
                            <button class="delete-btn" onclick="deleteFloorType(${index})" title="Delete">✕</button>
                        </div>
                    </div>
                    <div class="floor-type-body">
                        <div class="floor-type-grid">
                            <div class="form-group">
                                <label>Primary Use</label>
                                <select onchange="updateFloorTypeUse(${index}, this.value)">
                                    ${USE_TYPES.map(u => `<option value="${u}" ${ft.use === u ? 'selected' : ''}>${u}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" value="${ft.name}" onchange="updateFloorTypeField(${index}, 'name', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Number of Floors</label>
                                <div class="floor-count-adjuster">
                                    <button onclick="adjustFloorCount(${index}, -1)">−</button>
                                    <div class="count-display">${floorCount} floor${floorCount !== 1 ? 's' : ''}</div>
                                    <button onclick="adjustFloorCount(${index}, 1)">+</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Floor Range</label>
                                <div class="count-display" style="text-align: left; padding: 0.5rem;">${ft.startFloor} → ${ft.endFloor}</div>
                            </div>
                            <div class="form-group">
                                <label>Primary Area per Floor</label>
                                <div class="sf-input-group">
                                    <input type="number" value="${ft.gsf}" onchange="updateFloorTypeField(${index}, 'gsf', parseInt(this.value))">
                                    <label class="checkbox-inline">
                                        <input type="checkbox" ${ft.countsInGSF ? 'checked' : ''} onchange="updateFloorTypeField(${index}, 'countsInGSF', this.checked)">
                                        <span>GSF</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Floor Height</label>
                                <input type="text" value="${ft.height}" onchange="updateFloorTypeField(${index}, 'height', this.value)">
                            </div>
                            
                            ${ft.use === 'Parking' ? `
                            <div class="form-group">
                                <label>Actual Cars Drawn</label>
                                <input type="number" value="${ft.actualCars || ''}" placeholder="# As Drawn (overrides calculated)" onchange="updateFloorTypeField(${index}, 'actualCars', parseInt(this.value) || null)">
                            </div>
                            ` : ''}
                            
                            ${additionalUsesHTML}
                        </div>
                    </div>
                `;
                
                // Add drag events to the drag handle
                const dragHandle = card.querySelector('.drag-handle');
                dragHandle.addEventListener('dragstart', function(e) {
                    e.stopPropagation();
                    draggedItem = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', this.dataset.index);
                });
                dragHandle.addEventListener('dragend', function(e) {
                    card.classList.remove('dragging');
                    document.querySelectorAll('.floor-type-card').forEach(c => {
                        c.classList.remove('drag-over');
                    });
                });
                
                container.appendChild(card);
            });
        }

        // Count floors in a range
        function countFloorsInRange(start, end) {
            const floors = generateFloorRange(start, end, state.skip13);
            return floors.length;
        }

        // Adjust floor count (add/remove floors from range)
        function adjustFloorCount(index, delta) {
            const ft = state.floorTypes[index];
            const startNum = parseFloorLabel(ft.startFloor);
            const endNum = parseFloorLabel(ft.endFloor);
            
            // Determine the direction of the range
            const isBelowGrade = ft.startFloor.toUpperCase().startsWith('B');
            const isPLevel = ft.isPLevel || ft.startFloor.toUpperCase().startsWith('P');
            const isGround = ['G', 'GROUND', 'GF'].includes(ft.startFloor.toUpperCase());
            
            if (isGround) {
                // Single ground floor - can't adjust
                return;
            }
            
            if (isBelowGrade) {
                // For B levels: B1 to B3 means going deeper
                const startB = parseInt(ft.startFloor.match(/\d+/)?.[0]) || 1;
                const endB = parseInt(ft.endFloor.match(/\d+/)?.[0]) || 1;
                const newEndB = Math.max(startB, endB + delta);
                ft.endFloor = `B${newEndB}`;
            } else if (isPLevel) {
                // P-levels are part of sequence - adjust end floor
                const startP = parseInt(ft.startFloor.match(/\d+/)?.[0]) || 2;
                const endP = parseInt(ft.endFloor.match(/\d+/)?.[0]) || 2;
                let newEndP = Math.max(startP, endP + delta);
                
                // Skip 13 if needed
                if (state.skip13 && newEndP === 13) {
                    newEndP = delta > 0 ? 14 : 12;
                }
                
                ft.endFloor = formatPLevel(newEndP);
            } else {
                // Regular numbered floors
                const endFloorNum = parseInt(ft.endFloor.match(/\d+/)?.[0]) || 2;
                const startFloorNum = parseInt(ft.startFloor.match(/\d+/)?.[0]) || 2;
                let newEndNum = endFloorNum + delta;
                
                // Don't go below start
                if (newEndNum < startFloorNum) newEndNum = startFloorNum;
                
                // Skip 13 if needed
                if (state.skip13 && newEndNum === 13) {
                    newEndNum = delta > 0 ? 14 : 12;
                }
                
                ft.endFloor = formatFloorNumber(newEndNum);
            }
            
            // Re-sort and renumber all floors after this one
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        // Drag and Drop handlers
        let draggedItem = null;

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex = parseInt(this.dataset.index);
            
            if (fromIndex !== toIndex && !isNaN(fromIndex) && !isNaN(toIndex)) {
                // Get the floor types
                const fromType = state.floorTypes[fromIndex];
                const toType = state.floorTypes[toIndex];
                
                // Swap the floor ranges (so visual positions actually change)
                const tempStart = fromType.startFloor;
                const tempEnd = fromType.endFloor;
                const tempIsPLevel = fromType.isPLevel;
                
                fromType.startFloor = toType.startFloor;
                fromType.endFloor = toType.endFloor;
                fromType.isPLevel = toType.isPLevel;
                
                toType.startFloor = tempStart;
                toType.endFloor = tempEnd;
                toType.isPLevel = tempIsPLevel;
                
                // Re-render (don't call autoRenumberFloors - that would undo the swap)
                renderFloorTypes();
                updatePreview();
                showToast('Floor types reordered!', 'success');
            }
        }

        // Add floor type at specific position (copies from reference floor type)
        function addFloorTypeAt(index, position) {
            const referenceType = state.floorTypes[index];
            
            // Create a copy of the reference floor type
            let newType = {
                name: referenceType.name + ' (Copy)',
                use: referenceType.use,
                startFloor: referenceType.startFloor,
                endFloor: referenceType.startFloor, // Start with single floor
                gsf: referenceType.gsf,
                height: referenceType.height,
                countsInGSF: referenceType.countsInGSF,
                actualCars: referenceType.actualCars,
                expanded: true,
                isPLevel: referenceType.isPLevel,
                additionalUses: referenceType.additionalUses ? 
                    referenceType.additionalUses.map(au => ({...au})) : 
                    getDefaultAdditionalUses()
            };
            
            // Insert at the correct position
            if (position === 'above') {
                state.floorTypes.splice(index + 1, 0, newType);
            } else {
                state.floorTypes.splice(index, 0, newType);
            }
            
            // Auto-renumber
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        // Auto-renumber all floors based on order
        function autoRenumberFloors() {
            // Sort by current start floor to maintain relative order
            state.floorTypes.sort((a, b) => {
                return parseFloorLabel(a.startFloor) - parseFloorLabel(b.startFloor);
            });
            
            let currentFloor = 2; // Start after ground (floor 1)
            
            state.floorTypes.forEach((ft) => {
                const isBelowGrade = ft.startFloor.toUpperCase().startsWith('B');
                const isPLevel = ft.isPLevel || ft.startFloor.toUpperCase().startsWith('P');
                const isGround = ['G', 'GROUND', 'GF'].includes(ft.startFloor.toUpperCase());
                
                // Skip basement - they have their own numbering
                if (isBelowGrade) {
                    return;
                }
                
                // Ground floor is always floor 1
                if (isGround) {
                    return;
                }
                
                const floorCount = countFloorsInRange(ft.startFloor, ft.endFloor);
                let newStart = currentFloor;
                let newEnd = currentFloor + floorCount - 1;
                
                // Handle skip 13
                if (state.skip13) {
                    // Check if range crosses 13
                    if (newStart <= 13 && newEnd >= 13) {
                        newEnd++;
                    }
                    if (newStart === 13) {
                        newStart = 14;
                        newEnd = newStart + floorCount - 1;
                    }
                }
                
                // P-levels keep their P prefix but use sequential numbers
                if (isPLevel) {
                    ft.startFloor = formatPLevel(newStart);
                    ft.endFloor = formatPLevel(newEnd);
                    ft.isPLevel = true;
                } else {
                    ft.startFloor = formatFloorNumber(newStart);
                    ft.endFloor = formatFloorNumber(newEnd);
                }
                
                currentFloor = newEnd + 1;
                if (state.skip13 && currentFloor === 13) {
                    currentFloor = 14;
                }
            });
        }

        function renderPreviewTable() {
            const tbody = document.getElementById('previewTableBody');
            const allFloors = generateAllFloors();
            
            // Sort floors from top to bottom (roof to basement)
            allFloors.sort((a, b) => b.sortOrder - a.sortOrder);
            
            let totalFloors = 0;
            let totalHeight = 0;
            let totalGSF = 0;
            let totalConstructionGSF = 0;
            let totalRSF = 0;
            let totalParking = 0;
            let totalParkingSF = 0;
            let totalBeds = 0;
            let totalUnits = 0;
            let totalCalcCars = 0;
            let totalActualCars = 0;
            
            let html = '';
            
            allFloors.forEach(floor => {
                const height = feetInchesToDecimal(floor.height);
                const efficiency = floor.use === 'Residential' ? state.efficiency : 0;
                
                // Calculate GSF (only checked items)
                let floorGSF = 0;
                if (floor.countsInGSF) {
                    floorGSF += floor.gsf;
                }
                
                // Calculate Construction GSF (ALL items)
                let floorConstructionGSF = floor.gsf;
                
                // Calculate primary RSF (only for Residential with GSF checked)
                let primaryRSF = 0;
                if (floor.use === 'Residential' && floor.countsInGSF) {
                    primaryRSF = Math.round(floor.gsf * efficiency);
                }
                
                // Calculate RSF and GSF from additional uses
                let additionalRSF = 0;
                if (floor.additionalUses) {
                    floor.additionalUses.forEach(au => {
                        if (au.enabled && au.sf > 0) {
                            // Add to Construction GSF (all items)
                            floorConstructionGSF += au.sf;
                            
                            // Add to GSF only if checked
                            if (au.countsInGSF) {
                                floorGSF += au.sf;
                            }
                            
                            // Add RSF if Residential and GSF is checked
                            if (au.use === 'Residential' && au.countsInGSF) {
                                additionalRSF += Math.round(au.sf * efficiency);
                            }
                        }
                    });
                }
                
                const totalRSFForFloor = primaryRSF + additionalRSF;
                
                // Parking calculations - primary and additional uses
                let parkingSF = 0;
                if (floor.use === 'Parking') {
                    parkingSF = floor.gsf;
                }
                if (floor.additionalUses) {
                    floor.additionalUses.forEach(au => {
                        if (au.enabled && au.use === 'Parking' && au.sf > 0) {
                            parkingSF += au.sf;
                        }
                    });
                }
                
                const calcCars = parkingSF > 0 ? Math.floor(parkingSF / state.sfPerCar) : 0;
                const actualCars = floor.actualCars || 0;
                
                // Always count the floor
                totalFloors++;
                totalHeight += height;
                
                // Totals
                totalGSF += floorGSF;
                totalConstructionGSF += floorConstructionGSF;
                totalRSF += totalRSFForFloor;
                totalCalcCars += calcCars;
                totalActualCars += actualCars;
                totalParking += actualCars > 0 ? actualCars : calcCars;
                totalParkingSF += parkingSF;
                
                // Estimate beds/units for residential
                if (totalRSFForFloor > 0) {
                    const avgUnitSize = 1000; // Assumption
                    const unitsOnFloor = Math.round(totalRSFForFloor / avgUnitSize);
                    const bedsOnFloor = Math.round(unitsOnFloor * 1.8); // Assumption: avg 1.8 beds/unit
                    totalBeds += bedsOnFloor;
                    totalUnits += unitsOnFloor;
                }
                
                html += `
                    <tr class="use-${floor.use.toLowerCase()}">
                        <td class="text-mono">${floor.label}</td>
                        <td>${floor.typeName}</td>
                        <td>${floor.use}</td>
                        <td class="number">${decimalToFeetInches(height)}</td>
                        <td class="number">${formatNumber(floor.gsf)}</td>
                        <td class="number">${floorGSF > 0 ? formatNumber(floorGSF) : '-'}</td>
                        <td class="number">${formatNumber(floorConstructionGSF)}</td>
                        <td class="number">${floor.use === 'Residential' ? Math.round(efficiency * 100) + '%' : '-'}</td>
                        <td class="number">${totalRSFForFloor > 0 ? formatNumber(totalRSFForFloor) : '-'}</td>
                        <td class="number">${parkingSF > 0 ? formatNumber(parkingSF) : '-'}</td>
                        <td class="number">${calcCars > 0 ? calcCars : '-'}</td>
                        <td class="number">${floor.actualCars ? floor.actualCars : '-'}</td>
                    </tr>
                `;
            });
            
            // Totals row
            const overallEfficiency = totalGSF > 0 ? (totalRSF / totalGSF * 100) : 0;
            
            html += `
                <tr class="totals">
                    <td colspan="3">TOTALS</td>
                    <td class="number">${decimalToFeetInches(totalHeight)}</td>
                    <td class="number">-</td>
                    <td class="number">${formatNumber(totalGSF)} GSF</td>
                    <td class="number">${formatNumber(totalConstructionGSF)} SF</td>
                    <td class="number">${overallEfficiency.toFixed(1)}%</td>
                    <td class="number">${formatNumber(totalRSF)} RSF</td>
                    <td class="number">${formatNumber(totalParkingSF)} SF</td>
                    <td class="number">${totalCalcCars} cars</td>
                    <td class="number">${totalActualCars > 0 ? totalActualCars + ' cars' : '-'}</td>
                </tr>
            `;
            
            tbody.innerHTML = html;
            
            // Update summary cards
            document.getElementById('summaryFloors').innerHTML = `${totalFloors}<span class="summary-card-unit">floors</span>`;
            document.getElementById('summaryHeight').innerHTML = `${Math.round(totalHeight)}<span class="summary-card-unit">ft</span>`;
            document.getElementById('summaryGSF').innerHTML = `${formatNumber(totalGSF)}<span class="summary-card-unit">SF</span>`;
            document.getElementById('summaryRSF').innerHTML = `${formatNumber(totalRSF)}<span class="summary-card-unit">SF</span>`;
            document.getElementById('summaryEfficiency').innerHTML = `${overallEfficiency.toFixed(1)}<span class="summary-card-unit">%</span>`;
            document.getElementById('summaryParking').innerHTML = `${totalParking}<span class="summary-card-unit">cars</span>`;
            
            // Update parking summary
            let requiredParking = 0;
            if (state.parkingMethod === 'beds') {
                requiredParking = Math.round(totalBeds * state.parkingRatio);
            } else if (state.parkingMethod === 'units') {
                requiredParking = Math.round(totalUnits * state.parkingRatio);
            } else {
                requiredParking = state.fixedParking;
            }
            
            const parkingSurplus = totalParking - requiredParking;
            
            document.getElementById('parkingProvided').textContent = totalParking;
            document.getElementById('parkingRequired').textContent = requiredParking;
            
            const surplusEl = document.getElementById('parkingSurplus');
            surplusEl.textContent = parkingSurplus >= 0 ? `+${parkingSurplus}` : parkingSurplus;
            surplusEl.className = `parking-stat-value ${parkingSurplus >= 0 ? 'surplus' : 'deficit'}`;
        }

        function generateAllFloors() {
            const allFloors = [];
            
            state.floorTypes.forEach(ft => {
                const floors = generateFloorRange(ft.startFloor, ft.endFloor, state.skip13);
                floors.forEach(label => {
                    allFloors.push({
                        label: label,
                        typeName: ft.name,
                        use: ft.use,
                        gsf: ft.gsf,
                        height: ft.height,
                        countsInGSF: ft.countsInGSF,
                        actualCars: ft.actualCars,
                        isPLevel: ft.isPLevel,
                        additionalUses: ft.additionalUses ? ft.additionalUses.map(au => ({...au})) : [],
                        sortOrder: parseFloorLabel(label)
                    });
                });
            });
            
            return allFloors;
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================

        function toggleFloorType(index) {
            const wasExpanded = state.floorTypes[index].expanded;
            
            // Collapse all floor types first
            state.floorTypes.forEach((ft, i) => {
                ft.expanded = false;
            });
            
            // If it wasn't expanded, expand it now
            if (!wasExpanded) {
                state.floorTypes[index].expanded = true;
            }
            
            renderFloorTypes();
        }

        function updateFloorTypeField(index, field, value) {
            state.floorTypes[index][field] = value;
            renderFloorTypes();
            updatePreview();
        }

        // Update use type and set GSF default based on use
        function updateFloorTypeUse(index, value) {
            state.floorTypes[index].use = value;
            // Parking and Mechanical default to NOT counting in GSF, all others do
            state.floorTypes[index].countsInGSF = (value !== 'Parking' && value !== 'Mechanical');
            renderFloorTypes();
            updatePreview();
        }

        // Toggle additional use
        function toggleAdditionalUse(floorIndex, useIndex, checked) {
            state.floorTypes[floorIndex].additionalUses[useIndex].enabled = checked;
            if (checked && !state.floorTypes[floorIndex].additionalUses[useIndex].use) {
                state.floorTypes[floorIndex].additionalUses[useIndex].use = 'Residential';
                state.floorTypes[floorIndex].additionalUses[useIndex].countsInGSF = true;
            }
            renderFloorTypes();
            updatePreview();
        }

        // Update additional use type and set GSF default
        function updateAdditionalUseType(floorIndex, useIndex, value) {
            state.floorTypes[floorIndex].additionalUses[useIndex].use = value;
            // Parking and Mechanical default to NOT counting in GSF, all others do
            state.floorTypes[floorIndex].additionalUses[useIndex].countsInGSF = (value !== 'Parking' && value !== 'Mechanical');
            renderFloorTypes();
            updatePreview();
        }

        // Update additional use SF
        function updateAdditionalUseSF(floorIndex, useIndex, value) {
            state.floorTypes[floorIndex].additionalUses[useIndex].sf = parseInt(value) || 0;
            updatePreview();
        }

        // Update additional use GSF checkbox
        function updateAdditionalUseGSF(floorIndex, useIndex, checked) {
            state.floorTypes[floorIndex].additionalUses[useIndex].countsInGSF = checked;
            updatePreview();
        }

        function addFloorType() {
            const newType = {
                name: 'New Floor Type',
                use: 'Residential',
                startFloor: '02',
                endFloor: '10',
                gsf: 10000,
                height: "10' 8\"",
                countsInGSF: true,
                actualCars: null,
                expanded: true,
                isPLevel: false,
                additionalUses: getDefaultAdditionalUses()
            };
            state.floorTypes.push(newType);
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        function deleteFloorType(index) {
            state.floorTypes.splice(index, 1);
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        function updateEfficiencyDisplay() {
            const value = document.getElementById('efficiency').value;
            document.getElementById('efficiencyValue').textContent = value + '%';
            state.efficiency = value / 100;
            updatePreview();
        }

        function updateEfficiencyGoalDisplay() {
            const value = document.getElementById('efficiencyGoal').value;
            document.getElementById('efficiencyGoalValue').textContent = value + '%';
            state.efficiencyGoal = value / 100;
            updatePreview();
        }

        function updateParkingMethod() {
            const method = document.querySelector('input[name="parkingMethod"]:checked').value;
            state.parkingMethod = method;
            
            const ratioGroup = document.getElementById('parkingRatioGroup');
            const fixedGroup = document.getElementById('fixedParkingGroup');
            const ratioLabel = ratioGroup.querySelector('label');
            
            if (method === 'fixed') {
                ratioGroup.classList.add('hidden');
                fixedGroup.classList.remove('hidden');
            } else {
                ratioGroup.classList.remove('hidden');
                fixedGroup.classList.add('hidden');
                ratioLabel.textContent = method === 'beds' ? 'Cars per Bed Ratio' : 'Cars per Unit Ratio';
            }
            
            updatePreview();
        }

        function updatePreview() {
            // Update state from inputs
            state.projectName = document.getElementById('projectName').value;
            state.projectCity = document.getElementById('projectCity').value;
            state.projectNumber = document.getElementById('projectNumber').value;
            state.skip13 = document.getElementById('skip13').checked;
            state.sfPerCar = parseInt(document.getElementById('sfPerCar').value) || 410;
            state.parkingRatio = parseFloat(document.getElementById('parkingRatio').value) || 0.9;
            state.fixedParking = parseInt(document.getElementById('fixedParking').value) || 150;
            
            // Update default heights
            state.defaultHeights = {
                belowGrade: feetInchesToDecimal(document.getElementById('defaultHeightBelowGrade').value),
                ground: feetInchesToDecimal(document.getElementById('defaultHeightGround').value),
                p2: feetInchesToDecimal(document.getElementById('defaultHeightP2').value),
                parking: feetInchesToDecimal(document.getElementById('defaultHeightParking').value),
                residential: feetInchesToDecimal(document.getElementById('defaultHeightResidential').value),
                amenity: feetInchesToDecimal(document.getElementById('defaultHeightAmenity').value),
                penthouse: feetInchesToDecimal(document.getElementById('defaultHeightPenthouse').value),
                mechanical: feetInchesToDecimal(document.getElementById('defaultHeightMechanical').value)
            };
            
            renderPreviewTable();
        }

        function renumberFloors() {
            autoRenumberFloors();
            renderFloorTypes();
            showToast('Floors renumbered!', 'success');
            updatePreview();
        }

        function resetToDefaults() {
            if (!confirm('Are you sure you want to reset all settings? This cannot be undone.')) return;
            
            state = {
                floorTypes: getDefaultFloorTypes(),
                projectName: 'My Residential Tower',
                projectCity: 'Dallas, TX',
                projectNumber: '00000.000',
                efficiency: 0.85,
                efficiencyGoal: 0.80,
                skip13: true,
                sfPerCar: 410,
                parkingMethod: 'beds',
                parkingRatio: 0.9,
                fixedParking: 150,
                defaultHeights: {
                    belowGrade: 10.0,
                    ground: 18.0,
                    p2: 11.0,
                    parking: 9.67,
                    residential: 10.67,
                    amenity: 12.0,
                    penthouse: 11.67,
                    mechanical: 15.0
                }
            };
            
            // Reset form inputs
            document.getElementById('projectName').value = state.projectName;
            document.getElementById('projectCity').value = state.projectCity;
            document.getElementById('projectNumber').value = state.projectNumber;
            document.getElementById('efficiency').value = state.efficiency * 100;
            document.getElementById('efficiencyValue').textContent = Math.round(state.efficiency * 100) + '%';
            document.getElementById('efficiencyGoal').value = state.efficiencyGoal * 100;
            document.getElementById('efficiencyGoalValue').textContent = Math.round(state.efficiencyGoal * 100) + '%';
            document.getElementById('skip13').checked = state.skip13;
            document.getElementById('sfPerCar').value = state.sfPerCar;
            document.getElementById('parkingRatio').value = state.parkingRatio;
            document.getElementById('fixedParking').value = state.fixedParking;
            
            renderFloorTypes();
            updatePreview();
            showToast('Reset to defaults!', 'success');
        }

        function getDefaultFloorTypes() {
            return [
                { name: 'Below Grade Parking', use: 'Parking', startFloor: 'B1', endFloor: 'B1', gsf: 10000, height: "10' 0\"", countsInGSF: false, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Ground Level', use: 'Retail', startFloor: 'G', endFloor: 'G', gsf: 10000, height: "18' 0\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'P02 - Van Accessible', use: 'Parking', startFloor: 'P02', endFloor: 'P02', gsf: 10000, height: "11' 0\"", countsInGSF: false, expanded: false, isPLevel: true, additionalUses: getDefaultAdditionalUses() },
                { name: 'Above Grade Parking', use: 'Parking', startFloor: 'P03', endFloor: 'P03', gsf: 10000, height: "9' 8\"", countsInGSF: false, expanded: false, isPLevel: true, additionalUses: getDefaultAdditionalUses() },
                { name: 'Amenity Level', use: 'Amenity', startFloor: '04', endFloor: '04', gsf: 10000, height: "12' 0\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Tower - Lower Typical', use: 'Residential', startFloor: '05', endFloor: '05', gsf: 10000, height: "10' 8\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Tower - Middle Typical', use: 'Residential', startFloor: '06', endFloor: '06', gsf: 10000, height: "10' 8\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Tower - Upper Typical', use: 'Residential', startFloor: '07', endFloor: '07', gsf: 10000, height: "10' 8\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Penthouse', use: 'Residential', startFloor: '08', endFloor: '08', gsf: 10000, height: "11' 8\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Roof - Mechanical', use: 'Mechanical', startFloor: '09', endFloor: '09', gsf: 10000, height: "15' 0\"", countsInGSF: false, expanded: false, additionalUses: getDefaultAdditionalUses() }
            ];
        }

        function getDefaultAdditionalUses() {
            return [
                { enabled: false, use: 'Residential', sf: 0, countsInGSF: true },
                { enabled: false, use: 'Residential', sf: 0, countsInGSF: true },
                { enabled: false, use: 'Residential', sf: 0, countsInGSF: true },
                { enabled: false, use: 'Residential', sf: 0, countsInGSF: true }
            ];
        }

        // ============================================
        // EXCEL GENERATION
        // ============================================

        async function generateExcel() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Stacking Diagram');
            
            // Define styles
            const headerStyle = {
                font: { bold: true, color: { argb: 'FFFFFFFF' }, size: 11 },
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1A1A1A' } },
                alignment: { horizontal: 'center', vertical: 'middle' },
                border: { bottom: { style: 'thin', color: { argb: 'FF000000' } } }
            };
            
            const totalStyle = {
                font: { bold: true, color: { argb: 'FFFFFFFF' }, size: 11 },
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1A1A1A' } },
                alignment: { vertical: 'middle' }
            };
            
            // Add project header section
            // Row 1: Project Name
            worksheet.mergeCells('A1:T1');
            const titleCell = worksheet.getCell('A1');
            titleCell.value = state.projectName;
            titleCell.font = { bold: true, size: 16 };
            titleCell.alignment = { horizontal: 'left' };
            
            // Row 2: City, State
            worksheet.mergeCells('A2:T2');
            const cityCell = worksheet.getCell('A2');
            cityCell.value = state.projectCity;
            cityCell.font = { size: 12 };
            cityCell.alignment = { horizontal: 'left' };
            
            // Row 3: Project Number
            worksheet.mergeCells('A3:T3');
            const projectNumCell = worksheet.getCell('A3');
            projectNumCell.value = `HKS Project# ${state.projectNumber}`;
            projectNumCell.font = { size: 11 };
            projectNumCell.alignment = { horizontal: 'left' };
            
            // Row 4: Date
            worksheet.mergeCells('A4:T4');
            const dateCell = worksheet.getCell('A4');
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            dateCell.value = dateStr;
            dateCell.font = { size: 11, italic: true };
            dateCell.alignment = { horizontal: 'left' };
            
            // Row 5: Blank
            worksheet.addRow([]);
            
            // Row 6: Column headers
            const headers = [
                'Floor', 'Type', 'Primary Use', 'Height', 'Primary Area',
                'Additional Use 1', 'Additional Use 1 Area',
                'Additional Use 2', 'Additional Use 2 Area',
                'Additional Use 3', 'Additional Use 3 Area',
                'Additional Use 4', 'Additional Use 4 Area',
                'GSF', 'Construction GSF', 'Efficiency', 'RSF', 
                'Parking SF', 'Calc Cars', 'Actual Cars Drawn'
            ];
            worksheet.getRow(6).values = headers;
            worksheet.getRow(6).eachCell((cell) => {
                Object.assign(cell, headerStyle);
            });
            
            // Row 7: Blank row after header
            worksheet.addRow([]);
            
            // Set column widths
            worksheet.columns = [
                { width: 10 },  // Floor
                { width: 25 },  // Type
                { width: 12 },  // Primary Use
                { width: 12 },  // Height
                { width: 14 },  // Primary Area
                { width: 16 },  // Additional Use 1
                { width: 16 },  // Additional Use 1 Area
                { width: 16 },  // Additional Use 2
                { width: 16 },  // Additional Use 2 Area
                { width: 16 },  // Additional Use 3
                { width: 16 },  // Additional Use 3 Area
                { width: 16 },  // Additional Use 4
                { width: 16 },  // Additional Use 4 Area
                { width: 12 },  // GSF
                { width: 14 },  // Construction GSF
                { width: 12 },  // Efficiency
                { width: 12 },  // RSF
                { width: 12 },  // Parking SF
                { width: 12 },  // Calc Cars
                { width: 16 }   // Actual Cars Drawn
            ];
            
            // Generate floor data
            const allFloors = generateAllFloors();
            allFloors.sort((a, b) => b.sortOrder - a.sortOrder);
            
            const firstDataRow = 8; // Row 8 because of header section
            let rowNum = firstDataRow;
            
            // Use color mapping
            const useColors = {
                'Residential': 'FFF0FDF4',
                'Parking': 'FFD1D5DB',      // Darker gray for parking
                'Retail': 'FFEFF6FF',
                'Amenity': 'FFFAF5FF',
                'Mechanical': 'FFFFF7ED',
                'Office': 'FFECFEFF'
            };
            
            // Below grade gets even darker gray
            const belowGradeColor = 'FF9CA3AF';
            
            allFloors.forEach((floor, index) => {
                const height = feetInchesToDecimal(floor.height);
                const efficiency = floor.use === 'Residential' ? state.efficiency : 0;
                
                // Get additional uses data
                const au1 = floor.additionalUses && floor.additionalUses[0] && floor.additionalUses[0].enabled ? floor.additionalUses[0] : null;
                const au2 = floor.additionalUses && floor.additionalUses[1] && floor.additionalUses[1].enabled ? floor.additionalUses[1] : null;
                const au3 = floor.additionalUses && floor.additionalUses[2] && floor.additionalUses[2].enabled ? floor.additionalUses[2] : null;
                const au4 = floor.additionalUses && floor.additionalUses[3] && floor.additionalUses[3].enabled ? floor.additionalUses[3] : null;
                
                // Calculate GSF (only checked items)
                let floorGSF = floor.countsInGSF ? floor.gsf : 0;
                if (au1 && au1.countsInGSF) floorGSF += au1.sf || 0;
                if (au2 && au2.countsInGSF) floorGSF += au2.sf || 0;
                if (au3 && au3.countsInGSF) floorGSF += au3.sf || 0;
                if (au4 && au4.countsInGSF) floorGSF += au4.sf || 0;
                
                // Calculate Construction GSF (ALL items)
                let floorConstructionGSF = floor.gsf;
                if (au1) floorConstructionGSF += au1.sf || 0;
                if (au2) floorConstructionGSF += au2.sf || 0;
                if (au3) floorConstructionGSF += au3.sf || 0;
                if (au4) floorConstructionGSF += au4.sf || 0;
                
                // Calculate parking SF (from primary and additional)
                let parkingSF = 0;
                if (floor.use === 'Parking') parkingSF = floor.gsf;
                if (au1 && au1.use === 'Parking') parkingSF += au1.sf || 0;
                if (au2 && au2.use === 'Parking') parkingSF += au2.sf || 0;
                if (au3 && au3.use === 'Parking') parkingSF += au3.sf || 0;
                if (au4 && au4.use === 'Parking') parkingSF += au4.sf || 0;
                
                const isBelowGrade = floor.label.toUpperCase().startsWith('B');
                
                const row = worksheet.addRow([
                    floor.label,
                    floor.typeName,
                    floor.use,
                    height,
                    floor.gsf,
                    au1 ? au1.use : '',
                    au1 ? (au1.sf || '') : '',
                    au2 ? au2.use : '',
                    au2 ? (au2.sf || '') : '',
                    au3 ? au3.use : '',
                    au3 ? (au3.sf || '') : '',
                    au4 ? au4.use : '',
                    au4 ? (au4.sf || '') : '',
                    '', // GSF - formula
                    '', // Construction GSF - formula
                    floor.use === 'Residential' ? efficiency : '',
                    '', // RSF - formula
                    '', // Parking SF - formula
                    '', // Calc Cars - formula
                    floor.actualCars || ''  // Actual Cars Drawn
                ]);
                
                // Apply row color based on use type (darker for below grade)
                const rowColor = isBelowGrade ? belowGradeColor : (useColors[floor.use] || 'FFFFFFFF');
                row.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: rowColor }
                    };
                });
                
                // Format height as feet-inches (col 4)
                row.getCell(4).numFmt = '0.00" ft"';
                
                // Format Primary Area (col 5)
                row.getCell(5).numFmt = '#,##0';
                
                // Format Additional Use Areas (cols 7, 9, 11, 13)
                row.getCell(7).numFmt = '#,##0';
                row.getCell(9).numFmt = '#,##0';
                row.getCell(11).numFmt = '#,##0';
                row.getCell(13).numFmt = '#,##0';
                
                // GSF Formula (col 14) - sum only checked items
                let gsfFormulaParts = [];
                if (floor.countsInGSF) gsfFormulaParts.push(`E${rowNum}`);
                if (au1 && au1.countsInGSF && au1.sf > 0) gsfFormulaParts.push(`G${rowNum}`);
                if (au2 && au2.countsInGSF && au2.sf > 0) gsfFormulaParts.push(`I${rowNum}`);
                if (au3 && au3.countsInGSF && au3.sf > 0) gsfFormulaParts.push(`K${rowNum}`);
                if (au4 && au4.countsInGSF && au4.sf > 0) gsfFormulaParts.push(`M${rowNum}`);
                if (gsfFormulaParts.length > 0) {
                    row.getCell(14).value = { formula: gsfFormulaParts.join('+') };
                }
                row.getCell(14).numFmt = '#,##0';
                
                // Construction GSF Formula (col 15) - sum ALL area columns
                let constrGsfParts = [`E${rowNum}`];
                if (au1 && au1.sf > 0) constrGsfParts.push(`G${rowNum}`);
                if (au2 && au2.sf > 0) constrGsfParts.push(`I${rowNum}`);
                if (au3 && au3.sf > 0) constrGsfParts.push(`K${rowNum}`);
                if (au4 && au4.sf > 0) constrGsfParts.push(`M${rowNum}`);
                row.getCell(15).value = { formula: constrGsfParts.join('+') };
                row.getCell(15).numFmt = '#,##0';
                
                // Format Efficiency as percentage (col 16)
                if (floor.use === 'Residential') {
                    row.getCell(16).numFmt = '0%';
                }
                
                // RSF Formula (col 17) - sum of all residential areas * efficiency
                let rsfFormulaParts = [];
                if (floor.use === 'Residential' && floor.countsInGSF) {
                    rsfFormulaParts.push(`E${rowNum}`);
                }
                if (au1 && au1.use === 'Residential' && au1.countsInGSF && au1.sf > 0) {
                    rsfFormulaParts.push(`G${rowNum}`);
                }
                if (au2 && au2.use === 'Residential' && au2.countsInGSF && au2.sf > 0) {
                    rsfFormulaParts.push(`I${rowNum}`);
                }
                if (au3 && au3.use === 'Residential' && au3.countsInGSF && au3.sf > 0) {
                    rsfFormulaParts.push(`K${rowNum}`);
                }
                if (au4 && au4.use === 'Residential' && au4.countsInGSF && au4.sf > 0) {
                    rsfFormulaParts.push(`M${rowNum}`);
                }
                if (rsfFormulaParts.length > 0) {
                    row.getCell(17).value = { formula: `(${rsfFormulaParts.join('+')})*P${rowNum}` };
                }
                row.getCell(17).numFmt = '#,##0';
                
                // Parking SF Formula (col 18) - sum of all parking areas
                let parkingFormulaParts = [];
                if (floor.use === 'Parking') parkingFormulaParts.push(`E${rowNum}`);
                if (au1 && au1.use === 'Parking' && au1.sf > 0) parkingFormulaParts.push(`G${rowNum}`);
                if (au2 && au2.use === 'Parking' && au2.sf > 0) parkingFormulaParts.push(`I${rowNum}`);
                if (au3 && au3.use === 'Parking' && au3.sf > 0) parkingFormulaParts.push(`K${rowNum}`);
                if (au4 && au4.use === 'Parking' && au4.sf > 0) parkingFormulaParts.push(`M${rowNum}`);
                if (parkingFormulaParts.length > 0) {
                    row.getCell(18).value = { formula: parkingFormulaParts.join('+') };
                }
                row.getCell(18).numFmt = '#,##0';
                
                // Calc Cars Formula (col 19)
                if (parkingSF > 0) {
                    row.getCell(19).value = { formula: `IF(R${rowNum}>0,INT(R${rowNum}/${state.sfPerCar}),"")` };
                }
                
                rowNum++;
            });
            
            const lastDataRow = rowNum - 1;
            
            // Add blank row before totals
            worksheet.addRow([]);
            rowNum++;
            
            // Add Totals Row
            const totalsRow = worksheet.addRow([
                'TOTALS',
                { formula: `COUNTA(B${firstDataRow}:B${lastDataRow}) & " Floors"` },
                '',
                { formula: `SUM(D${firstDataRow}:D${lastDataRow})` },  // Height
                { formula: `SUM(E${firstDataRow}:E${lastDataRow})` },  // Primary Area
                '',  // Add Use 1
                { formula: `SUM(G${firstDataRow}:G${lastDataRow})` },  // Add Use 1 Area
                '',  // Add Use 2
                { formula: `SUM(I${firstDataRow}:I${lastDataRow})` },  // Add Use 2 Area
                '',  // Add Use 3
                { formula: `SUM(K${firstDataRow}:K${lastDataRow})` },  // Add Use 3 Area
                '',  // Add Use 4
                { formula: `SUM(M${firstDataRow}:M${lastDataRow})` },  // Add Use 4 Area
                { formula: `SUM(N${firstDataRow}:N${lastDataRow})` },  // GSF
                { formula: `SUM(O${firstDataRow}:O${lastDataRow})` },  // Construction GSF
                '',  // Efficiency (not summed)
                { formula: `SUM(Q${firstDataRow}:Q${lastDataRow})` },  // RSF
                { formula: `SUM(R${firstDataRow}:R${lastDataRow})` },  // Parking SF
                { formula: `SUM(S${firstDataRow}:S${lastDataRow})` },  // Calc Cars
                { formula: `SUM(T${firstDataRow}:T${lastDataRow})` }   // Actual Cars Drawn
            ]);
            
            totalsRow.eachCell((cell, colNumber) => {
                Object.assign(cell, totalStyle);
                if (colNumber === 4) cell.numFmt = '0.00" ft"';
                if (colNumber === 5) cell.numFmt = '#,##0';
                if (colNumber === 7) cell.numFmt = '#,##0';
                if (colNumber === 9) cell.numFmt = '#,##0';
                if (colNumber === 11) cell.numFmt = '#,##0';
                if (colNumber === 13) cell.numFmt = '#,##0';
                if (colNumber === 14) cell.numFmt = '#,##0" GSF"';
                if (colNumber === 15) cell.numFmt = '#,##0" SF"';
                if (colNumber === 17) cell.numFmt = '#,##0" RSF"';
                if (colNumber === 18) cell.numFmt = '#,##0" SF"';
                if (colNumber === 19) cell.numFmt = '#,##0" cars"';
                if (colNumber === 20) cell.numFmt = '#,##0" cars"';
            });
            
            const totalsRowNum = rowNum;
            rowNum++;
            
            // Add blank row after totals
            worksheet.addRow([]);
            rowNum++;
            
            // Add Overall Efficiency row
            const effRow = worksheet.addRow(['', '', '', '', '', '', '', '', '', '', '', '', '', 'Overall Efficiency:', { formula: `IF(N${totalsRowNum}>0,Q${totalsRowNum}/N${totalsRowNum},0)` }]);
            effRow.getCell(15).numFmt = '0.0%';
            effRow.getCell(14).font = { bold: true };
            effRow.getCell(15).font = { bold: true };
            rowNum++;
            
            // Add Delta to Goal row - using the efficiency goal from state
            const goalPercent = Math.round(state.efficiencyGoal * 100);
            const deltaRow = worksheet.addRow(['', '', '', '', '', '', '', '', '', '', '', '', '', `Delta to ${goalPercent}%:`, { formula: `Q${totalsRowNum}-(N${totalsRowNum}*${state.efficiencyGoal})` }]);
            deltaRow.getCell(15).numFmt = '#,##0" RSF"';
            deltaRow.getCell(14).font = { bold: true };
            deltaRow.getCell(15).font = { bold: true };
            rowNum += 2;
            
            // Add Parking Summary Section - moved to column B
            const parkingSummaryHeader = worksheet.addRow(['', 'PARKING SUMMARY']);
            parkingSummaryHeader.getCell(2).font = { bold: true, size: 12 };
            worksheet.mergeCells(`B${rowNum}:D${rowNum}`);
            rowNum++;
            
            // Calculate required parking based on method
            let requiredFormula = '';
            if (state.parkingMethod === 'beds') {
                // Estimate beds from RSF (assumption: 1000 SF/unit, 1.8 beds/unit)
                requiredFormula = `ROUND(Q${totalsRowNum}/1000*1.8*${state.parkingRatio},0)`;
            } else if (state.parkingMethod === 'units') {
                requiredFormula = `ROUND(Q${totalsRowNum}/1000*${state.parkingRatio},0)`;
            } else {
                requiredFormula = `${state.fixedParking}`;
            }
            
            // Use Actual Cars total (column T) or Calc Cars (column S) if no actuals
            const providedRow = worksheet.addRow(['', 'Parking Provided:', { formula: `IF(T${totalsRowNum}>0,T${totalsRowNum},S${totalsRowNum})` }]);
            providedRow.getCell(3).numFmt = '#,##0" cars"';
            const providedRowNum = rowNum;
            rowNum++;
            
            const requiredRow = worksheet.addRow(['', 'Parking Required:', { formula: requiredFormula }]);
            requiredRow.getCell(3).numFmt = '#,##0" cars"';
            const requiredRowNum = rowNum;
            rowNum++;
            
            const surplusRow = worksheet.addRow(['', 'Surplus / (Deficit):', { formula: `C${providedRowNum}-C${requiredRowNum}` }]);
            surplusRow.getCell(3).numFmt = '#,##0" cars"';
            surplusRow.getCell(3).font = { bold: true };
            
            // Add assumptions note
            rowNum += 2;
            const notesRow = worksheet.addRow(['', `SF per Car: ${state.sfPerCar} SF | Parking Method: ${state.parkingMethod} | Ratio: ${state.parkingRatio}`]);
            notesRow.getCell(2).font = { italic: true, color: { argb: 'FF666666' } };
            
            // Generate file
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${state.projectName.replace(/[^a-z0-9]/gi, '_')}_Stacking.xlsx`;
            link.click();
            
            window.URL.revokeObjectURL(url);
            showToast('Excel file downloaded!', 'success');
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            state.floorTypes = getDefaultFloorTypes();
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        // Start the app
        init();
    </script>
</body>
</html>
