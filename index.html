<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residential Tower Stacking Tool</title>
    
    <!-- ExcelJS for Excel export with formulas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    
    <!-- Google Fonts - Distinctive architectural feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #f8f7f4;
            --bg-secondary: #ffffff;
            --bg-accent: #1a1a1a;
            --text-primary: #1a1a1a;
            --text-secondary: #5a5a5a;
            --text-light: #ffffff;
            --border-color: #e0ddd8;
            --border-dark: #c0bdb8;
            --accent-blue: #2563eb;
            --accent-green: #059669;
            --accent-orange: #d97706;
            --accent-purple: #7c3aed;
            --accent-red: #dc2626;
            --accent-teal: #0891b2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .header-subtitle {
            font-size: 0.875rem;
            opacity: 0.7;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
            position: sticky;
            top: 80px;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.375rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: inherit;
            background: var(--bg-secondary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group input[type="range"] {
            padding: 0;
            height: 6px;
            -webkit-appearance: none;
            background: var(--border-color);
            border-radius: 3px;
            border: none;
        }

        .form-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
        }

        .range-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-top: 0.25rem;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue);
        }

        .checkbox-group span {
            font-size: 0.875rem;
        }

        /* Radio Group */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .radio-option:hover {
            background: var(--bg-primary);
        }

        .radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-blue);
        }

        .radio-option span {
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-sm {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
        }

        .btn-full {
            width: 100%;
        }

        /* Content Area */
        .content {
            padding: 1.5rem 2rem;
            overflow-y: auto;
        }

        /* Floor Types Section */
        .floor-types-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .floor-types-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .floor-type-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .floor-type-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .floor-type-header:hover {
            background: var(--bg-primary);
        }

        .floor-type-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .floor-type-badge {
            padding: 0.25rem 0.625rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .floor-type-badge.residential { background: #dcfce7; color: #166534; }
        .floor-type-badge.parking { background: #f3f4f6; color: #374151; }
        .floor-type-badge.retail { background: #dbeafe; color: #1e40af; }
        .floor-type-badge.amenity { background: #f3e8ff; color: #6b21a8; }
        .floor-type-badge.mechanical { background: #ffedd5; color: #c2410c; }
        .floor-type-badge.office { background: #cffafe; color: #0e7490; }

        .floor-type-name {
            font-weight: 600;
        }

        .floor-type-range {
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .floor-type-actions {
            display: flex;
            gap: 0.5rem;
        }

        .floor-type-body {
            display: none;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .floor-type-card.expanded .floor-type-body {
            display: block;
        }

        .floor-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .floor-type-grid .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* Preview Table */
        .preview-section {
            margin-top: 2rem;
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .preview-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .preview-table-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .preview-table th {
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 0.5rem 0.5rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .preview-table th.number {
            text-align: right;
        }

        .preview-table td {
            padding: 0.375rem 0.5rem;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .preview-table td.number {
            text-align: right;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
        }

        .preview-table tr:last-child td {
            border-bottom: none;
        }

        .preview-table tr:hover {
            background: var(--bg-primary);
        }

        .preview-table tr.totals {
            background: var(--bg-accent);
            color: var(--text-light);
            font-weight: 600;
        }

        .preview-table tr.totals td {
            border-bottom: none;
        }

        /* Row colors by use type */
        .preview-table tr.use-residential { background: #f0fdf4; }
        .preview-table tr.use-residential.resi-shade-1 { background: #14532d; color: white; }
        .preview-table tr.use-residential.resi-shade-2 { background: #166534; color: white; }
        .preview-table tr.use-residential.resi-shade-3 { background: #15803d; color: white; }
        .preview-table tr.use-residential.resi-shade-4 { background: #16a34a; color: white; }
        .preview-table tr.use-residential.resi-shade-5 { background: #22c55e; }
        .preview-table tr.use-residential.resi-shade-6 { background: #4ade80; }
        .preview-table tr.use-residential.resi-shade-7 { background: #86efac; }
        .preview-table tr.use-residential.resi-shade-8 { background: #bbf7d0; }
        .preview-table tr.use-residential.resi-shade-9 { background: #dcfce7; }
        .preview-table tr.use-residential.resi-shade-10 { background: #f0fdf4; }
        .preview-table tr.use-parking { background: #f9fafb; }
        .preview-table tr.use-parking.below-grade { background: #9ca3af; color: #1f2937; }
        .preview-table tr.use-retail { background: #eff6ff; }
        .preview-table tr.use-amenity { background: #faf5ff; }
        .preview-table tr.use-mechanical { background: #fff7ed; }
        .preview-table tr.use-office { background: #ecfeff; }

        .preview-table tr.use-residential:hover { background: #dcfce7; }
        .preview-table tr.use-residential.resi-shade-1:hover { background: #166534; }
        .preview-table tr.use-residential.resi-shade-2:hover { background: #15803d; }
        .preview-table tr.use-residential.resi-shade-3:hover { background: #16a34a; }
        .preview-table tr.use-residential.resi-shade-4:hover { background: #22c55e; }
        .preview-table tr.use-residential.resi-shade-5:hover { background: #4ade80; }
        .preview-table tr.use-residential.resi-shade-6:hover { background: #86efac; }
        .preview-table tr.use-residential.resi-shade-7:hover { background: #bbf7d0; }
        .preview-table tr.use-residential.resi-shade-8:hover { background: #dcfce7; }
        .preview-table tr.use-residential.resi-shade-9:hover { background: #f0fdf4; }
        .preview-table tr.use-residential.resi-shade-10:hover { background: #f0fdf4; }
        .preview-table tr.use-parking:hover { background: #f3f4f6; }
        .preview-table tr.use-parking.below-grade:hover { background: #6b7280; }
        .preview-table tr.use-retail:hover { background: #dbeafe; }
        .preview-table tr.use-amenity:hover { background: #f3e8ff; }
        .preview-table tr.use-mechanical:hover { background: #ffedd5; }
        .preview-table tr.use-office:hover { background: #cffafe; }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-sm);
        }

        .summary-card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .summary-card-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-card-unit {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-left: 0.25rem;
        }

        /* Parking Summary */
        .parking-summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-top: 1.5rem;
        }

        .parking-summary h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .parking-summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .parking-stat {
            text-align: center;
        }

        .parking-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .parking-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .parking-stat-value.surplus { color: var(--accent-green); }
        .parking-stat-value.deficit { color: var(--accent-red); }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-mono {
            font-family: 'Space Mono', monospace;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .floor-type-card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                top: 0;
                max-height: none;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .floor-type-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Default Heights Table */
        .default-heights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .default-height-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.375rem 0;
            font-size: 0.8125rem;
        }

        .default-height-item label {
            color: var(--text-secondary);
        }

        .default-height-item input {
            width: 70px;
            padding: 0.25rem 0.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            text-align: right;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .toast.success {
            background: var(--accent-green);
        }

        .toast.error {
            background: var(--accent-red);
        }

        /* Drag and Drop Styles */
        .floor-type-card.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }

        .floor-type-card.drag-over {
            border: 2px dashed var(--accent-blue);
            background: rgba(37, 99, 235, 0.05);
        }

        .drag-handle {
            cursor: grab;
            padding: 0.5rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Floor action buttons */
        .floor-inline-actions {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .add-type-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-right: 0.5rem;
        }

        .add-type-label strong {
            color: var(--text-primary);
        }

        .floor-inline-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 3px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .floor-inline-actions button:hover {
            background: var(--bg-primary);
            border-color: var(--border-dark);
        }

        .floor-inline-actions button.add-btn {
            color: var(--accent-green);
        }

        .floor-inline-actions button.add-btn:hover {
            background: #dcfce7;
        }

        .floor-inline-actions button.delete-btn {
            color: var(--accent-red);
        }

        .floor-inline-actions button.delete-btn:hover {
            background: #fee2e2;
        }

        /* Floor count adjuster */
        .floor-count-adjuster {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .floor-count-adjuster button {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .floor-count-adjuster button:hover {
            background: var(--bg-primary);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .floor-count-adjuster .count-display {
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
            min-width: 60px;
            text-align: center;
            padding: 0.375rem 0.5rem;
            background: var(--bg-primary);
            border-radius: 4px;
        }

        /* Info tooltip */
        .info-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--border-color);
            color: var(--text-secondary);
            font-size: 0.625rem;
            font-weight: 700;
            cursor: help;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

        .info-tooltip:hover {
            background: var(--accent-blue);
            color: white;
        }

        .info-tooltip .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 400;
            line-height: 1.5;
            text-align: left;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            transition: opacity 0.2s, visibility 0.2s;
        }

        .info-tooltip .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: var(--bg-accent) transparent transparent transparent;
        }

        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .checkbox-with-info {
            display: flex;
            align-items: center;
        }

        /* Compact sidebar styles */
        .sidebar-section.compact {
            padding: 0.75rem 1rem;
        }

        .sidebar-section.compact h3 {
            margin-bottom: 0.5rem;
        }

        .form-row {
            display: flex;
            gap: 0.5rem;
        }

        .form-group.half {
            flex: 1;
        }
        
        .form-group.quarter {
            flex: 1;
            min-width: 0;
        }
        
        .form-group.quarter input {
            text-align: center;
            padding: 0.5rem 0.25rem;
        }
        
        .form-group.quarter label {
            font-size: 0.75rem;
            text-align: center;
            display: block;
        }
        
        .unit-mix-defaults > label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .mix-total-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8125rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        .mix-total-row span:last-child {
            font-family: 'Space Mono', monospace;
            font-weight: 600;
        }
        
        .mix-total-row span:last-child.warning {
            color: var(--accent-orange);
        }
        
        .mix-total-row span:last-child.error {
            color: var(--accent-red);
        }
        
        /* Unit mix delta display */
        .unit-mix-delta {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        
        .unit-mix-delta > label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .delta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.375rem;
        }
        
        .delta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }
        
        .delta-label {
            color: var(--text-secondary);
        }
        
        .delta-values {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
        }
        
        .delta-value {
            font-weight: 600;
            margin-left: 0.25rem;
        }
        
        .delta-value.positive {
            color: var(--accent-green);
        }
        
        .delta-value.negative {
            color: var(--accent-red);
        }
        
        .delta-value.neutral {
            color: var(--text-secondary);
        }
        
        /* Unit mix in FTC */
        .unit-mix-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border-color);
        }
        
        .unit-mix-section label.section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            display: block;
        }
        
        .unit-mix-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .unit-mix-grid.compact {
            gap: 0.25rem;
        }
        
        .unit-mix-grid.compact input {
            padding: 0.25rem;
            font-size: 0.75rem;
        }
        
        .unit-mix-grid.compact label {
            font-size: 0.65rem;
        }
        
        .unit-mix-grid .form-group {
            margin-bottom: 0;
        }
        
        .unit-mix-grid input {
            text-align: center;
            font-size: 0.8125rem;
        }
        
        .unit-mix-grid label {
            font-size: 0.7rem;
            text-align: center;
        }
        
        .additional-resi-units {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: var(--radius-sm);
            border-left: 2px solid var(--accent-green);
        }
        
        .unit-estimate-inline {
            margin-top: 0.375rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: right;
        }
        
        .unit-estimate {
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
        }
        
        .unit-estimate-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        
        .unit-estimate-row span:last-child {
            font-family: 'Space Mono', monospace;
            font-weight: 500;
        }

        .radio-group.compact {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 0.25rem 0.75rem;
        }

        .radio-group.compact .radio-option {
            padding: 0.25rem 0;
        }

        .radio-group.compact .radio-option span {
            font-size: 0.8rem;
        }

        /* Site data calculations */
        .site-calcs {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .site-calc-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 0.25rem 0;
        }

        .site-calc-row span:first-child {
            color: var(--text-secondary);
        }

        .site-calc-row span:last-child {
            font-weight: 600;
        }

        .delta-value.positive {
            color: #16a34a;
        }

        .delta-value.negative {
            color: #dc2626;
        }

        /* Default heights section */
        .default-heights-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .section-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .default-heights-grid.compact {
            gap: 0.25rem;
        }

        .default-heights-grid.compact .default-height-item {
            padding: 0.25rem;
        }

        .default-heights-grid.compact input {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .default-heights-grid.compact label {
            font-size: 0.7rem;
        }

        /* SF input with inline GSF checkbox */
        .sf-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sf-input-group input[type="number"] {
            flex: 1;
        }

        .checkbox-inline {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            cursor: pointer;
        }

        .checkbox-inline input[type="checkbox"] {
            width: 14px;
            height: 14px;
            margin: 0;
        }

        .checkbox-inline span {
            font-weight: 500;
        }

        /* Additional use row - flexible layout */
        .additional-use-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .additional-use-row.first {
            border-top: 1px dashed var(--border-color);
            padding-top: 0.75rem;
            margin-top: 0.5rem;
        }

        .additional-use-row > .form-group {
            flex: 1;
            margin-bottom: 0;
            min-width: 100px;
        }

        .additional-use-row > .form-group:first-child {
            flex: 0 0 140px;
        }
        
        .additional-use-row > .additional-resi-units {
            flex: 0 0 100%;
        }

        /* Add use row - full width dropdown at bottom */
        .additional-use-add {
            margin-top: 0.5rem;
        }

        .additional-use-add.first {
            border-top: 1px dashed var(--border-color);
            padding-top: 0.75rem;
            margin-top: 0.5rem;
        }

        .additional-use-add .form-group {
            margin-bottom: 0;
        }

        /* Full width add use dropdown */
        .additional-use-add {
            grid-column: 1 / -1;
            margin-bottom: 0.5rem;
        }

        .additional-use-add.first {
            border-top: 1px dashed var(--border-color);
            padding-top: 0.75rem;
            margin-top: 0.5rem;
        }

        .additional-use-add .form-group {
            margin-bottom: 0;
            max-width: 200px;
        }

        /* Compact floor type cards */
        .floor-type-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .floor-type-body {
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: none;
        }

        .floor-type-card.expanded .floor-type-body {
            display: block;
        }

        .floor-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .floor-type-grid .form-group {
            margin-bottom: 0;
        }

        .floor-type-grid .form-group.full-width {
            grid-column: 1 / -1;
        }

        .floor-type-grid label {
            font-size: 0.7rem;
            margin-bottom: 0.15rem;
        }

        .floor-type-grid input,
        .floor-type-grid select {
            padding: 0.35rem 0.5rem;
            font-size: 0.85rem;
        }

        /* Floor count slider */
        .floor-slider {
            width: 100%;
            height: 6px;
            cursor: pointer;
        }

        .count-display.compact {
            padding: 0.35rem 0.5rem;
            font-size: 0.85rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div>
            <h1>Residential Tower Stacking Tool</h1>
            <div class="header-subtitle">Generate Excel stacking diagrams with live formulas</div>
        </div>
        <div class="header-actions">
            <button class="btn btn-success" onclick="generateExcel()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download Excel
            </button>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Project Settings -->
            <div class="sidebar-section">
                <h3>Project Information</h3>
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" value="My Residential Tower" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label for="projectCity">City, State</label>
                    <input type="text" id="projectCity" value="Dallas, TX" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label for="projectNumber">Project Number</label>
                    <input type="text" id="projectNumber" value="00000.000" oninput="updatePreview()">
                </div>
            </div>

            <!-- Building Settings -->
            <div class="sidebar-section">
                <h3>Building Settings</h3>
                <div class="form-group">
                    <label for="efficiency">Typical Floor Residential Efficiency Goal</label>
                    <input type="range" id="efficiency" min="70" max="95" value="85" oninput="updateEfficiencyDisplay()">
                    <div class="range-value" id="efficiencyValue">85%</div>
                </div>
                <div class="form-group">
                    <label for="efficiencyGoal">Overall Efficiency Goal</label>
                    <input type="range" id="efficiencyGoal" min="70" max="95" value="80" oninput="updateEfficiencyGoalDisplay()">
                    <div class="range-value" id="efficiencyGoalValue">80%</div>
                </div>
                <div class="form-group">
                    <div class="checkbox-with-info">
                        <label class="checkbox-group">
                            <input type="checkbox" id="skip13" checked onchange="updatePreview()">
                            <span>Skip Floor 13</span>
                        </label>
                        <div class="info-tooltip">
                            i
                            <div class="tooltip-text">
                                <strong>Triskaidekaphobia</strong> is the fear of the number 13. Many residential buildings skip the 13th floor in their numbering (going directly from 12 to 14) to avoid superstitious concerns from potential residents and to improve marketability. This practice is common in high-rise residential towers.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Default Heights -->
                <div class="default-heights-section">
                    <label class="section-label">Default Heights</label>
                    <div class="default-heights-grid compact">
                        <div class="default-height-item">
                            <label>Below Grade</label>
                            <input type="text" id="defaultHeightBelowGrade" value="10' 0&quot;">
                        </div>
                        <div class="default-height-item">
                            <label>Ground</label>
                            <input type="text" id="defaultHeightGround" value="18' 0&quot;">
                        </div>
                        <div class="default-height-item">
                            <label>P2 (Van)</label>
                            <input type="text" id="defaultHeightP2" value="11' 0&quot;">
                        </div>
                        <div class="default-height-item">
                            <label>P3+ Parking</label>
                            <input type="text" id="defaultHeightParking" value="9' 8&quot;">
                        </div>
                        <div class="default-height-item">
                            <label>Residential</label>
                            <input type="text" id="defaultHeightResidential" value="10' 8&quot;">
                        </div>
                        <div class="default-height-item">
                            <label>Amenity</label>
                            <input type="text" id="defaultHeightAmenity" value="12' 0&quot;">
                        </div>
                        <div class="default-height-item">
                            <label>Penthouse</label>
                            <input type="text" id="defaultHeightPenthouse" value="11' 8&quot;">
                        </div>
                        <div class="default-height-item">
                            <label>Mechanical</label>
                            <input type="text" id="defaultHeightMechanical" value="15' 0&quot;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Site Data -->
            <div class="sidebar-section compact">
                <h3>Site Data</h3>
                <div class="form-row">
                    <div class="form-group half">
                        <label for="siteSF">Site SF</label>
                        <input type="number" id="siteSF" value="50000" min="0" oninput="updateSiteData()">
                    </div>
                    <div class="form-group half">
                        <label for="allowedFAR">Allowed FAR</label>
                        <input type="number" id="allowedFAR" value="5.0" min="0" step="0.1" oninput="updateSiteData()">
                    </div>
                </div>
                <div class="site-calcs">
                    <div class="site-calc-row">
                        <span>Total FAR Available:</span>
                        <span id="totalFARAvailable">250,000 SF</span>
                    </div>
                    <div class="site-calc-row">
                        <span>Delta to FAR:</span>
                        <span id="deltaToFAR" class="delta-value">0 SF</span>
                    </div>
                </div>
            </div>

            <!-- Unit Mix Assumptions -->
            <div class="sidebar-section compact">
                <h3>Unit Mix Assumptions</h3>
                <div class="form-group">
                    <label for="avgUnitSize">Average Unit Size (SF)</label>
                    <input type="number" id="avgUnitSize" value="900" min="100" max="5000" oninput="updateUnitMixSettings()">
                </div>
                <div class="form-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="useGranularSizes" onchange="toggleGranularSizes()">
                        <span>Use sizes by unit type</span>
                    </label>
                </div>
                <div id="granularSizesGroup" class="hidden">
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="studioSize">Studio SF</label>
                            <input type="number" id="studioSize" value="500" min="100" oninput="updateUnitMixSettings()">
                        </div>
                        <div class="form-group half">
                            <label for="oneBRSize">1BR SF</label>
                            <input type="number" id="oneBRSize" value="750" min="100" oninput="updateUnitMixSettings()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="twoBRSize">2BR SF</label>
                            <input type="number" id="twoBRSize" value="1000" min="100" oninput="updateUnitMixSettings()">
                        </div>
                        <div class="form-group half">
                            <label for="penthouseSize">PH SF</label>
                            <input type="number" id="penthouseSize" value="1800" min="100" oninput="updateUnitMixSettings()">
                        </div>
                    </div>
                </div>
                <div class="unit-mix-defaults">
                    <label>Target Unit Mix %</label>
                    <div class="form-row">
                        <div class="form-group quarter">
                            <label for="targetStudio">Studios</label>
                            <input type="number" id="targetStudio" value="3" min="0" max="100" oninput="updateUnitMixSettings()">
                        </div>
                        <div class="form-group quarter">
                            <label for="targetOneBR">1BR</label>
                            <input type="number" id="targetOneBR" value="47" min="0" max="100" oninput="updateUnitMixSettings()">
                        </div>
                        <div class="form-group quarter">
                            <label for="targetTwoBR">2BR</label>
                            <input type="number" id="targetTwoBR" value="47" min="0" max="100" oninput="updateUnitMixSettings()">
                        </div>
                        <div class="form-group quarter">
                            <label for="targetPH">PH</label>
                            <input type="number" id="targetPH" value="3" min="0" max="100" oninput="updateUnitMixSettings()">
                        </div>
                    </div>
                    <div class="mix-total-row">
                        <span>Total:</span>
                        <span id="mixTotalPercent">100%</span>
                    </div>
                </div>
                <div class="unit-mix-delta">
                    <label>Actual vs Target</label>
                    <div class="delta-grid">
                        <div class="delta-item">
                            <span class="delta-label">Studios</span>
                            <span class="delta-values"><span id="actualStudioPct">0%</span> <span id="deltaStudio" class="delta-value">+0%</span></span>
                        </div>
                        <div class="delta-item">
                            <span class="delta-label">1BR</span>
                            <span class="delta-values"><span id="actualOneBRPct">0%</span> <span id="deltaOneBR" class="delta-value">+0%</span></span>
                        </div>
                        <div class="delta-item">
                            <span class="delta-label">2BR</span>
                            <span class="delta-values"><span id="actualTwoBRPct">0%</span> <span id="deltaTwoBR" class="delta-value">+0%</span></span>
                        </div>
                        <div class="delta-item">
                            <span class="delta-label">PH</span>
                            <span class="delta-values"><span id="actualPHPct">0%</span> <span id="deltaPH" class="delta-value">+0%</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parking Calculator -->
            <div class="sidebar-section compact">
                <h3>Parking Calculator</h3>
                <div class="form-row">
                    <div class="form-group half">
                        <label for="sfPerCar">SF per Car</label>
                        <input type="number" id="sfPerCar" value="410" min="100" max="600" oninput="updatePreview()">
                    </div>
                    <div class="form-group half" id="parkingRatioGroup">
                        <label for="parkingRatio">Cars/Bed Ratio</label>
                        <input type="number" id="parkingRatio" value="0.9" min="0.1" max="3" step="0.1" oninput="updatePreview()">
                    </div>
                    <div class="form-group half hidden" id="fixedParkingGroup">
                        <label for="fixedParking">Required Cars</label>
                        <input type="number" id="fixedParking" value="150" min="1" oninput="updatePreview()">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ratio Method</label>
                    <div class="radio-group compact">
                        <label class="radio-option">
                            <input type="radio" name="parkingMethod" value="beds" checked onchange="updateParkingMethod()">
                            <span>per Bed</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="parkingMethod" value="units" onchange="updateParkingMethod()">
                            <span>per Unit</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="parkingMethod" value="fixed" onchange="updateParkingMethod()">
                            <span>Fixed</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="sidebar-section">
                <button class="btn btn-secondary btn-full" onclick="resetToDefaults()">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    Reset &amp; Start Over
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-card-label">Total Floors</div>
                    <div class="summary-card-value" id="summaryFloors">0<span class="summary-card-unit">floors</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total Height</div>
                    <div class="summary-card-value" id="summaryHeight">0<span class="summary-card-unit">ft</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total GSF</div>
                    <div class="summary-card-value" id="summaryGSF">0<span class="summary-card-unit">SF</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total RSF</div>
                    <div class="summary-card-value" id="summaryRSF">0<span class="summary-card-unit">SF</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Efficiency</div>
                    <div class="summary-card-value" id="summaryEfficiency">0<span class="summary-card-unit">%</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total Parking</div>
                    <div class="summary-card-value" id="summaryParking">0<span class="summary-card-unit">cars</span></div>
                </div>
            </div>

            <!-- Floor Types Configuration -->
            <div class="floor-types-header">
                <h2>Floor Type Configuration</h2>
            </div>

            <div id="floorTypesContainer">
                <!-- Floor type cards will be rendered here -->
            </div>

            <button class="btn btn-secondary" onclick="renumberFloors()" style="margin-top: 1rem;">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Renumber Floors
            </button>

            <!-- Preview Table -->
            <div class="preview-section">
                <div class="preview-header">
                    <h2>Building Preview</h2>
                </div>
                
                <div class="preview-table-wrapper">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th class="number">Height</th>
                                <th>Floor</th>
                                <th>Type</th>
                                <th>Use</th>
                                <th class="number">Area</th>
                                <th class="number">GSF</th>
                                <th class="number">Constr.</th>
                                <th class="number">Eff</th>
                                <th class="number">RSF</th>
                                <th class="number">Units</th>
                                <th class="number">S</th>
                                <th class="number">1BR</th>
                                <th class="number">2BR</th>
                                <th class="number">PH</th>
                                <th class="number">Pkg SF</th>
                                <th class="number">Calc</th>
                                <th class="number">Actual</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- Preview rows will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <!-- Parking Summary -->
                <div class="parking-summary">
                    <h3>
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10l-2.5-5c-.3-.6-.9-1-1.5-1h-5c-.6 0-1.2.4-1.5 1L5 10l-2.5 1.1C1.7 11.3 1 12.1 1 13v3c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M5 17H3v-3l2.5-1L8 8h8l2.5 5 2.5 1v3h-2"/></svg>
                        Parking Summary
                    </h3>
                    <div class="parking-summary-grid">
                        <div class="parking-stat">
                            <div class="parking-stat-label">Parking Provided</div>
                            <div class="parking-stat-value" id="parkingProvided">0</div>
                        </div>
                        <div class="parking-stat">
                            <div class="parking-stat-label">Parking Required</div>
                            <div class="parking-stat-value" id="parkingRequired">0</div>
                        </div>
                        <div class="parking-stat">
                            <div class="parking-stat-label">Surplus / (Deficit)</div>
                            <div class="parking-stat-value" id="parkingSurplus">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        let state = {
            floorTypes: [],
            projectName: 'My Residential Tower',
            projectCity: 'Dallas, TX',
            projectNumber: '00000.000',
            efficiency: 0.85,
            efficiencyGoal: 0.80,
            skip13: true,
            siteSF: 50000,
            allowedFAR: 5.0,
            sfPerCar: 410,
            parkingMethod: 'beds',
            parkingRatio: 0.9,
            // Unit Mix Global Defaults
            avgUnitSize: 900,
            useGranularSizes: false,
            unitSizes: { studio: 500, oneBR: 750, twoBR: 1000, penthouse: 1800 },
            targetUnitMix: { studio: 3, oneBR: 47, twoBR: 47, penthouse: 3 },
            fixedParking: 150,
            defaultHeights: {
                belowGrade: 10.0,
                ground: 18.0,
                p2: 11.0,
                parking: 9.67,
                residential: 10.67,
                amenity: 12.0,
                penthouse: 11.67,
                mechanical: 15.0
            }
        };

        const USE_TYPES = ['Residential', 'Parking', 'Retail', 'Amenity', 'Mechanical', 'Office'];

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function feetInchesToDecimal(str) {
            if (!str) return 10.0;
            str = str.toString().trim();
            
            // If already a number
            if (!str.includes("'") && !str.includes('"')) {
                return parseFloat(str) || 10.0;
            }
            
            // Parse feet and inches
            const match = str.match(/(\d+)'?\s*(\d+)?/);
            if (match) {
                const feet = parseInt(match[1]) || 0;
                const inches = parseInt(match[2]) || 0;
                return feet + (inches / 12);
            }
            return 10.0;
        }

        function decimalToFeetInches(decimal) {
            const feet = Math.floor(decimal);
            const inches = Math.round((decimal - feet) * 12);
            return `${feet}' ${inches}"`;
        }

        function parseFloorLabel(label) {
            label = String(label).trim().toUpperCase();
            
            // Plenum
            if (label.includes('PLENUM')) {
                const baseLabel = label.replace('PLENUM', '').trim();
                return parseFloorLabel(baseLabel) - 0.5;
            }
            
            // Below grade (B1, B2, etc) - negative numbers
            if (label.startsWith('B')) {
                const nums = label.match(/\d+/);
                if (nums) return -1000 - parseInt(nums[0]);
                return -1000;
            }
            
            // Parking levels (P2, P3, etc) - these ARE part of floor sequence
            // P2 = floor 2, P3 = floor 3, etc.
            if (label.startsWith('P')) {
                const nums = label.match(/\d+/);
                if (nums) return parseInt(nums[0]);
                return 2;
            }
            
            // Ground floor = floor 1
            if (['G', 'GROUND', 'GF'].includes(label)) {
                return 1;
            }
            
            // Numbered floors
            const nums = label.match(/\d+/);
            if (nums) return parseInt(nums[0]);
            
            return 1;
        }

        // Format floor number with leading zero
        function formatFloorNumber(num) {
            if (num < 10 && num > 0) {
                return '0' + num;
            }
            return String(num);
        }

        // Format P-level with leading zero
        function formatPLevel(num) {
            if (num < 10 && num > 0) {
                return 'P0' + num;
            }
            return 'P' + num;
        }

        // Format B-level with leading zero
        function formatBLevel(num) {
            if (num < 10 && num > 0) {
                return 'B0' + num;
            }
            return 'B' + num;
        }

        function generateFloorRange(start, end, skip13 = false) {
            const startNum = parseFloorLabel(start);
            const endNum = parseFloorLabel(end);
            const floors = [];
            
            const isPRange = String(start).toUpperCase().startsWith('P') || String(end).toUpperCase().startsWith('P');
            
            // Below grade range (B01 -> B03, shallow to deep)
            if (startNum < 0 && endNum < 0) {
                const startB = Math.abs(startNum + 1000);
                const endB = Math.abs(endNum + 1000);
                for (let i = Math.min(startB, endB); i <= Math.max(startB, endB); i++) {
                    floors.push(formatBLevel(i));
                }
            }
            // P-levels (parking above grade, part of floor sequence)
            else if (isPRange) {
                const startP = parseInt(String(start).match(/\d+/)?.[0]) || 2;
                const endP = parseInt(String(end).match(/\d+/)?.[0]) || 2;
                for (let i = startP; i <= endP; i++) {
                    if (skip13 && i === 13) continue;
                    floors.push(formatPLevel(i));
                }
            }
            // Mixed range (below grade to above grade)
            else if (startNum <= 0 && endNum >= 0) {
                // Below grade portion
                if (startNum < 0) {
                    const startB = Math.abs(startNum + 1000);
                    for (let i = 1; i <= startB; i++) {
                        floors.push(formatBLevel(i));
                    }
                }
                // Ground
                floors.push('G');
                // Above grade
                for (let i = 2; i <= endNum; i++) {
                    if (skip13 && i === 13) continue;
                    floors.push(formatFloorNumber(i));
                }
            }
            // Above grade only
            else {
                const minNum = Math.min(startNum, endNum);
                const maxNum = Math.max(startNum, endNum);
                for (let i = minNum; i <= maxNum; i++) {
                    if (skip13 && i === 13) continue;
                    if (i === 1) {
                        floors.push('G');
                    } else {
                        floors.push(formatFloorNumber(i));
                    }
                }
            }
            
            return floors;
        }

        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        // ============================================
        // UI RENDERING
        // ============================================

        function renderFloorTypes() {
            const container = document.getElementById('floorTypesContainer');
            container.innerHTML = '';
            
            // Create a sorted copy for display (roof at top, basement at bottom)
            const sortedIndices = state.floorTypes.map((ft, idx) => ({
                idx,
                sortOrder: parseFloorLabel(ft.startFloor)
            })).sort((a, b) => b.sortOrder - a.sortOrder);
            
            sortedIndices.forEach(({idx: index}, displayIndex) => {
                const ft = state.floorTypes[index];
                const floorCount = countFloorsInRange(ft.startFloor, ft.endFloor);
                
                const card = document.createElement('div');
                card.className = `floor-type-card ${ft.expanded ? 'expanded' : ''}`;
                card.dataset.index = index;
                card.dataset.displayIndex = displayIndex;
                
                // Drop target events on the card
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragleave', handleDragLeave);
                
                // Build additional uses badges for header
                const additionalBadges = ft.additionalUses ? ft.additionalUses
                    .filter(au => au.enabled && au.use)
                    .map(au => `<span class="floor-type-badge ${au.use.toLowerCase()}" style="opacity: 0.7; font-size: 0.65rem;">+${au.use}</span>`)
                    .join('') : '';
                
                // Build additional uses HTML - use+area side by side, add dropdown always at bottom
                let additionalUsesHTML = '';
                if (ft.additionalUses) {
                    // First show all enabled uses with their areas side by side
                    for (let i = 0; i < 4; i++) {
                        const au = ft.additionalUses[i] || { enabled: false, use: '', sf: 0, countsInGSF: true };
                        
                        if (au.enabled && au.use) {
                            // For Residential additional uses, add unit count section
                            let resiUnitsHTML = '';
                            if (au.use === 'Residential') {
                                const auRSF = Math.round((au.sf || 0) * state.efficiency);
                                const auUnitCounts = au.unitCounts || calculateDefaultUnitCounts(auRSF, false);
                                const auTotalUnits = auUnitCounts.studio + auUnitCounts.oneBR + auUnitCounts.twoBR + auUnitCounts.penthouse;
                                resiUnitsHTML = `
                                <div class="additional-resi-units">
                                    <div class="unit-mix-grid compact">
                                        <div class="form-group">
                                            <label>S</label>
                                            <input type="number" value="${auUnitCounts.studio}" min="0" 
                                                onchange="updateAdditionalUseUnitCount(${index}, ${i}, 'studio', parseInt(this.value) || 0)">
                                        </div>
                                        <div class="form-group">
                                            <label>1BR</label>
                                            <input type="number" value="${auUnitCounts.oneBR}" min="0"
                                                onchange="updateAdditionalUseUnitCount(${index}, ${i}, 'oneBR', parseInt(this.value) || 0)">
                                        </div>
                                        <div class="form-group">
                                            <label>2BR</label>
                                            <input type="number" value="${auUnitCounts.twoBR}" min="0"
                                                onchange="updateAdditionalUseUnitCount(${index}, ${i}, 'twoBR', parseInt(this.value) || 0)">
                                        </div>
                                        <div class="form-group">
                                            <label>PH</label>
                                            <input type="number" value="${auUnitCounts.penthouse}" min="0"
                                                onchange="updateAdditionalUseUnitCount(${index}, ${i}, 'penthouse', parseInt(this.value) || 0)">
                                        </div>
                                    </div>
                                    <div class="unit-estimate-inline">${auTotalUnits} units/floor</div>
                                </div>
                                `;
                            }
                            
                            additionalUsesHTML += `
                            <div class="additional-use-row${i === 0 ? ' first' : ''}">
                                <div class="form-group">
                                    <label>Use</label>
                                    <select onchange="selectAdditionalUse(${index}, ${i}, this.value)">
                                        <option value=""> Remove </option>
                                        ${USE_TYPES.map(u => `<option value="${u}" ${au.use === u ? 'selected' : ''}>${u}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Area</label>
                                    <div class="sf-input-group">
                                        <input type="number" value="${au.sf || ''}" placeholder="0" onchange="updateAdditionalUseSF(${index}, ${i}, this.value)">
                                        <label class="checkbox-inline">
                                            <input type="checkbox" ${au.countsInGSF ? 'checked' : ''} onchange="updateAdditionalUseGSF(${index}, ${i}, this.checked)">
                                            <span>GSF</span>
                                        </label>
                                    </div>
                                </div>
                                ${resiUnitsHTML}
                            </div>
                            `;
                        }
                    }
                    
                    // Then show one "Add Use" dropdown at the bottom if there's room
                    const enabledCount = ft.additionalUses.filter(au => au.enabled && au.use).length;
                    if (enabledCount < 4) {
                        additionalUsesHTML += `
                        <div class="additional-use-add${enabledCount === 0 ? ' first' : ''}">
                            <div class="form-group">
                                <label>Additional Use</label>
                                <select onchange="selectAdditionalUse(${index}, ${enabledCount}, this.value)">
                                    <option value=""> Add Use </option>
                                    ${USE_TYPES.map(u => `<option value="${u}">${u}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        `;
                    }
                }
                
                card.innerHTML = `
                    <div class="floor-type-header" onclick="toggleFloorType(${index})">
                        <div class="floor-type-info">
                            <div class="drag-handle" draggable="true" data-display-index="${displayIndex}" title="Drag to reorder">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/>
                                    <circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/>
                                </svg>
                            </div>
                            <span class="floor-type-badge ${ft.use.toLowerCase()}">${ft.use}</span>
                            ${additionalBadges}
                            <span class="floor-type-name">${ft.name}</span>
                            <span class="floor-type-range">${ft.startFloor}  ${ft.endFloor} (${floorCount} floor${floorCount !== 1 ? 's' : ''})</span>
                        </div>
                        <div class="floor-inline-actions" onclick="event.stopPropagation()">
                            <span class="add-type-label">Add <strong>TYPE</strong></span>
                            <button class="add-btn" onclick="addFloorTypeAt(${index}, 'above')" title="Add floor type above">+ Above</button>
                            <button class="add-btn" onclick="addFloorTypeAt(${index}, 'below')" title="Add floor type below">+ Below</button>
                            <button class="delete-btn" onclick="deleteFloorType(${index})" title="Delete"></button>
                        </div>
                    </div>
                    <div class="floor-type-body">
                        <div class="floor-type-grid">
                            <div class="form-group">
                                <label>Use</label>
                                <select onchange="updateFloorTypeUse(${index}, this.value)">
                                    ${USE_TYPES.map(u => `<option value="${u}" ${ft.use === u ? 'selected' : ''}>${u}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" value="${ft.name}" onchange="updateFloorTypeField(${index}, 'name', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Number of Floors: ${floorCount}</label>
                                <input type="range" min="1" max="20" value="${floorCount}" class="floor-slider" onchange="setFloorCount(${index}, parseInt(this.value))" oninput="this.previousElementSibling.textContent = 'Number of Floors: ' + this.value">
                            </div>
                            <div class="form-group">
                                <label>Floor Range</label>
                                <div class="count-display compact">${ft.startFloor}  ${ft.endFloor}</div>
                            </div>
                            <div class="form-group">
                                <label>Area per Floor</label>
                                <div class="sf-input-group">
                                    <input type="number" value="${ft.gsf}" onchange="updateFloorTypeField(${index}, 'gsf', parseInt(this.value))">
                                    <label class="checkbox-inline">
                                        <input type="checkbox" ${ft.countsInGSF ? 'checked' : ''} onchange="updateFloorTypeField(${index}, 'countsInGSF', this.checked)">
                                        <span>GSF</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Floor Height</label>
                                <input type="text" value="${ft.height}" onchange="updateFloorTypeField(${index}, 'height', this.value)">
                            </div>
                            
                            ${ft.use === 'Parking' ? `
                            <div class="form-group">
                                <label>Actual Cars Drawn</label>
                                <input type="number" value="${ft.actualCars || ''}" placeholder="# As Drawn (overrides calculated)" onchange="updateFloorTypeField(${index}, 'actualCars', parseInt(this.value) || null)">
                            </div>
                            ` : ''}
                            
                            ${ft.use === 'Amenity' ? `
                            <div class="form-group">
                                <label>Outdoor Deck SF</label>
                                <input type="number" value="${ft.deckSF || ''}" placeholder="Deck SF (Construction GSF only)" onchange="updateFloorTypeField(${index}, 'deckSF', parseInt(this.value) || 0)">
                            </div>
                            ` : ''}
                            
                            ${ft.use === 'Residential' ? (() => {
                                const isPH = ft.name.toLowerCase().includes('penthouse') || ft.name.toLowerCase().includes('ph');
                                const rsf = Math.round(ft.gsf * state.efficiency);
                                // Get unit counts per floor (or calculate defaults if not set)
                                const unitCounts = ft.unitCounts || calculateDefaultUnitCounts(rsf, isPH);
                                const totalUnits = unitCounts.studio + unitCounts.oneBR + unitCounts.twoBR + unitCounts.penthouse;
                                return `
                                <div class="unit-mix-section">
                                    <label class="section-label">Units per Floor ${isPH ? '(Penthouse)' : ''}</label>
                                    <div class="unit-mix-grid">
                                        <div class="form-group">
                                            <label>Studios</label>
                                            <input type="number" value="${unitCounts.studio}" min="0" 
                                                onchange="updateFloorTypeUnitCount(${index}, 'studio', parseInt(this.value) || 0)">
                                        </div>
                                        <div class="form-group">
                                            <label>1BR</label>
                                            <input type="number" value="${unitCounts.oneBR}" min="0"
                                                onchange="updateFloorTypeUnitCount(${index}, 'oneBR', parseInt(this.value) || 0)">
                                        </div>
                                        <div class="form-group">
                                            <label>2BR</label>
                                            <input type="number" value="${unitCounts.twoBR}" min="0"
                                                onchange="updateFloorTypeUnitCount(${index}, 'twoBR', parseInt(this.value) || 0)">
                                        </div>
                                        <div class="form-group">
                                            <label>PH</label>
                                            <input type="number" value="${unitCounts.penthouse}" min="0"
                                                onchange="updateFloorTypeUnitCount(${index}, 'penthouse', parseInt(this.value) || 0)">
                                        </div>
                                    </div>
                                    <div class="unit-estimate">
                                        <div class="unit-estimate-row">
                                            <span>Total per floor:</span>
                                            <span>${totalUnits} units</span>
                                        </div>
                                        <div class="unit-estimate-row" style="font-size: 0.75rem; color: var(--text-secondary);">
                                            <span> ${floorCount} floors = ${totalUnits * floorCount} units total</span>
                                        </div>
                                    </div>
                                </div>
                                `;
                            })() : ''}
                            
                            ${additionalUsesHTML}
                        </div>
                    </div>
                `;
                
                // Add drag events to the drag handle
                const dragHandle = card.querySelector('.drag-handle');
                dragHandle.addEventListener('dragstart', function(e) {
                    e.stopPropagation();
                    draggedItem = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', this.dataset.displayIndex);
                });
                dragHandle.addEventListener('dragend', function(e) {
                    card.classList.remove('dragging');
                    document.querySelectorAll('.floor-type-card').forEach(c => {
                        c.classList.remove('drag-over');
                    });
                });
                
                container.appendChild(card);
            });
        }

        // Count floors in a range
        function countFloorsInRange(start, end) {
            const floors = generateFloorRange(start, end, state.skip13);
            return floors.length;
        }

        // Adjust floor count (add/remove floors from range)
        function adjustFloorCount(index, delta) {
            const ft = state.floorTypes[index];
            const startNum = parseFloorLabel(ft.startFloor);
            const endNum = parseFloorLabel(ft.endFloor);
            
            // Determine the direction of the range
            const isBelowGrade = ft.startFloor.toUpperCase().startsWith('B');
            const isPLevel = ft.isPLevel || ft.startFloor.toUpperCase().startsWith('P');
            const isGround = ['G', 'GROUND', 'GF'].includes(ft.startFloor.toUpperCase());
            
            if (isGround) {
                // Single ground floor - can't adjust
                return;
            }
            
            if (isBelowGrade) {
                // For B levels: B01 to B03 means going deeper
                const startB = parseInt(ft.startFloor.match(/\d+/)?.[0]) || 1;
                const endB = parseInt(ft.endFloor.match(/\d+/)?.[0]) || 1;
                const newEndB = Math.max(startB, endB + delta);
                ft.endFloor = formatBLevel(newEndB);
            } else if (isPLevel) {
                // P-levels are part of sequence - adjust end floor
                const startP = parseInt(ft.startFloor.match(/\d+/)?.[0]) || 2;
                const endP = parseInt(ft.endFloor.match(/\d+/)?.[0]) || 2;
                let newEndP = Math.max(startP, endP + delta);
                
                // Skip 13 if needed
                if (state.skip13 && newEndP === 13) {
                    newEndP = delta > 0 ? 14 : 12;
                }
                
                ft.endFloor = formatPLevel(newEndP);
            } else {
                // Regular numbered floors
                const endFloorNum = parseInt(ft.endFloor.match(/\d+/)?.[0]) || 2;
                const startFloorNum = parseInt(ft.startFloor.match(/\d+/)?.[0]) || 2;
                let newEndNum = endFloorNum + delta;
                
                // Don't go below start
                if (newEndNum < startFloorNum) newEndNum = startFloorNum;
                
                // Skip 13 if needed
                if (state.skip13 && newEndNum === 13) {
                    newEndNum = delta > 0 ? 14 : 12;
                }
                
                ft.endFloor = formatFloorNumber(newEndNum);
            }
            
            // Re-sort and renumber all floors after this one
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        // Set floor count directly (from slider)
        function setFloorCount(index, newCount) {
            const ft = state.floorTypes[index];
            const isBelowGrade = ft.startFloor.toUpperCase().startsWith('B');
            const isPLevel = ft.isPLevel || ft.startFloor.toUpperCase().startsWith('P');
            const isGround = ['G', 'GROUND', 'GF'].includes(ft.startFloor.toUpperCase());
            
            if (isGround || newCount < 1) return;
            
            if (isBelowGrade) {
                const startB = parseInt(ft.startFloor.match(/\d+/)?.[0]) || 1;
                ft.endFloor = formatBLevel(startB + newCount - 1);
            } else if (isPLevel) {
                const startP = parseInt(ft.startFloor.match(/\d+/)?.[0]) || 2;
                let newEndP = startP + newCount - 1;
                if (state.skip13 && startP <= 13 && newEndP >= 13) newEndP++;
                ft.endFloor = formatPLevel(newEndP);
            } else {
                const startFloorNum = parseInt(ft.startFloor.match(/\d+/)?.[0]) || 2;
                let newEndNum = startFloorNum + newCount - 1;
                if (state.skip13 && startFloorNum <= 13 && newEndNum >= 13) newEndNum++;
                ft.endFloor = formatFloorNumber(newEndNum);
            }
            
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        // Drag and Drop handlers
        let draggedItem = null;
        let draggedFromDisplayIndex = null;

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const fromDisplayIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toDisplayIndex = parseInt(this.dataset.displayIndex);
            
            if (fromDisplayIndex !== toDisplayIndex && !isNaN(fromDisplayIndex) && !isNaN(toDisplayIndex)) {
                // Get the current display order (sorted by floor level, roof to basement)
                // This gives us an array where index 0 = top of building (highest floor)
                const sortedTypes = state.floorTypes
                    .map((ft, idx) => ({ ft, idx, sortOrder: parseFloorLabel(ft.startFloor) }))
                    .sort((a, b) => b.sortOrder - a.sortOrder);
                
                // Create new array in the desired order
                const displayOrder = sortedTypes.map(item => item.ft);
                
                // Remove from old display position and insert at new display position
                // Handle the case where removing shifts indices
                const [movedItem] = displayOrder.splice(fromDisplayIndex, 1);
                
                // Adjust toDisplayIndex if we removed from before it
                let adjustedToIndex = toDisplayIndex;
                if (fromDisplayIndex < toDisplayIndex) {
                    adjustedToIndex = toDisplayIndex - 1;
                }
                
                displayOrder.splice(adjustedToIndex, 0, movedItem);
                
                // Reverse to get array order (basement first, roof last)
                state.floorTypes = displayOrder.reverse();
                
                // Renumber based on new array order
                renumberFloorsInPlace();
                renderFloorTypes();
                updatePreview();
                showToast('Floor type moved!', 'success');
            }
        }

        // Add floor type at specific position (copies from reference floor type)
        function addFloorTypeAt(index, position) {
            const referenceType = state.floorTypes[index];
            
            // Prompt user for the new floor type name
            const defaultName = referenceType.name + ' (Copy)';
            const newName = prompt('Enter name for the new floor type:', defaultName);
            
            // If user cancels, abort
            if (newName === null) return;
            
            // Create a copy of the reference floor type
            let newType = {
                name: newName || defaultName,
                use: referenceType.use,
                startFloor: referenceType.startFloor,
                endFloor: referenceType.startFloor, // Start with single floor
                gsf: referenceType.gsf,
                height: referenceType.height,
                countsInGSF: referenceType.countsInGSF,
                actualCars: referenceType.actualCars,
                expanded: true,
                isPLevel: referenceType.isPLevel,
                additionalUses: referenceType.additionalUses ? 
                    referenceType.additionalUses.map(au => ({...au})) : 
                    getDefaultAdditionalUses()
            };
            
            // Insert at the correct position
            if (position === 'above') {
                state.floorTypes.splice(index + 1, 0, newType);
            } else {
                state.floorTypes.splice(index, 0, newType);
            }
            
            // Auto-renumber
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        // Auto-renumber all floors based on order (sorts array first)
        function autoRenumberFloors() {
            // Sort by current start floor to maintain relative order
            state.floorTypes.sort((a, b) => {
                return parseFloorLabel(a.startFloor) - parseFloorLabel(b.startFloor);
            });
            
            // Then renumber in place
            renumberFloorsInPlace();
        }
        
        // Renumber floors based on current array order (does NOT sort)
        function renumberFloorsInPlace() {
            let currentFloor = 2; // Start after ground (floor 1)
            let currentBasement = 1; // Start B01
            
            // Process in array order (which should be basement-to-roof after drag)
            state.floorTypes.forEach((ft) => {
                const isBelowGrade = ft.startFloor.toUpperCase().startsWith('B');
                const isPLevel = ft.isPLevel || ft.startFloor.toUpperCase().startsWith('P');
                const isGround = ['G', 'GROUND', 'GF'].includes(ft.startFloor.toUpperCase());
                
                // Handle basement floors
                if (isBelowGrade) {
                    const floorCount = countFloorsInRange(ft.startFloor, ft.endFloor);
                    ft.startFloor = formatBLevel(currentBasement);
                    ft.endFloor = formatBLevel(currentBasement + floorCount - 1);
                    currentBasement = currentBasement + floorCount;
                    return;
                }
                
                // Ground floor is always G
                if (isGround) {
                    ft.startFloor = 'G';
                    ft.endFloor = 'G';
                    return;
                }
                
                const floorCount = countFloorsInRange(ft.startFloor, ft.endFloor);
                let newStart = currentFloor;
                let newEnd = currentFloor + floorCount - 1;
                
                // Handle skip 13
                if (state.skip13) {
                    // Check if range crosses 13
                    if (newStart <= 13 && newEnd >= 13) {
                        newEnd++;
                    }
                    if (newStart === 13) {
                        newStart = 14;
                        newEnd = newStart + floorCount - 1;
                    }
                }
                
                // P-levels keep their P prefix but use sequential numbers
                if (isPLevel) {
                    ft.startFloor = formatPLevel(newStart);
                    ft.endFloor = formatPLevel(newEnd);
                    ft.isPLevel = true;
                } else {
                    ft.startFloor = formatFloorNumber(newStart);
                    ft.endFloor = formatFloorNumber(newEnd);
                }
                
                currentFloor = newEnd + 1;
                if (state.skip13 && currentFloor === 13) {
                    currentFloor = 14;
                }
            });
        }

        function renderPreviewTable() {
            const tbody = document.getElementById('previewTableBody');
            const allFloors = generateAllFloors();
            
            // Sort floors from top to bottom (roof to basement)
            allFloors.sort((a, b) => b.sortOrder - a.sortOrder);
            
            // Get unique residential floor TYPES in order (top to bottom)
            const resiFloorTypes = [];
            allFloors.forEach(f => {
                if (f.use === 'Residential' && !resiFloorTypes.includes(f.typeName)) {
                    resiFloorTypes.push(f.typeName);
                }
            });
            
            // Create shade map by floor type name (1 = darkest/lowest type, up to 10)
            const resiTypeShadeMap = {};
            const typeCount = resiFloorTypes.length;
            resiFloorTypes.forEach((typeName, idx) => {
                // idx 0 = top type (lightest), last = bottom type (darkest)
                const position = typeCount - idx; // 1 = bottom type, typeCount = top type
                const shade = Math.min(10, Math.max(1, Math.ceil(position / typeCount * 10)));
                resiTypeShadeMap[typeName] = shade;
            });
            
            let totalFloors = 0;
            let totalHeight = 0;
            let totalGSF = 0;
            let totalConstructionGSF = 0;
            let totalRSF = 0;
            let totalParking = 0;
            let totalParkingSF = 0;
            let totalBeds = 0;
            let totalUnits = 0;
            let totalStudios = 0;
            let totalOneBR = 0;
            let totalTwoBR = 0;
            let totalPH = 0;
            let totalCalcCars = 0;
            let totalActualCars = 0;
            
            let html = '';
            
            allFloors.forEach(floor => {
                const height = feetInchesToDecimal(floor.height);
                const efficiency = floor.use === 'Residential' ? state.efficiency : 0;
                
                // Calculate GSF (only checked items)
                let floorGSF = 0;
                if (floor.countsInGSF) {
                    floorGSF += floor.gsf;
                }
                
                // Calculate Construction GSF (ALL items)
                let floorConstructionGSF = floor.gsf;
                
                // Calculate primary RSF (only for Residential with GSF checked)
                let primaryRSF = 0;
                if (floor.use === 'Residential' && floor.countsInGSF) {
                    primaryRSF = Math.round(floor.gsf * efficiency);
                }
                
                // Add deck SF for amenity floors (Construction GSF only)
                const ft = state.floorTypes.find(f => f.name === floor.typeName);
                if (ft && ft.deckSF > 0) {
                    floorConstructionGSF += ft.deckSF;
                }
                
                // Calculate RSF and GSF from additional uses
                let additionalRSF = 0;
                if (floor.additionalUses) {
                    floor.additionalUses.forEach(au => {
                        if (au.enabled && au.sf > 0) {
                            // Add to Construction GSF (all items)
                            floorConstructionGSF += au.sf;
                            
                            // Add to GSF only if checked
                            if (au.countsInGSF) {
                                floorGSF += au.sf;
                            }
                            
                            // Add RSF if Residential and GSF is checked
                            if (au.use === 'Residential' && au.countsInGSF) {
                                additionalRSF += Math.round(au.sf * efficiency);
                            }
                        }
                    });
                }
                
                const totalRSFForFloor = primaryRSF + additionalRSF;
                
                // Parking calculations - primary and additional uses
                let parkingSF = 0;
                if (floor.use === 'Parking') {
                    parkingSF = floor.gsf;
                }
                if (floor.additionalUses) {
                    floor.additionalUses.forEach(au => {
                        if (au.enabled && au.use === 'Parking' && au.sf > 0) {
                            parkingSF += au.sf;
                        }
                    });
                }
                
                const calcCars = parkingSF > 0 ? Math.floor(parkingSF / state.sfPerCar) : 0;
                const actualCars = floor.actualCars || 0;
                
                // Get unit counts for this floor from floor type (primary use)
                let floorUnits = { studio: 0, oneBR: 0, twoBR: 0, penthouse: 0 };
                if (ft && ft.use === 'Residential') {
                    floorUnits = getFloorTypeUnitCounts(ft);
                }
                
                // Add unit counts from Residential additional uses
                if (floor.additionalUses) {
                    floor.additionalUses.forEach(au => {
                        if (au.enabled && au.use === 'Residential' && au.unitCounts) {
                            floorUnits.studio += au.unitCounts.studio || 0;
                            floorUnits.oneBR += au.unitCounts.oneBR || 0;
                            floorUnits.twoBR += au.unitCounts.twoBR || 0;
                            floorUnits.penthouse += au.unitCounts.penthouse || 0;
                        }
                    });
                }
                const floorUnitTotal = floorUnits.studio + floorUnits.oneBR + floorUnits.twoBR + floorUnits.penthouse;
                
                // Always count the floor
                totalFloors++;
                totalHeight += height;
                
                // Totals
                totalGSF += floorGSF;
                totalConstructionGSF += floorConstructionGSF;
                totalRSF += totalRSFForFloor;
                totalCalcCars += calcCars;
                totalActualCars += actualCars;
                totalParking += actualCars > 0 ? actualCars : calcCars;
                totalParkingSF += parkingSF;
                
                // Accumulate unit counts
                totalUnits += floorUnitTotal;
                totalStudios = (totalStudios || 0) + floorUnits.studio;
                totalOneBR = (totalOneBR || 0) + floorUnits.oneBR;
                totalTwoBR = (totalTwoBR || 0) + floorUnits.twoBR;
                totalPH = (totalPH || 0) + floorUnits.penthouse;
                
                // Estimate beds for parking calculation (Studios=1, 1BR=1, 2BR=2, PH=3)
                const bedsOnFloor = floorUnits.studio + floorUnits.oneBR + (floorUnits.twoBR * 2) + (floorUnits.penthouse * 3);
                totalBeds += bedsOnFloor;
                
                const isBelowGrade = floor.label.toUpperCase().startsWith('B');
                const resiShade = floor.use === 'Residential' && resiTypeShadeMap[floor.typeName] ? ` resi-shade-${resiTypeShadeMap[floor.typeName]}` : '';
                const rowClasses = `use-${floor.use.toLowerCase()}${isBelowGrade ? ' below-grade' : ''}${resiShade}`;
                
                html += `
                    <tr class="${rowClasses}">
                        <td class="number">${decimalToFeetInches(height)}</td>
                        <td class="text-mono">${floor.label}</td>
                        <td>${floor.typeName}</td>
                        <td>${floor.use}</td>
                        <td class="number">${formatNumber(floor.gsf)}</td>
                        <td class="number">${floorGSF > 0 ? formatNumber(floorGSF) : '-'}</td>
                        <td class="number">${formatNumber(floorConstructionGSF)}</td>
                        <td class="number">${floor.use === 'Residential' ? Math.round(efficiency * 100) + '%' : '-'}</td>
                        <td class="number">${totalRSFForFloor > 0 ? formatNumber(totalRSFForFloor) : '-'}</td>
                        <td class="number">${floorUnitTotal > 0 ? floorUnitTotal : '-'}</td>
                        <td class="number">${floorUnits.studio > 0 ? floorUnits.studio : '-'}</td>
                        <td class="number">${floorUnits.oneBR > 0 ? floorUnits.oneBR : '-'}</td>
                        <td class="number">${floorUnits.twoBR > 0 ? floorUnits.twoBR : '-'}</td>
                        <td class="number">${floorUnits.penthouse > 0 ? floorUnits.penthouse : '-'}</td>
                        <td class="number">${parkingSF > 0 ? formatNumber(parkingSF) : '-'}</td>
                        <td class="number">${calcCars > 0 ? calcCars : '-'}</td>
                        <td class="number">${floor.actualCars ? floor.actualCars : '-'}</td>
                    </tr>
                `;
            });
            
            // Totals row
            const overallEfficiency = totalGSF > 0 ? (totalRSF / totalGSF * 100) : 0;
            
            html += `
                <tr class="totals">
                    <td class="number">${decimalToFeetInches(totalHeight)}</td>
                    <td colspan="3">TOTALS</td>
                    <td class="number">-</td>
                    <td class="number">${formatNumber(totalGSF)} GSF</td>
                    <td class="number">${formatNumber(totalConstructionGSF)} SF</td>
                    <td class="number">${overallEfficiency.toFixed(1)}%</td>
                    <td class="number">${formatNumber(totalRSF)} RSF</td>
                    <td class="number">${totalUnits}</td>
                    <td class="number">${totalStudios}</td>
                    <td class="number">${totalOneBR}</td>
                    <td class="number">${totalTwoBR}</td>
                    <td class="number">${totalPH}</td>
                    <td class="number">${formatNumber(totalParkingSF)} SF</td>
                    <td class="number">${totalCalcCars}</td>
                    <td class="number">${totalActualCars > 0 ? totalActualCars : '-'}</td>
                </tr>
            `;
            
            tbody.innerHTML = html;
            
            // Update summary cards
            document.getElementById('summaryFloors').innerHTML = `${totalFloors}<span class="summary-card-unit">floors</span>`;
            document.getElementById('summaryHeight').innerHTML = `${Math.round(totalHeight)}<span class="summary-card-unit">ft</span>`;
            document.getElementById('summaryGSF').innerHTML = `${formatNumber(totalGSF)}<span class="summary-card-unit">SF</span>`;
            document.getElementById('summaryRSF').innerHTML = `${formatNumber(totalRSF)}<span class="summary-card-unit">SF</span>`;
            document.getElementById('summaryEfficiency').innerHTML = `${overallEfficiency.toFixed(1)}<span class="summary-card-unit">%</span>`;
            document.getElementById('summaryParking').innerHTML = `${totalParking}<span class="summary-card-unit">cars</span>`;
            
            // Update parking summary
            let requiredParking = 0;
            if (state.parkingMethod === 'beds') {
                requiredParking = Math.round(totalBeds * state.parkingRatio);
            } else if (state.parkingMethod === 'units') {
                requiredParking = Math.round(totalUnits * state.parkingRatio);
            } else {
                requiredParking = state.fixedParking;
            }
            
            const parkingSurplus = totalParking - requiredParking;
            
            document.getElementById('parkingProvided').textContent = totalParking;
            document.getElementById('parkingRequired').textContent = requiredParking;
            
            const surplusEl = document.getElementById('parkingSurplus');
            surplusEl.textContent = parkingSurplus >= 0 ? `+${parkingSurplus}` : parkingSurplus;
            surplusEl.className = `parking-stat-value ${parkingSurplus >= 0 ? 'surplus' : 'deficit'}`;
            
            // Update unit mix delta display
            updateUnitMixDeltas(totalUnits, totalStudios, totalOneBR, totalTwoBR, totalPH);
            
            // Update site data calculations
            updateSiteCalcs(totalGSF);
        }
        
        // Update the sidebar unit mix delta display
        function updateUnitMixDeltas(totalUnits, studios, oneBR, twoBR, ph) {
            if (totalUnits === 0) {
                // No units, show zeros
                document.getElementById('actualStudioPct').textContent = '0%';
                document.getElementById('actualOneBRPct').textContent = '0%';
                document.getElementById('actualTwoBRPct').textContent = '0%';
                document.getElementById('actualPHPct').textContent = '0%';
                
                ['deltaStudio', 'deltaOneBR', 'deltaTwoBR', 'deltaPH'].forEach(id => {
                    const el = document.getElementById(id);
                    el.textContent = '+0%';
                    el.className = 'delta-value neutral';
                });
                return;
            }
            
            // Calculate actual percentages
            const actualStudio = Math.round((studios / totalUnits) * 100);
            const actualOneBR = Math.round((oneBR / totalUnits) * 100);
            const actualTwoBR = Math.round((twoBR / totalUnits) * 100);
            const actualPH = Math.round((ph / totalUnits) * 100);
            
            // Calculate deltas
            const deltaStudio = actualStudio - state.targetUnitMix.studio;
            const deltaOneBR = actualOneBR - state.targetUnitMix.oneBR;
            const deltaTwoBR = actualTwoBR - state.targetUnitMix.twoBR;
            const deltaPH = actualPH - state.targetUnitMix.penthouse;
            
            // Update display
            document.getElementById('actualStudioPct').textContent = actualStudio + '%';
            document.getElementById('actualOneBRPct').textContent = actualOneBR + '%';
            document.getElementById('actualTwoBRPct').textContent = actualTwoBR + '%';
            document.getElementById('actualPHPct').textContent = actualPH + '%';
            
            // Update delta values with color coding
            const updateDelta = (id, value) => {
                const el = document.getElementById(id);
                el.textContent = (value >= 0 ? '+' : '') + value + '%';
                el.className = 'delta-value ' + (value === 0 ? 'neutral' : (value > 0 ? 'positive' : 'negative'));
            };
            
            updateDelta('deltaStudio', deltaStudio);
            updateDelta('deltaOneBR', deltaOneBR);
            updateDelta('deltaTwoBR', deltaTwoBR);
            updateDelta('deltaPH', deltaPH);
        }

        function generateAllFloors() {
            const allFloors = [];
            
            state.floorTypes.forEach(ft => {
                const floors = generateFloorRange(ft.startFloor, ft.endFloor, state.skip13);
                floors.forEach(label => {
                    allFloors.push({
                        label: label,
                        typeName: ft.name,
                        use: ft.use,
                        gsf: ft.gsf,
                        height: ft.height,
                        countsInGSF: ft.countsInGSF,
                        actualCars: ft.actualCars,
                        isPLevel: ft.isPLevel,
                        additionalUses: ft.additionalUses ? ft.additionalUses.map(au => ({...au})) : [],
                        sortOrder: parseFloorLabel(label)
                    });
                });
            });
            
            return allFloors;
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================

        function toggleFloorType(index) {
            const wasExpanded = state.floorTypes[index].expanded;
            
            // Collapse all floor types first
            state.floorTypes.forEach((ft, i) => {
                ft.expanded = false;
            });
            
            // If it wasn't expanded, expand it now
            if (!wasExpanded) {
                state.floorTypes[index].expanded = true;
            }
            
            renderFloorTypes();
        }

        function updateFloorTypeField(index, field, value) {
            state.floorTypes[index][field] = value;
            renderFloorTypes();
            updatePreview();
        }

        // Update use type and set GSF default based on use
        function updateFloorTypeUse(index, value) {
            state.floorTypes[index].use = value;
            // Parking and Mechanical default to NOT counting in GSF, all others do
            state.floorTypes[index].countsInGSF = (value !== 'Parking' && value !== 'Mechanical');
            renderFloorTypes();
            updatePreview();
        }

        // Select additional use from dropdown
        function selectAdditionalUse(floorIndex, useIndex, value) {
            if (value === '') {
                // Cleared the selection - disable this and all subsequent
                for (let i = useIndex; i < 4; i++) {
                    state.floorTypes[floorIndex].additionalUses[i].enabled = false;
                    state.floorTypes[floorIndex].additionalUses[i].use = '';
                    state.floorTypes[floorIndex].additionalUses[i].sf = 0;
                }
            } else {
                state.floorTypes[floorIndex].additionalUses[useIndex].enabled = true;
                state.floorTypes[floorIndex].additionalUses[useIndex].use = value;
                // Parking and Mechanical default to NOT counting in GSF
                state.floorTypes[floorIndex].additionalUses[useIndex].countsInGSF = (value !== 'Parking' && value !== 'Mechanical');
            }
            renderFloorTypes();
            updatePreview();
        }

        // Update additional use SF
        function updateAdditionalUseSF(floorIndex, useIndex, value) {
            state.floorTypes[floorIndex].additionalUses[useIndex].sf = parseInt(value) || 0;
            updatePreview();
        }

        // Update additional use GSF checkbox
        function updateAdditionalUseGSF(floorIndex, useIndex, checked) {
            state.floorTypes[floorIndex].additionalUses[useIndex].countsInGSF = checked;
            updatePreview();
        }
        
        // Update additional use unit count (for Residential additional uses)
        function updateAdditionalUseUnitCount(floorIndex, useIndex, field, value) {
            const au = state.floorTypes[floorIndex].additionalUses[useIndex];
            if (!au.unitCounts) {
                const auRSF = Math.round((au.sf || 0) * state.efficiency);
                au.unitCounts = calculateDefaultUnitCounts(auRSF, false);
            }
            au.unitCounts[field] = value;
            renderFloorTypes();
            updatePreview();
        }

        function addFloorType() {
            const newType = {
                name: 'New Floor Type',
                use: 'Residential',
                startFloor: '02',
                endFloor: '10',
                gsf: 10000,
                height: "10' 8\"",
                countsInGSF: true,
                actualCars: null,
                expanded: true,
                isPLevel: false,
                additionalUses: getDefaultAdditionalUses()
            };
            state.floorTypes.push(newType);
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        function deleteFloorType(index) {
            state.floorTypes.splice(index, 1);
            autoRenumberFloors();
            renderFloorTypes();
            updatePreview();
        }

        function updateEfficiencyDisplay() {
            const value = document.getElementById('efficiency').value;
            document.getElementById('efficiencyValue').textContent = value + '%';
            state.efficiency = value / 100;
            updatePreview();
        }

        function updateEfficiencyGoalDisplay() {
            const value = document.getElementById('efficiencyGoal').value;
            document.getElementById('efficiencyGoalValue').textContent = value + '%';
            state.efficiencyGoal = value / 100;
            updatePreview();
        }

        function updateSiteData() {
            state.siteSF = parseInt(document.getElementById('siteSF').value) || 0;
            state.allowedFAR = parseFloat(document.getElementById('allowedFAR').value) || 0;
            updatePreview();
        }

        function updateSiteCalcs(totalGSF) {
            const totalFARAvailable = state.siteSF * state.allowedFAR;
            const deltaToFAR = totalGSF - totalFARAvailable;
            
            document.getElementById('totalFARAvailable').textContent = formatNumber(totalFARAvailable) + ' SF';
            
            const deltaEl = document.getElementById('deltaToFAR');
            deltaEl.textContent = (deltaToFAR >= 0 ? '+' : '') + formatNumber(deltaToFAR) + ' SF';
            deltaEl.classList.remove('positive', 'negative');
            deltaEl.classList.add(deltaToFAR <= 0 ? 'positive' : 'negative');
        }

        // Unit Mix Functions
        function updateUnitMixSettings() {
            state.avgUnitSize = parseInt(document.getElementById('avgUnitSize').value) || 900;
            
            if (state.useGranularSizes) {
                state.unitSizes = {
                    studio: parseInt(document.getElementById('studioSize').value) || 500,
                    oneBR: parseInt(document.getElementById('oneBRSize').value) || 750,
                    twoBR: parseInt(document.getElementById('twoBRSize').value) || 1000,
                    penthouse: parseInt(document.getElementById('penthouseSize').value) || 1800
                };
            }
            
            state.targetUnitMix = {
                studio: parseInt(document.getElementById('targetStudio').value) || 0,
                oneBR: parseInt(document.getElementById('targetOneBR').value) || 0,
                twoBR: parseInt(document.getElementById('targetTwoBR').value) || 0,
                penthouse: parseInt(document.getElementById('targetPH').value) || 0
            };
            
            // Update total percentage display
            const total = state.targetUnitMix.studio + state.targetUnitMix.oneBR + 
                         state.targetUnitMix.twoBR + state.targetUnitMix.penthouse;
            const totalEl = document.getElementById('mixTotalPercent');
            totalEl.textContent = total + '%';
            totalEl.classList.remove('warning', 'error');
            if (total !== 100) {
                totalEl.classList.add(Math.abs(total - 100) <= 5 ? 'warning' : 'error');
            }
            
            // Recalculate default unit counts for floor types that don't have custom counts
            initializeUnitCounts();
            renderFloorTypes();
            updatePreview();
        }
        
        function toggleGranularSizes() {
            state.useGranularSizes = document.getElementById('useGranularSizes').checked;
            const granularGroup = document.getElementById('granularSizesGroup');
            if (state.useGranularSizes) {
                granularGroup.classList.remove('hidden');
            } else {
                granularGroup.classList.add('hidden');
            }
            initializeUnitCounts();
            renderFloorTypes();
            updatePreview();
        }
        
        // Calculate default unit counts for a single floor based on RSF and target mix
        function calculateDefaultUnitCounts(rsf, isPenthouse = false) {
            if (rsf <= 0) return { studio: 0, oneBR: 0, twoBR: 0, penthouse: 0 };
            
            // For penthouse floors, all units are PH
            if (isPenthouse) {
                const totalUnits = Math.round(rsf / (state.useGranularSizes ? state.unitSizes.penthouse : state.avgUnitSize));
                return { studio: 0, oneBR: 0, twoBR: 0, penthouse: totalUnits };
            }
            
            let units = { studio: 0, oneBR: 0, twoBR: 0, penthouse: 0 };
            
            if (state.useGranularSizes) {
                // Calculate units per type based on RSF allocation and type-specific sizes
                const studioRSF = rsf * (state.targetUnitMix.studio / 100);
                const oneBRRSF = rsf * (state.targetUnitMix.oneBR / 100);
                const twoBRRSF = rsf * (state.targetUnitMix.twoBR / 100);
                const penthouseRSF = rsf * (state.targetUnitMix.penthouse / 100);
                
                units.studio = Math.round(studioRSF / state.unitSizes.studio);
                units.oneBR = Math.round(oneBRRSF / state.unitSizes.oneBR);
                units.twoBR = Math.round(twoBRRSF / state.unitSizes.twoBR);
                units.penthouse = Math.round(penthouseRSF / state.unitSizes.penthouse);
            } else {
                // Use average unit size for total, then distribute by percentage
                const totalUnits = Math.round(rsf / state.avgUnitSize);
                units.studio = Math.round(totalUnits * (state.targetUnitMix.studio / 100));
                units.oneBR = Math.round(totalUnits * (state.targetUnitMix.oneBR / 100));
                units.twoBR = Math.round(totalUnits * (state.targetUnitMix.twoBR / 100));
                units.penthouse = Math.round(totalUnits * (state.targetUnitMix.penthouse / 100));
            }
            
            return units;
        }
        
        // Initialize unit counts for all residential floor types
        function initializeUnitCounts() {
            state.floorTypes.forEach(ft => {
                if (ft.use === 'Residential' && !ft.unitCountsInitialized) {
                    const isPH = ft.name.toLowerCase().includes('penthouse') || ft.name.toLowerCase().includes('ph');
                    const rsf = Math.round(ft.gsf * state.efficiency);
                    ft.unitCounts = calculateDefaultUnitCounts(rsf, isPH);
                    ft.unitCountsInitialized = true;
                }
            });
        }
        
        // Update unit count for a specific floor type
        function updateFloorTypeUnitCount(index, field, value) {
            if (!state.floorTypes[index].unitCounts) {
                const ft = state.floorTypes[index];
                const isPH = ft.name.toLowerCase().includes('penthouse') || ft.name.toLowerCase().includes('ph');
                const rsf = Math.round(ft.gsf * state.efficiency);
                state.floorTypes[index].unitCounts = calculateDefaultUnitCounts(rsf, isPH);
            }
            state.floorTypes[index].unitCounts[field] = value;
            state.floorTypes[index].unitCountsInitialized = true;
            renderFloorTypes();
            updatePreview();
        }
        
        // Calculate unit counts for preview/Excel (uses stored values or calculates defaults)
        function getFloorTypeUnitCounts(ft) {
            const isPH = ft.name.toLowerCase().includes('penthouse') || ft.name.toLowerCase().includes('ph');
            
            if (ft.unitCounts) {
                return { ...ft.unitCounts };
            }
            
            const rsf = Math.round(ft.gsf * state.efficiency);
            return calculateDefaultUnitCounts(rsf, isPH);
        }

        function updateParkingMethod() {
            const method = document.querySelector('input[name="parkingMethod"]:checked').value;
            state.parkingMethod = method;
            
            const ratioGroup = document.getElementById('parkingRatioGroup');
            const fixedGroup = document.getElementById('fixedParkingGroup');
            const ratioLabel = ratioGroup.querySelector('label');
            
            if (method === 'fixed') {
                ratioGroup.classList.add('hidden');
                fixedGroup.classList.remove('hidden');
            } else {
                ratioGroup.classList.remove('hidden');
                fixedGroup.classList.add('hidden');
                ratioLabel.textContent = method === 'beds' ? 'Cars per Bed Ratio' : 'Cars per Unit Ratio';
            }
            
            updatePreview();
        }

        function updatePreview() {
            // Update state from inputs
            state.projectName = document.getElementById('projectName').value;
            state.projectCity = document.getElementById('projectCity').value;
            state.projectNumber = document.getElementById('projectNumber').value;
            state.skip13 = document.getElementById('skip13').checked;
            state.sfPerCar = parseInt(document.getElementById('sfPerCar').value) || 410;
            state.parkingRatio = parseFloat(document.getElementById('parkingRatio').value) || 0.9;
            state.fixedParking = parseInt(document.getElementById('fixedParking').value) || 150;
            
            // Update default heights
            state.defaultHeights = {
                belowGrade: feetInchesToDecimal(document.getElementById('defaultHeightBelowGrade').value),
                ground: feetInchesToDecimal(document.getElementById('defaultHeightGround').value),
                p2: feetInchesToDecimal(document.getElementById('defaultHeightP2').value),
                parking: feetInchesToDecimal(document.getElementById('defaultHeightParking').value),
                residential: feetInchesToDecimal(document.getElementById('defaultHeightResidential').value),
                amenity: feetInchesToDecimal(document.getElementById('defaultHeightAmenity').value),
                penthouse: feetInchesToDecimal(document.getElementById('defaultHeightPenthouse').value),
                mechanical: feetInchesToDecimal(document.getElementById('defaultHeightMechanical').value)
            };
            
            renderPreviewTable();
        }

        function renumberFloors() {
            autoRenumberFloors();
            renderFloorTypes();
            showToast('Floors renumbered!', 'success');
            updatePreview();
        }

        function resetToDefaults() {
            if (!confirm('Are you sure you want to reset all settings? This cannot be undone.')) return;
            
            state = {
                floorTypes: getDefaultFloorTypes(),
                projectName: 'My Residential Tower',
                projectCity: 'Dallas, TX',
                projectNumber: '00000.000',
                efficiency: 0.85,
                efficiencyGoal: 0.80,
                skip13: true,
                siteSF: 50000,
                allowedFAR: 5.0,
                sfPerCar: 410,
                parkingMethod: 'beds',
                parkingRatio: 0.9,
                fixedParking: 150,
                defaultHeights: {
                    belowGrade: 10.0,
                    ground: 18.0,
                    p2: 11.0,
                    parking: 9.67,
                    residential: 10.67,
                    amenity: 12.0,
                    penthouse: 11.67,
                    mechanical: 15.0
                }
            };
            
            // Reset form inputs
            document.getElementById('projectName').value = state.projectName;
            document.getElementById('projectCity').value = state.projectCity;
            document.getElementById('projectNumber').value = state.projectNumber;
            document.getElementById('efficiency').value = state.efficiency * 100;
            document.getElementById('efficiencyValue').textContent = Math.round(state.efficiency * 100) + '%';
            document.getElementById('efficiencyGoal').value = state.efficiencyGoal * 100;
            document.getElementById('efficiencyGoalValue').textContent = Math.round(state.efficiencyGoal * 100) + '%';
            document.getElementById('skip13').checked = state.skip13;
            document.getElementById('siteSF').value = state.siteSF;
            document.getElementById('allowedFAR').value = state.allowedFAR;
            document.getElementById('sfPerCar').value = state.sfPerCar;
            document.getElementById('parkingRatio').value = state.parkingRatio;
            document.getElementById('fixedParking').value = state.fixedParking;
            
            renderFloorTypes();
            updatePreview();
            showToast('Reset to defaults!', 'success');
        }

        function getDefaultFloorTypes() {
            return [
                { name: 'Below Grade Parking - Van Accessible', use: 'Parking', startFloor: 'B01', endFloor: 'B01', gsf: 10000, height: "11' 0\"", countsInGSF: false, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Below Grade Parking', use: 'Parking', startFloor: 'B02', endFloor: 'B02', gsf: 10000, height: "10' 0\"", countsInGSF: false, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Ground Level', use: 'Retail', startFloor: 'G', endFloor: 'G', gsf: 10000, height: "18' 0\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'P02 - Van Accessible', use: 'Parking', startFloor: 'P02', endFloor: 'P02', gsf: 10000, height: "11' 0\"", countsInGSF: false, expanded: false, isPLevel: true, additionalUses: getDefaultAdditionalUses() },
                { name: 'Above Grade Parking', use: 'Parking', startFloor: 'P03', endFloor: 'P03', gsf: 10000, height: "9' 8\"", countsInGSF: false, expanded: false, isPLevel: true, additionalUses: getDefaultAdditionalUses() },
                { name: 'Amenity Level', use: 'Amenity', startFloor: '04', endFloor: '04', gsf: 10000, height: "12' 0\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Tower - Lower Typical', use: 'Residential', startFloor: '05', endFloor: '05', gsf: 10000, height: "10' 8\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Tower - Middle Typical', use: 'Residential', startFloor: '06', endFloor: '06', gsf: 10000, height: "10' 8\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Tower - Upper Typical', use: 'Residential', startFloor: '07', endFloor: '07', gsf: 10000, height: "10' 8\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Penthouse', use: 'Residential', startFloor: '08', endFloor: '08', gsf: 10000, height: "11' 8\"", countsInGSF: true, expanded: false, additionalUses: getDefaultAdditionalUses() },
                { name: 'Roof - Mechanical', use: 'Mechanical', startFloor: '09', endFloor: '09', gsf: 10000, height: "15' 0\"", countsInGSF: false, expanded: false, additionalUses: getDefaultAdditionalUses() }
            ];
        }

        function getDefaultAdditionalUses() {
            return [
                { enabled: false, use: '', sf: 0, countsInGSF: true },
                { enabled: false, use: '', sf: 0, countsInGSF: true },
                { enabled: false, use: '', sf: 0, countsInGSF: true },
                { enabled: false, use: '', sf: 0, countsInGSF: true }
            ];
        }

        // ============================================
        // EXCEL GENERATION
        // ============================================

        async function generateExcel() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Stacking Diagram');
            
            // Define styles
            const headerStyle = {
                font: { bold: true, color: { argb: 'FFFFFFFF' }, size: 11 },
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1A1A1A' } },
                alignment: { horizontal: 'center', vertical: 'middle' },
                border: { bottom: { style: 'thin', color: { argb: 'FF000000' } } }
            };
            
            const totalStyle = {
                font: { bold: true, color: { argb: 'FFFFFFFF' }, size: 11 },
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1A1A1A' } },
                alignment: { vertical: 'middle' }
            };
            
            // User input style - blue bold font
            const userInputStyle = {
                font: { bold: true, color: { argb: 'FF2563EB' } }
            };
            
            // Add project header section
            worksheet.mergeCells('A1:R1');
            const titleCell = worksheet.getCell('A1');
            titleCell.value = state.projectName;
            titleCell.font = { bold: true, size: 16 };
            titleCell.alignment = { horizontal: 'left' };
            
            worksheet.mergeCells('A2:R2');
            const cityCell = worksheet.getCell('A2');
            cityCell.value = state.projectCity;
            cityCell.font = { size: 12 };
            cityCell.alignment = { horizontal: 'left' };
            
            worksheet.mergeCells('A3:R3');
            const projectNumCell = worksheet.getCell('A3');
            projectNumCell.value = `HKS Project# ${state.projectNumber}`;
            projectNumCell.font = { size: 11 };
            projectNumCell.alignment = { horizontal: 'left' };
            
            worksheet.mergeCells('A4:R4');
            const dateCell = worksheet.getCell('A4');
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            dateCell.value = dateStr;
            dateCell.font = { size: 11, italic: true };
            dateCell.alignment = { horizontal: 'left' };
            
            worksheet.addRow([]);
            
            // New column order: 
            // A: Height | B: Floor | C: Constr GSF | [D-F Grouped: Resi | Amenity | Mech] | G: Retail | H: GSF | I: Eff | J: RSF | K: Units | L: S | M: 1BR | N: 2BR | O: PH | P: Pkg SF | Q: Calc Cars | R: Actual Cars
            const headers = [
                'Height', 'Floor', 'Construction GSF', 
                'Residential', 'Amenity', 'BOH/Mechanical', 'Retail',
                'GSF', 'Efficiency', 'RSF', 'Units', 'S', '1BR', '2BR', 'PH', 'Parking SF', 'Calc Cars', 'Actual Cars'
            ];
            worksheet.getRow(6).values = headers;
            worksheet.getRow(6).eachCell((cell) => {
                Object.assign(cell, headerStyle);
            });
            
            worksheet.addRow([]);
            
            worksheet.columns = [
                { width: 10 },  // A - Height
                { width: 8 },   // B - Floor
                { width: 14 },  // C - Construction GSF
                { width: 12 },  // D - Residential (grouped)
                { width: 10 },  // E - Amenity (grouped)
                { width: 12 },  // F - BOH/Mechanical (grouped)
                { width: 10 },  // G - Retail
                { width: 10 },  // H - GSF
                { width: 8 },   // I - Efficiency
                { width: 10 },  // J - RSF
                { width: 6 },   // K - Units
                { width: 5 },   // L - S
                { width: 5 },   // M - 1BR
                { width: 5 },   // N - 2BR
                { width: 5 },   // O - PH
                { width: 10 },  // P - Parking SF
                { width: 8 },   // Q - Calc Cars
                { width: 10 }   // R - Actual Cars
            ];
            
            // Group columns D-F (Residential, Amenity, BOH/Mech) - collapsed by default
            worksheet.getColumn(4).outlineLevel = 1;
            worksheet.getColumn(5).outlineLevel = 1;
            worksheet.getColumn(6).outlineLevel = 1;
            worksheet.properties.outlineLevelCol = 1;
            
            const allFloors = generateAllFloors();
            allFloors.sort((a, b) => b.sortOrder - a.sortOrder);
            
            const firstDataRow = 8;
            let rowNum = firstDataRow;
            
            const useColors = {
                'Parking': 'FFD1D5DB',
                'Retail': 'FFEFF6FF',
                'Amenity': 'FFFAF5FF',
                'Mechanical': 'FFFFF7ED',
                'Office': 'FFECFEFF'
            };
            const belowGradeColor = 'FF9CA3AF';
            
            // Residential gradient colors
            const resiGradient = {
                1: 'FF14532D', 2: 'FF166534', 3: 'FF15803D', 4: 'FF16A34A', 5: 'FF22C55E',
                6: 'FF4ADE80', 7: 'FF86EFAC', 8: 'FFBBF7D0', 9: 'FFDCFCE7', 10: 'FFF0FDF4'
            };
            
            // Get unique residential floor TYPES in order (top to bottom)
            const resiFloorTypes = [];
            allFloors.forEach(f => {
                if (f.use === 'Residential' && !resiFloorTypes.includes(f.typeName)) {
                    resiFloorTypes.push(f.typeName);
                }
            });
            
            // Create shade map by floor type name
            const resiTypeShadeMap = {};
            const typeCount = resiFloorTypes.length;
            resiFloorTypes.forEach((typeName, idx) => {
                const position = typeCount - idx;
                const shade = Math.min(10, Math.max(1, Math.ceil(position / typeCount * 10)));
                resiTypeShadeMap[typeName] = shade;
            });
            
            allFloors.forEach((floor) => {
                const height = feetInchesToDecimal(floor.height);
                const efficiency = state.efficiency;
                
                // Aggregate SF by use type
                const sfByUse = { Residential: 0, Amenity: 0, Parking: 0, Mechanical: 0, Retail: 0 };
                const gsfByUse = { Residential: 0, Amenity: 0, Parking: 0, Mechanical: 0, Retail: 0 };
                
                // Primary use
                const primaryUse = floor.use === 'Office' ? 'Mechanical' : floor.use;
                if (sfByUse.hasOwnProperty(primaryUse)) {
                    sfByUse[primaryUse] += floor.gsf;
                    if (floor.countsInGSF) gsfByUse[primaryUse] += floor.gsf;
                }
                
                // Add deck SF for amenity floors (Construction GSF only)
                const ft = state.floorTypes.find(f => f.name === floor.typeName);
                let deckSF = 0;
                if (ft && ft.deckSF > 0) {
                    deckSF = ft.deckSF;
                }
                
                // Additional uses
                if (floor.additionalUses) {
                    floor.additionalUses.forEach(au => {
                        if (au.enabled && au.use && au.sf > 0) {
                            const auUse = au.use === 'Office' ? 'Mechanical' : au.use;
                            if (sfByUse.hasOwnProperty(auUse)) {
                                sfByUse[auUse] += au.sf;
                                if (au.countsInGSF) gsfByUse[auUse] += au.sf;
                            }
                        }
                    });
                }
                
                // Calculate totals
                const constructionGSF = Object.values(sfByUse).reduce((a, b) => a + b, 0) + deckSF;
                const gsf = Object.values(gsfByUse).reduce((a, b) => a + b, 0);
                const resiGSF = gsfByUse.Residential;
                const parkingSF = sfByUse.Parking;
                
                // Get unit counts for this floor type (from user input)
                let unitCounts = { studio: 0, oneBR: 0, twoBR: 0, penthouse: 0 };
                if (ft && ft.use === 'Residential') {
                    unitCounts = getFloorTypeUnitCounts(ft);
                }
                // Add additional use residential unit counts
                if (floor.additionalUses) {
                    floor.additionalUses.forEach(au => {
                        if (au.enabled && au.use === 'Residential' && au.unitCounts) {
                            unitCounts.studio += au.unitCounts.studio || 0;
                            unitCounts.oneBR += au.unitCounts.oneBR || 0;
                            unitCounts.twoBR += au.unitCounts.twoBR || 0;
                            unitCounts.penthouse += au.unitCounts.penthouse || 0;
                        }
                    });
                }
                const totalUnits = unitCounts.studio + unitCounts.oneBR + unitCounts.twoBR + unitCounts.penthouse;
                
                const isBelowGrade = floor.label.toUpperCase().startsWith('B');
                
                // Add row - note new column positions
                // A: Height | B: Floor | C: Constr GSF | D: Resi | E: Amenity | F: Mech | G: Retail | H: GSF | I: Eff | J: RSF | K: Units | L: S | M: 1BR | N: 2BR | O: PH | P: Pkg SF | Q: Calc Cars | R: Actual Cars
                const row = worksheet.addRow([
                    height,                              // A - Height
                    floor.label,                         // B - Floor
                    constructionGSF,                     // C - Construction GSF
                    sfByUse.Residential || '',           // D - Residential (grouped)
                    sfByUse.Amenity || '',               // E - Amenity (grouped)
                    sfByUse.Mechanical || '',            // F - BOH/Mechanical (grouped)
                    sfByUse.Retail || '',                // G - Retail
                    gsf || '',                           // H - GSF
                    resiGSF > 0 ? state.efficiency : '', // I - Efficiency
                    '',                                  // J - RSF (will be formula)
                    totalUnits > 0 ? totalUnits : '',    // K - Units (user input)
                    unitCounts.studio || '',             // L - S (user input)
                    unitCounts.oneBR || '',              // M - 1BR (user input)
                    unitCounts.twoBR || '',              // N - 2BR (user input)
                    unitCounts.penthouse || '',          // O - PH (user input)
                    parkingSF || '',                     // P - Parking SF
                    '',                                  // Q - Calc Cars (will be formula)
                    floor.actualCars || ''               // R - Actual Cars (user input)
                ]);
                
                // Set RSF formula: =IF(D{row}>0, ROUND(D{row}*I{row}, 0), 0)
                if (resiGSF > 0) {
                    row.getCell(10).value = { formula: `IF(D${rowNum}>0,ROUND(D${rowNum}*I${rowNum},0),0)` };
                }
                
                // Set Calc Cars formula - references parking settings cells at bottom (will be updated after we know row numbers)
                // For now, use placeholder that we'll update
                if (parkingSF > 0) {
                    row.getCell(17).value = { formula: `IF(P${rowNum}>0,FLOOR(P${rowNum}/$P$SFPERCAR,1),0)` };
                }
                
                // Determine row color
                let rowColor;
                if (isBelowGrade) {
                    rowColor = belowGradeColor;
                } else if (floor.use === 'Residential' && resiTypeShadeMap[floor.typeName]) {
                    rowColor = resiGradient[resiTypeShadeMap[floor.typeName]];
                } else if (floor.use === 'Parking') {
                    rowColor = 'FFF3F4F6';
                } else {
                    rowColor = useColors[floor.use] || 'FFFFFFFF';
                }
                
                const darkShades = [1, 2, 3, 4];
                const needsWhiteText = floor.use === 'Residential' && resiTypeShadeMap[floor.typeName] && darkShades.includes(resiTypeShadeMap[floor.typeName]);
                
                row.eachCell((cell, colNumber) => {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowColor } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    if (needsWhiteText) {
                        cell.font = { color: { argb: 'FFFFFFFF' } };
                    }
                    // User input cells get blue bold font (units and actual cars)
                    if ([11, 12, 13, 14, 15, 18].includes(colNumber) && cell.value) {
                        cell.font = { ...cell.font, bold: true, color: { argb: needsWhiteText ? 'FF93C5FD' : 'FF2563EB' } };
                    }
                });
                
                // Format cells
                row.getCell(1).numFmt = '0.00" ft"';
                row.getCell(3).numFmt = '#,##0';
                row.getCell(4).numFmt = '#,##0';
                row.getCell(5).numFmt = '#,##0';
                row.getCell(6).numFmt = '#,##0';
                row.getCell(7).numFmt = '#,##0';
                row.getCell(8).numFmt = '#,##0';
                if (resiGSF > 0) row.getCell(9).numFmt = '0%';
                row.getCell(10).numFmt = '#,##0';
                row.getCell(11).numFmt = '#,##0';
                row.getCell(12).numFmt = '#,##0';
                row.getCell(13).numFmt = '#,##0';
                row.getCell(14).numFmt = '#,##0';
                row.getCell(15).numFmt = '#,##0';
                row.getCell(16).numFmt = '#,##0';
                row.getCell(17).numFmt = '#,##0';
                row.getCell(18).numFmt = '#,##0';
                
                rowNum++;
            });
            
            const lastDataRow = rowNum - 1;
            
            worksheet.addRow([]);
            rowNum++;
            
            // Totals Row with formulas
            const totalsRow = worksheet.addRow([
                { formula: `SUM(A${firstDataRow}:A${lastDataRow})` },      // A - Height
                { formula: `COUNTA(B${firstDataRow}:B${lastDataRow})&" Floors"` }, // B - Floor count as formula
                { formula: `SUM(C${firstDataRow}:C${lastDataRow})` },      // C - Construction GSF
                { formula: `SUM(D${firstDataRow}:D${lastDataRow})` },      // D - Residential
                { formula: `SUM(E${firstDataRow}:E${lastDataRow})` },      // E - Amenity
                { formula: `SUM(F${firstDataRow}:F${lastDataRow})` },      // F - BOH/Mech
                { formula: `SUM(G${firstDataRow}:G${lastDataRow})` },      // G - Retail
                { formula: `SUM(H${firstDataRow}:H${lastDataRow})` },      // H - GSF
                '',                                                         // I - Efficiency (blank for totals)
                { formula: `SUM(J${firstDataRow}:J${lastDataRow})` },      // J - RSF
                { formula: `SUM(K${firstDataRow}:K${lastDataRow})` },      // K - Units
                { formula: `SUM(L${firstDataRow}:L${lastDataRow})` },      // L - S
                { formula: `SUM(M${firstDataRow}:M${lastDataRow})` },      // M - 1BR
                { formula: `SUM(N${firstDataRow}:N${lastDataRow})` },      // N - 2BR
                { formula: `SUM(O${firstDataRow}:O${lastDataRow})` },      // O - PH
                { formula: `SUM(P${firstDataRow}:P${lastDataRow})` },      // P - Parking SF
                { formula: `SUM(Q${firstDataRow}:Q${lastDataRow})` },      // Q - Calc Cars
                { formula: `SUM(R${firstDataRow}:R${lastDataRow})` }       // R - Actual Cars
            ]);
            
            totalsRow.eachCell((cell, colNumber) => {
                Object.assign(cell, totalStyle);
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                if (colNumber === 1) cell.numFmt = '0.00" ft"';
                if (colNumber === 3) cell.numFmt = '#,##0" SF"';
                if (colNumber >= 4 && colNumber <= 7) cell.numFmt = '#,##0';
                if (colNumber === 8) cell.numFmt = '#,##0" GSF"';
                if (colNumber === 10) cell.numFmt = '#,##0" RSF"';
                if (colNumber === 11) cell.numFmt = '#,##0" units"';
                if (colNumber >= 12 && colNumber <= 15) cell.numFmt = '#,##0';
                if (colNumber === 16) cell.numFmt = '#,##0" SF"';
                if (colNumber === 17) cell.numFmt = '#,##0" cars"';
                if (colNumber === 18) cell.numFmt = '#,##0" cars"';
            });
            
            const totalsRowNum = rowNum;
            rowNum++;
            
            worksheet.addRow([]);
            rowNum++;
            
            // Efficiency row
            const effRow = worksheet.addRow(['', '', '', '', '', '', '', 'Overall Efficiency:', { formula: `IF(H${totalsRowNum}>0,J${totalsRowNum}/H${totalsRowNum},0)` }]);
            effRow.getCell(9).numFmt = '0.0%';
            effRow.getCell(8).font = { bold: true };
            effRow.getCell(8).alignment = { horizontal: 'right' };
            effRow.getCell(9).font = { bold: true };
            effRow.getCell(9).alignment = { horizontal: 'center' };
            rowNum++;
            
            const goalPercent = Math.round(state.efficiencyGoal * 100);
            const deltaRow = worksheet.addRow(['', '', '', '', '', '', '', `Delta to ${goalPercent}%:`, { formula: `J${totalsRowNum}-(H${totalsRowNum}*${state.efficiencyGoal})` }]);
            deltaRow.getCell(9).numFmt = '#,##0" RSF"';
            deltaRow.getCell(8).font = { bold: true };
            deltaRow.getCell(8).alignment = { horizontal: 'right' };
            deltaRow.getCell(9).font = { bold: true };
            deltaRow.getCell(9).alignment = { horizontal: 'center' };
            rowNum += 2;
            
            // Calculate total GSF for site data
            let totalGSFForSite = 0;
            allFloors.forEach(floor => {
                if (floor.countsInGSF) totalGSFForSite += floor.gsf;
                if (floor.additionalUses) {
                    floor.additionalUses.forEach(au => {
                        if (au.enabled && au.countsInGSF && au.sf > 0) totalGSFForSite += au.sf;
                    });
                }
            });
            const totalFARAvailable = state.siteSF * state.allowedFAR;
            const deltaToFAR = totalGSFForSite - totalFARAvailable;
            
            // Site Data Summary (left) and Parking Summary (right - under P, Q, R columns)
            const siteHeader = worksheet.addRow(['', 'SITE DATA', '', '', '', '', '', '', '', '', '', '', '', '', '', 'PARKING SUMMARY']);
            siteHeader.getCell(2).font = { bold: true, size: 12 };
            siteHeader.getCell(2).alignment = { horizontal: 'left' };
            siteHeader.getCell(16).font = { bold: true, size: 12 };
            siteHeader.getCell(16).alignment = { horizontal: 'left' };
            worksheet.mergeCells(`B${rowNum}:D${rowNum}`);
            worksheet.mergeCells(`P${rowNum}:R${rowNum}`);
            rowNum++;
            
            // Row 1: Site SF | Parking Provided
            const row1 = worksheet.addRow(['', 'Site SF:', '', state.siteSF, '', '', '', '', '', '', '', '', '', '', '', 'Provided:', { formula: `IF(R${totalsRowNum}>0,R${totalsRowNum},Q${totalsRowNum})` }]);
            row1.getCell(2).alignment = { horizontal: 'left' };
            row1.getCell(4).numFmt = '#,##0" SF"';
            row1.getCell(4).font = userInputStyle.font;
            row1.getCell(4).alignment = { horizontal: 'left' };
            row1.getCell(16).alignment = { horizontal: 'left' };
            row1.getCell(17).numFmt = '#,##0" cars"';
            row1.getCell(17).alignment = { horizontal: 'left' };
            const providedRowNum = rowNum;
            rowNum++;
            
            // Row 2: Allowed FAR | Parking Required
            let requiredFormula = '';
            if (state.parkingMethod === 'beds') {
                requiredFormula = `ROUND((L${totalsRowNum}+M${totalsRowNum}+N${totalsRowNum}*2+O${totalsRowNum}*3)*R$RATIO,0)`;
            } else if (state.parkingMethod === 'units') {
                requiredFormula = `ROUND(K${totalsRowNum}*R$RATIO,0)`;
            } else {
                requiredFormula = `R$FIXED`;
            }
            
            const row2 = worksheet.addRow(['', 'Allowed FAR:', '', state.allowedFAR, '', '', '', '', '', '', '', '', '', '', '', 'Required:', { formula: requiredFormula }]);
            row2.getCell(2).alignment = { horizontal: 'left' };
            row2.getCell(4).numFmt = '0.0';
            row2.getCell(4).font = userInputStyle.font;
            row2.getCell(4).alignment = { horizontal: 'left' };
            row2.getCell(16).alignment = { horizontal: 'left' };
            row2.getCell(17).numFmt = '#,##0" cars"';
            row2.getCell(17).alignment = { horizontal: 'left' };
            const requiredRowNum = rowNum;
            rowNum++;
            
            // Row 3: Total FAR Available | Surplus/Deficit
            const row3 = worksheet.addRow(['', 'Total FAR Available:', '', { formula: `D${providedRowNum}*D${requiredRowNum}` }, '', '', '', '', '', '', '', '', '', '', '', 'Surplus/(Deficit):', { formula: `Q${providedRowNum}-Q${requiredRowNum}` }]);
            row3.getCell(2).alignment = { horizontal: 'left' };
            row3.getCell(4).numFmt = '#,##0" SF"';
            row3.getCell(4).alignment = { horizontal: 'left' };
            row3.getCell(16).alignment = { horizontal: 'left' };
            row3.getCell(17).numFmt = '#,##0" cars"';
            row3.getCell(17).font = { bold: true };
            row3.getCell(17).alignment = { horizontal: 'left' };
            rowNum++;
            
            // Row 4: Delta to FAR | (blank)
            const row4 = worksheet.addRow(['', 'Delta to FAR:', '', { formula: `H${totalsRowNum}-D${rowNum-1}` }]);
            row4.getCell(2).alignment = { horizontal: 'left' };
            row4.getCell(4).numFmt = '#,##0" SF"';
            row4.getCell(4).font = { bold: true };
            row4.getCell(4).alignment = { horizontal: 'left' };
            rowNum++;
            
            // Blank row between Site Data and Parking Settings
            worksheet.addRow([]);
            rowNum++;
            
            // Parking Settings Section (editable cells that formulas reference)
            const parkingSettingsHeader = worksheet.addRow(['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', 'PARKING SETTINGS']);
            parkingSettingsHeader.getCell(16).font = { bold: true, size: 11 };
            parkingSettingsHeader.getCell(16).alignment = { horizontal: 'left' };
            worksheet.mergeCells(`P${rowNum}:R${rowNum}`);
            rowNum++;
            
            // SF per Car
            const sfPerCarRow = worksheet.addRow(['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', 'SF per Car:', state.sfPerCar]);
            sfPerCarRow.getCell(16).alignment = { horizontal: 'left' };
            sfPerCarRow.getCell(17).font = userInputStyle.font;
            sfPerCarRow.getCell(17).alignment = { horizontal: 'left' };
            const sfPerCarRowNum = rowNum;
            rowNum++;
            
            // Method label
            const methodRow = worksheet.addRow(['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', 'Method:', state.parkingMethod]);
            methodRow.getCell(16).alignment = { horizontal: 'left' };
            methodRow.getCell(17).font = userInputStyle.font;
            methodRow.getCell(17).alignment = { horizontal: 'left' };
            rowNum++;
            
            // Ratio / Fixed
            let ratioLabel = state.parkingMethod === 'fixed' ? 'Fixed Cars:' : 'Ratio:';
            let ratioValue = state.parkingMethod === 'fixed' ? state.fixedParking : state.parkingRatio;
            const ratioRow = worksheet.addRow(['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ratioLabel, ratioValue]);
            ratioRow.getCell(16).alignment = { horizontal: 'left' };
            ratioRow.getCell(17).font = userInputStyle.font;
            ratioRow.getCell(17).alignment = { horizontal: 'left' };
            const ratioRowNum = rowNum;
            rowNum++;
            
            // Now go back and update all the Calc Cars formulas to reference the SF per car cell
            for (let r = firstDataRow; r <= lastDataRow; r++) {
                const cell = worksheet.getCell(`Q${r}`);
                if (cell.value && cell.value.formula) {
                    cell.value = { formula: `IF(P${r}>0,FLOOR(P${r}/Q${sfPerCarRowNum},1),0)` };
                }
            }
            
            // Update Required parking formula to reference ratio cell
            const reqCell = worksheet.getCell(`Q${requiredRowNum}`);
            if (state.parkingMethod === 'beds') {
                reqCell.value = { formula: `ROUND((L${totalsRowNum}+M${totalsRowNum}+N${totalsRowNum}*2+O${totalsRowNum}*3)*Q${ratioRowNum},0)` };
            } else if (state.parkingMethod === 'units') {
                reqCell.value = { formula: `ROUND(K${totalsRowNum}*Q${ratioRowNum},0)` };
            } else {
                reqCell.value = { formula: `Q${ratioRowNum}` };
            }
            
            // Blank row
            worksheet.addRow([]);
            rowNum++;
            
            // Unit Mix Assumptions section
            const assumptionsHeader = worksheet.addRow(['', 'UNIT MIX ASSUMPTIONS']);
            assumptionsHeader.getCell(2).font = { bold: true, size: 12 };
            assumptionsHeader.getCell(2).alignment = { horizontal: 'left' };
            rowNum++;
            
            // Average Unit Size
            const avgSizeRow = worksheet.addRow(['', 'Average Unit Size:', state.avgUnitSize, 'SF']);
            avgSizeRow.getCell(2).alignment = { horizontal: 'left' };
            avgSizeRow.getCell(3).font = userInputStyle.font;
            avgSizeRow.getCell(3).alignment = { horizontal: 'left' };
            avgSizeRow.getCell(4).alignment = { horizontal: 'left' };
            rowNum++;
            
            if (state.useGranularSizes) {
                // Unit sizes as editable cells
                const sizesLabelRow = worksheet.addRow(['', 'Unit Sizes:']);
                sizesLabelRow.getCell(2).alignment = { horizontal: 'left' };
                rowNum++;
                
                const sizesRow = worksheet.addRow(['', '', 'Studio:', state.unitSizes.studio, '1BR:', state.unitSizes.oneBR, '2BR:', state.unitSizes.twoBR, 'PH:', state.unitSizes.penthouse]);
                sizesRow.getCell(4).font = userInputStyle.font;
                sizesRow.getCell(6).font = userInputStyle.font;
                sizesRow.getCell(8).font = userInputStyle.font;
                sizesRow.getCell(10).font = userInputStyle.font;
                rowNum++;
            }
            
            // Target mix as editable cells
            const mixLabelRow = worksheet.addRow(['', 'Target Mix %:']);
            mixLabelRow.getCell(2).alignment = { horizontal: 'left' };
            rowNum++;
            
            const mixRow = worksheet.addRow(['', '', 'Studios:', state.targetUnitMix.studio, '1BR:', state.targetUnitMix.oneBR, '2BR:', state.targetUnitMix.twoBR, 'PH:', state.targetUnitMix.penthouse]);
            mixRow.getCell(4).font = userInputStyle.font;
            mixRow.getCell(4).numFmt = '0"%"';
            mixRow.getCell(6).font = userInputStyle.font;
            mixRow.getCell(6).numFmt = '0"%"';
            mixRow.getCell(8).font = userInputStyle.font;
            mixRow.getCell(8).numFmt = '0"%"';
            mixRow.getCell(10).font = userInputStyle.font;
            mixRow.getCell(10).numFmt = '0"%"';
            
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${state.projectName.replace(/[^a-z0-9]/gi, '_')}_Stacking.xlsx`;
            link.click();
            
            window.URL.revokeObjectURL(url);
            showToast('Excel file downloaded!', 'success');
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            state.floorTypes = getDefaultFloorTypes();
            autoRenumberFloors();
            initializeUnitCounts();
            renderFloorTypes();
            updatePreview();
        }

        // Start the app
        init();
    </script>
</body>
</html>
