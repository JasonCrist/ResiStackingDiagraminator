<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residential Tower Stacking Tool</title>
    
    <!-- ExcelJS for Excel export with formulas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    
    <!-- Google Fonts - Distinctive architectural feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #f8f7f4;
            --bg-secondary: #ffffff;
            --bg-accent: #1a1a1a;
            --text-primary: #1a1a1a;
            --text-secondary: #5a5a5a;
            --text-light: #ffffff;
            --border-color: #e0ddd8;
            --border-dark: #c0bdb8;
            --accent-blue: #2563eb;
            --accent-green: #059669;
            --accent-orange: #d97706;
            --accent-purple: #7c3aed;
            --accent-red: #dc2626;
            --accent-teal: #0891b2;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .header-subtitle {
            font-size: 0.875rem;
            opacity: 0.7;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
            position: sticky;
            top: 80px;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.375rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: inherit;
            background: var(--bg-secondary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group input[type="range"] {
            padding: 0;
            height: 6px;
            -webkit-appearance: none;
            background: var(--border-color);
            border-radius: 3px;
            border: none;
        }

        .form-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
        }

        .range-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-top: 0.25rem;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue);
        }

        .checkbox-group span {
            font-size: 0.875rem;
        }

        /* Radio Group */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .radio-option:hover {
            background: var(--bg-primary);
        }

        .radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-blue);
        }

        .radio-option span {
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-sm {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
        }

        .btn-full {
            width: 100%;
        }

        /* Content Area */
        .content {
            padding: 1.5rem 2rem;
            overflow-y: auto;
        }

        /* Floor Types Section */
        .floor-types-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .floor-types-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .floor-type-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .floor-type-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .floor-type-header:hover {
            background: var(--bg-primary);
        }

        .floor-type-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .floor-type-badge {
            padding: 0.25rem 0.625rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .floor-type-badge.residential { background: #dcfce7; color: #166534; }
        .floor-type-badge.parking { background: #f3f4f6; color: #374151; }
        .floor-type-badge.retail { background: #dbeafe; color: #1e40af; }
        .floor-type-badge.amenity { background: #f3e8ff; color: #6b21a8; }
        .floor-type-badge.mechanical { background: #ffedd5; color: #c2410c; }
        .floor-type-badge.office { background: #cffafe; color: #0e7490; }

        .floor-type-name {
            font-weight: 600;
        }

        .floor-type-range {
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .floor-type-actions {
            display: flex;
            gap: 0.5rem;
        }

        .floor-type-body {
            display: none;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .floor-type-card.expanded .floor-type-body {
            display: block;
        }

        .floor-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .floor-type-grid .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* Preview Table */
        .preview-section {
            margin-top: 2rem;
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .preview-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .preview-table-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .preview-table th {
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
        }

        .preview-table th.number {
            text-align: right;
        }

        .preview-table td {
            padding: 0.625rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .preview-table td.number {
            text-align: right;
            font-family: 'Space Mono', monospace;
            font-size: 0.8125rem;
        }

        .preview-table tr:last-child td {
            border-bottom: none;
        }

        .preview-table tr:hover {
            background: var(--bg-primary);
        }

        .preview-table tr.totals {
            background: var(--bg-accent);
            color: var(--text-light);
            font-weight: 600;
        }

        .preview-table tr.totals td {
            border-bottom: none;
        }

        /* Row colors by use type */
        .preview-table tr.use-residential { background: #f0fdf4; }
        .preview-table tr.use-parking { background: #f9fafb; }
        .preview-table tr.use-retail { background: #eff6ff; }
        .preview-table tr.use-amenity { background: #faf5ff; }
        .preview-table tr.use-mechanical { background: #fff7ed; }
        .preview-table tr.use-office { background: #ecfeff; }

        .preview-table tr.use-residential:hover { background: #dcfce7; }
        .preview-table tr.use-parking:hover { background: #f3f4f6; }
        .preview-table tr.use-retail:hover { background: #dbeafe; }
        .preview-table tr.use-amenity:hover { background: #f3e8ff; }
        .preview-table tr.use-mechanical:hover { background: #ffedd5; }
        .preview-table tr.use-office:hover { background: #cffafe; }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-sm);
        }

        .summary-card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .summary-card-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-card-unit {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-left: 0.25rem;
        }

        /* Parking Summary */
        .parking-summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-top: 1.5rem;
        }

        .parking-summary h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .parking-summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .parking-stat {
            text-align: center;
        }

        .parking-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .parking-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .parking-stat-value.surplus { color: var(--accent-green); }
        .parking-stat-value.deficit { color: var(--accent-red); }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-mono {
            font-family: 'Space Mono', monospace;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .floor-type-card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                top: 0;
                max-height: none;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .floor-type-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Default Heights Table */
        .default-heights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .default-height-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.375rem 0;
            font-size: 0.8125rem;
        }

        .default-height-item label {
            color: var(--text-secondary);
        }

        .default-height-item input {
            width: 70px;
            padding: 0.25rem 0.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            text-align: right;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-accent);
            color: var(--text-light);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .toast.success {
            background: var(--accent-green);
        }

        .toast.error {
            background: var(--accent-red);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div>
            <h1>Residential Tower Stacking Tool</h1>
            <div class="header-subtitle">Generate Excel stacking diagrams with live formulas</div>
        </div>
        <div class="header-actions">
            <button class="btn btn-success" onclick="generateExcel()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download Excel
            </button>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Project Settings -->
            <div class="sidebar-section">
                <h3>Project Settings</h3>
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" value="My Residential Tower" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label for="efficiency">Typical Floor Residential Efficiency</label>
                    <input type="range" id="efficiency" min="70" max="95" value="85" oninput="updateEfficiencyDisplay()">
                    <div class="range-value" id="efficiencyValue">85%</div>
                </div>
                <div class="form-group">
                    <label for="efficiencyGoal">Overall Efficiency Goal</label>
                    <input type="range" id="efficiencyGoal" min="70" max="95" value="80" oninput="updateEfficiencyGoalDisplay()">
                    <div class="range-value" id="efficiencyGoalValue">80%</div>
                </div>
                <div class="form-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="skip13" onchange="updatePreview()">
                        <span>Skip Floor 13</span>
                    </label>
                </div>
            </div>

            <!-- Parking Calculator -->
            <div class="sidebar-section">
                <h3>Parking Calculator</h3>
                <div class="form-group">
                    <label for="sfPerCar">SF per Car</label>
                    <input type="number" id="sfPerCar" value="410" min="100" max="600" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>Parking Ratio Method</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="parkingMethod" value="beds" checked onchange="updateParkingMethod()">
                            <span>Cars per Bed</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="parkingMethod" value="units" onchange="updateParkingMethod()">
                            <span>Cars per Unit</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="parkingMethod" value="fixed" onchange="updateParkingMethod()">
                            <span>Fixed Count</span>
                        </label>
                    </div>
                </div>
                <div class="form-group" id="parkingRatioGroup">
                    <label for="parkingRatio">Cars per Bed Ratio</label>
                    <input type="number" id="parkingRatio" value="0.9" min="0.1" max="3" step="0.1" oninput="updatePreview()">
                </div>
                <div class="form-group hidden" id="fixedParkingGroup">
                    <label for="fixedParking">Required Cars</label>
                    <input type="number" id="fixedParking" value="150" min="1" oninput="updatePreview()">
                </div>
            </div>

            <!-- Default Heights -->
            <div class="sidebar-section">
                <h3>Default Heights</h3>
                <div class="default-heights-grid">
                    <div class="default-height-item">
                        <label>Below Grade</label>
                        <input type="text" id="defaultHeightBelowGrade" value="10' 0&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Ground</label>
                        <input type="text" id="defaultHeightGround" value="18' 0&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>P2 (Van)</label>
                        <input type="text" id="defaultHeightP2" value="11' 0&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>P3+ Parking</label>
                        <input type="text" id="defaultHeightParking" value="9' 8&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Residential</label>
                        <input type="text" id="defaultHeightResidential" value="10' 8&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Amenity</label>
                        <input type="text" id="defaultHeightAmenity" value="12' 0&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Penthouse</label>
                        <input type="text" id="defaultHeightPenthouse" value="11' 8&quot;" oninput="updatePreview()">
                    </div>
                    <div class="default-height-item">
                        <label>Mechanical</label>
                        <input type="text" id="defaultHeightMechanical" value="15' 0&quot;" oninput="updatePreview()">
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="sidebar-section">
                <button class="btn btn-secondary btn-full" onclick="resetToDefaults()">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    Reset &amp; Start Over
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-card-label">Total Floors</div>
                    <div class="summary-card-value" id="summaryFloors">0<span class="summary-card-unit">floors</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total Height</div>
                    <div class="summary-card-value" id="summaryHeight">0<span class="summary-card-unit">ft</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total GSF</div>
                    <div class="summary-card-value" id="summaryGSF">0<span class="summary-card-unit">SF</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total RSF</div>
                    <div class="summary-card-value" id="summaryRSF">0<span class="summary-card-unit">SF</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Efficiency</div>
                    <div class="summary-card-value" id="summaryEfficiency">0<span class="summary-card-unit">%</span></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total Parking</div>
                    <div class="summary-card-value" id="summaryParking">0<span class="summary-card-unit">cars</span></div>
                </div>
            </div>

            <!-- Floor Types Configuration -->
            <div class="floor-types-header">
                <h2>Floor Type Configuration</h2>
                <button class="btn btn-primary" onclick="addFloorType()">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Floor Type
                </button>
            </div>

            <div id="floorTypesContainer">
                <!-- Floor type cards will be rendered here -->
            </div>

            <button class="btn btn-secondary" onclick="renumberFloors()" style="margin-top: 1rem;">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Renumber Floors
            </button>

            <!-- Preview Table -->
            <div class="preview-section">
                <div class="preview-header">
                    <h2>Building Preview</h2>
                </div>
                
                <div class="preview-table-wrapper">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Floor</th>
                                <th>Type</th>
                                <th>Use</th>
                                <th class="number">Height</th>
                                <th class="number">GSF</th>
                                <th class="number">Efficiency</th>
                                <th class="number">RSF</th>
                                <th class="number">Parking SF</th>
                                <th class="number">Calc Cars</th>
                                <th class="number">Actual Cars</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- Preview rows will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <!-- Parking Summary -->
                <div class="parking-summary">
                    <h3>
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                        Parking Summary
                    </h3>
                    <div class="parking-summary-grid">
                        <div class="parking-stat">
                            <div class="parking-stat-label">Parking Provided</div>
                            <div class="parking-stat-value" id="parkingProvided">0</div>
                        </div>
                        <div class="parking-stat">
                            <div class="parking-stat-label">Parking Required</div>
                            <div class="parking-stat-value" id="parkingRequired">0</div>
                        </div>
                        <div class="parking-stat">
                            <div class="parking-stat-label">Surplus / (Deficit)</div>
                            <div class="parking-stat-value" id="parkingSurplus">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        let state = {
            floorTypes: [],
            projectName: 'My Residential Tower',
            efficiency: 0.85,
            efficiencyGoal: 0.80,
            skip13: false,
            sfPerCar: 410,
            parkingMethod: 'beds',
            parkingRatio: 0.9,
            fixedParking: 150,
            defaultHeights: {
                belowGrade: 10.0,
                ground: 18.0,
                p2: 11.0,
                parking: 9.67,
                residential: 10.67,
                amenity: 12.0,
                penthouse: 11.67,
                mechanical: 15.0
            }
        };

        const USE_TYPES = ['Residential', 'Parking', 'Retail', 'Amenity', 'Mechanical', 'Office'];

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function feetInchesToDecimal(str) {
            if (!str) return 10.0;
            str = str.toString().trim();
            
            // If already a number
            if (!str.includes("'") && !str.includes('"')) {
                return parseFloat(str) || 10.0;
            }
            
            // Parse feet and inches
            const match = str.match(/(\d+)'?\s*(\d+)?/);
            if (match) {
                const feet = parseInt(match[1]) || 0;
                const inches = parseInt(match[2]) || 0;
                return feet + (inches / 12);
            }
            return 10.0;
        }

        function decimalToFeetInches(decimal) {
            const feet = Math.floor(decimal);
            const inches = Math.round((decimal - feet) * 12);
            return `${feet}' ${inches}"`;
        }

        function parseFloorLabel(label) {
            label = String(label).trim().toUpperCase();
            
            // Plenum
            if (label.includes('PLENUM')) {
                const baseLabel = label.replace('PLENUM', '').trim();
                return parseFloorLabel(baseLabel) - 0.5;
            }
            
            // Below grade (B1, B2, etc)
            if (label.startsWith('B')) {
                const nums = label.match(/\d+/);
                if (nums) return -1000 - parseInt(nums[0]);
                return -1000;
            }
            
            // Parking levels (P2, P3, etc)
            if (label.startsWith('P')) {
                const nums = label.match(/\d+/);
                if (nums) return parseInt(nums[0]);
                return 2;
            }
            
            // Ground floor
            if (['G', 'GROUND', 'GF'].includes(label)) {
                return 1;
            }
            
            // Numbered floors
            const nums = label.match(/\d+/);
            if (nums) return parseInt(nums[0]);
            
            return 1;
        }

        function generateFloorRange(start, end, skip13 = false) {
            const startNum = parseFloorLabel(start);
            const endNum = parseFloorLabel(end);
            const floors = [];
            
            const isPRange = start.toUpperCase().startsWith('P') || end.toUpperCase().startsWith('P');
            
            // Below grade range
            if (startNum < 0 && endNum < 0) {
                const startB = Math.abs(startNum + 1000);
                const endB = Math.abs(endNum + 1000);
                for (let i = Math.max(startB, endB); i >= Math.min(startB, endB); i--) {
                    floors.push(`B${i}`);
                }
            }
            // P-levels (parking above grade)
            else if (isPRange) {
                const startP = parseInt(start.match(/\d+/)?.[0]) || 2;
                const endP = parseInt(end.match(/\d+/)?.[0]) || 2;
                for (let i = startP; i <= endP; i++) {
                    floors.push(`P${i}`);
                }
            }
            // Mixed range (below grade to above grade)
            else if (startNum <= 0 && endNum >= 0) {
                // Below grade portion
                if (startNum < 0) {
                    const startB = Math.abs(startNum + 1000);
                    for (let i = startB; i >= 1; i--) {
                        floors.push(`B${i}`);
                    }
                }
                // Ground
                floors.push('G');
                // Above grade
                for (let i = 2; i <= endNum; i++) {
                    if (skip13 && i === 13) continue;
                    floors.push(String(i).padStart(2, '0'));
                }
            }
            // Above grade only
            else {
                const minNum = Math.min(startNum, endNum);
                const maxNum = Math.max(startNum, endNum);
                for (let i = minNum; i <= maxNum; i++) {
                    if (skip13 && i === 13) continue;
                    if (i === 1) {
                        floors.push('G');
                    } else {
                        floors.push(String(i).padStart(2, '0'));
                    }
                }
            }
            
            return floors;
        }

        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        // ============================================
        // UI RENDERING
        // ============================================

        function renderFloorTypes() {
            const container = document.getElementById('floorTypesContainer');
            container.innerHTML = '';
            
            // Create a sorted copy for display (roof at top, basement at bottom)
            const sortedIndices = state.floorTypes.map((ft, idx) => ({
                idx,
                sortOrder: parseFloorLabel(ft.startFloor)
            })).sort((a, b) => b.sortOrder - a.sortOrder);
            
            sortedIndices.forEach(({idx: index}) => {
                const ft = state.floorTypes[index];
                const card = document.createElement('div');
                card.className = `floor-type-card ${ft.expanded ? 'expanded' : ''}`;
                card.innerHTML = `
                    <div class="floor-type-header" onclick="toggleFloorType(${index})">
                        <div class="floor-type-info">
                            <span class="floor-type-badge ${ft.use.toLowerCase()}">${ft.use}</span>
                            <span class="floor-type-name">${ft.name}</span>
                            <span class="floor-type-range">${ft.startFloor} → ${ft.endFloor}</span>
                        </div>
                        <div class="floor-type-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-secondary" onclick="moveFloorType(${index}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="btn btn-sm btn-secondary" onclick="moveFloorType(${index}, 1)" ${index === state.floorTypes.length - 1 ? 'disabled' : ''}>↓</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFloorType(${index})">✕</button>
                        </div>
                    </div>
                    <div class="floor-type-body">
                        <div class="floor-type-grid">
                            <div class="form-group">
                                <label>Use</label>
                                <select onchange="updateFloorTypeField(${index}, 'use', this.value)">
                                    ${USE_TYPES.map(u => `<option value="${u}" ${ft.use === u ? 'selected' : ''}>${u}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" value="${ft.name}" onchange="updateFloorTypeField(${index}, 'name', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Starting Floor</label>
                                <input type="text" value="${ft.startFloor}" onchange="updateFloorTypeField(${index}, 'startFloor', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Ending Floor</label>
                                <input type="text" value="${ft.endFloor}" onchange="updateFloorTypeField(${index}, 'endFloor', this.value)">
                            </div>
                            <div class="form-group">
                                <label>GSF per Floor</label>
                                <input type="number" value="${ft.gsf}" onchange="updateFloorTypeField(${index}, 'gsf', parseInt(this.value))">
                            </div>
                            <div class="form-group">
                                <label>Floor Height</label>
                                <input type="text" value="${ft.height}" onchange="updateFloorTypeField(${index}, 'height', this.value)">
                            </div>
                            ${ft.use === 'Parking' ? `
                            <div class="form-group">
                                <label>Parking SF (if different from GSF)</label>
                                <input type="number" value="${ft.parkingSF || ''}" placeholder="Same as GSF" onchange="updateFloorTypeField(${index}, 'parkingSF', parseInt(this.value) || null)">
                            </div>
                            <div class="form-group">
                                <label>Actual Cars (optional override)</label>
                                <input type="number" value="${ft.actualCars || ''}" placeholder="Calculated" onchange="updateFloorTypeField(${index}, 'actualCars', parseInt(this.value) || null)">
                            </div>
                            ` : ''}
                            <div class="form-group full-width">
                                <label class="checkbox-group">
                                    <input type="checkbox" ${ft.countsInGSF ? 'checked' : ''} onchange="updateFloorTypeField(${index}, 'countsInGSF', this.checked)">
                                    <span>Counts in Total GSF</span>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderPreviewTable() {
            const tbody = document.getElementById('previewTableBody');
            const allFloors = generateAllFloors();
            
            // Sort floors from top to bottom (roof to basement)
            allFloors.sort((a, b) => b.sortOrder - a.sortOrder);
            
            let totalFloors = 0;
            let totalHeight = 0;
            let totalGSF = 0;
            let totalRSF = 0;
            let totalParking = 0;
            let totalParkingSF = 0;
            let totalBeds = 0;
            let totalUnits = 0;
            let totalCalcCars = 0;
            let totalActualCars = 0;
            
            let html = '';
            
            allFloors.forEach(floor => {
                const height = feetInchesToDecimal(floor.height);
                const efficiency = floor.use === 'Residential' ? state.efficiency : 0;
                const rsf = floor.use === 'Residential' ? Math.round(floor.gsf * efficiency) : 0;
                const parkingSF = floor.use === 'Parking' ? (floor.parkingSF || floor.gsf) : 0;
                const calcCars = parkingSF > 0 ? Math.floor(parkingSF / state.sfPerCar) : 0;
                const actualCars = floor.actualCars || 0;
                
                if (floor.countsInGSF) {
                    totalFloors++;
                    totalGSF += floor.gsf;
                }
                totalHeight += height;
                totalRSF += rsf;
                totalCalcCars += calcCars;
                totalActualCars += actualCars;
                totalParking += actualCars > 0 ? actualCars : calcCars;
                totalParkingSF += parkingSF;
                
                // Estimate beds/units for residential
                if (floor.use === 'Residential') {
                    const avgUnitSize = 1000; // Assumption
                    const unitsOnFloor = Math.round(rsf / avgUnitSize);
                    const bedsOnFloor = Math.round(unitsOnFloor * 1.8); // Assumption: avg 1.8 beds/unit
                    totalBeds += bedsOnFloor;
                    totalUnits += unitsOnFloor;
                }
                
                html += `
                    <tr class="use-${floor.use.toLowerCase()}">
                        <td class="text-mono">${floor.label}</td>
                        <td>${floor.typeName}</td>
                        <td>${floor.use}</td>
                        <td class="number">${decimalToFeetInches(height)}</td>
                        <td class="number">${floor.countsInGSF ? formatNumber(floor.gsf) : '-'}</td>
                        <td class="number">${floor.use === 'Residential' ? Math.round(efficiency * 100) + '%' : '-'}</td>
                        <td class="number">${rsf > 0 ? formatNumber(rsf) : '-'}</td>
                        <td class="number">${parkingSF > 0 ? formatNumber(parkingSF) : '-'}</td>
                        <td class="number">${calcCars > 0 ? calcCars : '-'}</td>
                        <td class="number">${floor.actualCars ? floor.actualCars : '-'}</td>
                    </tr>
                `;
            });
            
            // Totals row
            const overallEfficiency = totalGSF > 0 ? (totalRSF / totalGSF * 100) : 0;
            
            html += `
                <tr class="totals">
                    <td colspan="3">TOTALS</td>
                    <td class="number">${decimalToFeetInches(totalHeight)}</td>
                    <td class="number">${formatNumber(totalGSF)} GSF</td>
                    <td class="number">${overallEfficiency.toFixed(1)}%</td>
                    <td class="number">${formatNumber(totalRSF)} RSF</td>
                    <td class="number">${formatNumber(totalParkingSF)} SF</td>
                    <td class="number">${totalCalcCars} cars</td>
                    <td class="number">${totalActualCars > 0 ? totalActualCars + ' cars' : '-'}</td>
                </tr>
            `;
            
            tbody.innerHTML = html;
            
            // Update summary cards
            document.getElementById('summaryFloors').innerHTML = `${totalFloors}<span class="summary-card-unit">floors</span>`;
            document.getElementById('summaryHeight').innerHTML = `${Math.round(totalHeight)}<span class="summary-card-unit">ft</span>`;
            document.getElementById('summaryGSF').innerHTML = `${formatNumber(totalGSF)}<span class="summary-card-unit">SF</span>`;
            document.getElementById('summaryRSF').innerHTML = `${formatNumber(totalRSF)}<span class="summary-card-unit">SF</span>`;
            document.getElementById('summaryEfficiency').innerHTML = `${overallEfficiency.toFixed(1)}<span class="summary-card-unit">%</span>`;
            document.getElementById('summaryParking').innerHTML = `${totalParking}<span class="summary-card-unit">cars</span>`;
            
            // Update parking summary
            let requiredParking = 0;
            if (state.parkingMethod === 'beds') {
                requiredParking = Math.round(totalBeds * state.parkingRatio);
            } else if (state.parkingMethod === 'units') {
                requiredParking = Math.round(totalUnits * state.parkingRatio);
            } else {
                requiredParking = state.fixedParking;
            }
            
            const parkingSurplus = totalParking - requiredParking;
            
            document.getElementById('parkingProvided').textContent = totalParking;
            document.getElementById('parkingRequired').textContent = requiredParking;
            
            const surplusEl = document.getElementById('parkingSurplus');
            surplusEl.textContent = parkingSurplus >= 0 ? `+${parkingSurplus}` : parkingSurplus;
            surplusEl.className = `parking-stat-value ${parkingSurplus >= 0 ? 'surplus' : 'deficit'}`;
        }

        function generateAllFloors() {
            const allFloors = [];
            
            state.floorTypes.forEach(ft => {
                const floors = generateFloorRange(ft.startFloor, ft.endFloor, state.skip13);
                floors.forEach(label => {
                    allFloors.push({
                        label: label,
                        typeName: ft.name,
                        use: ft.use,
                        gsf: ft.gsf,
                        height: ft.height,
                        countsInGSF: ft.countsInGSF,
                        parkingSF: ft.parkingSF,
                        actualCars: ft.actualCars,
                        sortOrder: parseFloorLabel(label)
                    });
                });
            });
            
            return allFloors;
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================

        function toggleFloorType(index) {
            state.floorTypes[index].expanded = !state.floorTypes[index].expanded;
            renderFloorTypes();
        }

        function updateFloorTypeField(index, field, value) {
            state.floorTypes[index][field] = value;
            renderFloorTypes();
            updatePreview();
        }

        function addFloorType() {
            const newType = {
                name: 'New Floor Type',
                use: 'Residential',
                startFloor: '02',
                endFloor: '10',
                gsf: 22000,
                height: "10' 8\"",
                countsInGSF: true,
                parkingSF: null,
                actualCars: null,
                expanded: true
            };
            state.floorTypes.push(newType);
            renderFloorTypes();
            updatePreview();
        }

        function deleteFloorType(index) {
            state.floorTypes.splice(index, 1);
            renderFloorTypes();
            updatePreview();
        }

        function moveFloorType(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= state.floorTypes.length) return;
            
            const temp = state.floorTypes[index];
            state.floorTypes[index] = state.floorTypes[newIndex];
            state.floorTypes[newIndex] = temp;
            
            renderFloorTypes();
            updatePreview();
        }

        function updateEfficiencyDisplay() {
            const value = document.getElementById('efficiency').value;
            document.getElementById('efficiencyValue').textContent = value + '%';
            state.efficiency = value / 100;
            updatePreview();
        }

        function updateEfficiencyGoalDisplay() {
            const value = document.getElementById('efficiencyGoal').value;
            document.getElementById('efficiencyGoalValue').textContent = value + '%';
            state.efficiencyGoal = value / 100;
            updatePreview();
        }

        function updateParkingMethod() {
            const method = document.querySelector('input[name="parkingMethod"]:checked').value;
            state.parkingMethod = method;
            
            const ratioGroup = document.getElementById('parkingRatioGroup');
            const fixedGroup = document.getElementById('fixedParkingGroup');
            const ratioLabel = ratioGroup.querySelector('label');
            
            if (method === 'fixed') {
                ratioGroup.classList.add('hidden');
                fixedGroup.classList.remove('hidden');
            } else {
                ratioGroup.classList.remove('hidden');
                fixedGroup.classList.add('hidden');
                ratioLabel.textContent = method === 'beds' ? 'Cars per Bed Ratio' : 'Cars per Unit Ratio';
            }
            
            updatePreview();
        }

        function updatePreview() {
            // Update state from inputs
            state.projectName = document.getElementById('projectName').value;
            state.skip13 = document.getElementById('skip13').checked;
            state.sfPerCar = parseInt(document.getElementById('sfPerCar').value) || 410;
            state.parkingRatio = parseFloat(document.getElementById('parkingRatio').value) || 0.9;
            state.fixedParking = parseInt(document.getElementById('fixedParking').value) || 150;
            
            // Update default heights
            state.defaultHeights = {
                belowGrade: feetInchesToDecimal(document.getElementById('defaultHeightBelowGrade').value),
                ground: feetInchesToDecimal(document.getElementById('defaultHeightGround').value),
                p2: feetInchesToDecimal(document.getElementById('defaultHeightP2').value),
                parking: feetInchesToDecimal(document.getElementById('defaultHeightParking').value),
                residential: feetInchesToDecimal(document.getElementById('defaultHeightResidential').value),
                amenity: feetInchesToDecimal(document.getElementById('defaultHeightAmenity').value),
                penthouse: feetInchesToDecimal(document.getElementById('defaultHeightPenthouse').value),
                mechanical: feetInchesToDecimal(document.getElementById('defaultHeightMechanical').value)
            };
            
            renderPreviewTable();
        }

        function renumberFloors() {
            // Sort floor types by their starting floor (lowest to highest)
            const sortedTypes = [...state.floorTypes].sort((a, b) => {
                return parseFloorLabel(a.startFloor) - parseFloorLabel(b.startFloor);
            });
            
            let currentFloor = null;
            
            sortedTypes.forEach((ft, idx) => {
                const startNum = parseFloorLabel(ft.startFloor);
                const endNum = parseFloorLabel(ft.endFloor);
                const floorCount = Math.abs(endNum - startNum) + 1;
                
                // Below grade floors
                if (ft.startFloor.toUpperCase().startsWith('B')) {
                    // Keep B-levels as they are - they're typically fixed
                    return;
                }
                
                // P-levels (parking above grade)
                if (ft.startFloor.toUpperCase().startsWith('P')) {
                    // Keep P-levels as they are
                    return;
                }
                
                // Ground floor
                if (['G', 'GROUND', 'GF'].includes(ft.startFloor.toUpperCase())) {
                    currentFloor = 1;
                    return;
                }
                
                // Above grade numbered floors
                if (currentFloor === null) {
                    // First numbered floor type, start from its current position
                    currentFloor = startNum;
                }
                
                // Find the original index in state.floorTypes
                const origIdx = state.floorTypes.findIndex(f => f === ft);
                
                // Calculate new start and end
                let newStart = currentFloor;
                let newEnd = currentFloor + floorCount - 1;
                
                // Account for skip 13
                if (state.skip13) {
                    if (newStart <= 13 && newEnd >= 13) {
                        newEnd++; // Add one more to account for skipped 13
                    }
                }
                
                // Update the floor type
                if (newStart === 1) {
                    state.floorTypes[origIdx].startFloor = 'G';
                } else {
                    state.floorTypes[origIdx].startFloor = String(newStart).padStart(2, '0');
                }
                
                if (newEnd === 1) {
                    state.floorTypes[origIdx].endFloor = 'G';
                } else {
                    state.floorTypes[origIdx].endFloor = String(newEnd).padStart(2, '0');
                }
                
                currentFloor = newEnd + 1;
                
                // Skip 13 if needed
                if (state.skip13 && currentFloor === 13) {
                    currentFloor = 14;
                }
            });
            
            renderFloorTypes();
            showToast('Floors renumbered!', 'success');
            updatePreview();
        }

        function resetToDefaults() {
            if (!confirm('Are you sure you want to reset all settings? This cannot be undone.')) return;
            
            state = {
                floorTypes: getDefaultFloorTypes(),
                projectName: 'My Residential Tower',
                efficiency: 0.85,
                efficiencyGoal: 0.80,
                skip13: false,
                sfPerCar: 410,
                parkingMethod: 'beds',
                parkingRatio: 0.9,
                fixedParking: 150,
                defaultHeights: {
                    belowGrade: 10.0,
                    ground: 18.0,
                    p2: 11.0,
                    parking: 9.67,
                    residential: 10.67,
                    amenity: 12.0,
                    penthouse: 11.67,
                    mechanical: 15.0
                }
            };
            
            // Reset form inputs
            document.getElementById('projectName').value = state.projectName;
            document.getElementById('efficiency').value = state.efficiency * 100;
            document.getElementById('efficiencyValue').textContent = Math.round(state.efficiency * 100) + '%';
            document.getElementById('efficiencyGoal').value = state.efficiencyGoal * 100;
            document.getElementById('efficiencyGoalValue').textContent = Math.round(state.efficiencyGoal * 100) + '%';
            document.getElementById('skip13').checked = state.skip13;
            document.getElementById('sfPerCar').value = state.sfPerCar;
            document.getElementById('parkingRatio').value = state.parkingRatio;
            document.getElementById('fixedParking').value = state.fixedParking;
            
            renderFloorTypes();
            updatePreview();
            showToast('Reset to defaults!', 'success');
        }

        function getDefaultFloorTypes() {
            return [
                { name: 'Below Grade Parking', use: 'Parking', startFloor: 'B3', endFloor: 'B1', gsf: 45000, height: "10' 0\"", countsInGSF: false, expanded: false },
                { name: 'Ground Level', use: 'Retail', startFloor: 'G', endFloor: 'G', gsf: 38000, height: "18' 0\"", countsInGSF: true, expanded: false },
                { name: 'P2 - Van Accessible', use: 'Parking', startFloor: 'P2', endFloor: 'P2', gsf: 40000, height: "11' 0\"", countsInGSF: false, expanded: false },
                { name: 'Above Grade Parking', use: 'Parking', startFloor: 'P3', endFloor: 'P4', gsf: 40000, height: "9' 8\"", countsInGSF: false, expanded: false },
                { name: 'Amenity Level', use: 'Amenity', startFloor: '05', endFloor: '05', gsf: 22000, height: "12' 0\"", countsInGSF: true, expanded: false },
                { name: 'Tower - Lower Typical', use: 'Residential', startFloor: '06', endFloor: '12', gsf: 22000, height: "10' 8\"", countsInGSF: true, expanded: false },
                { name: 'Tower - Upper Typical', use: 'Residential', startFloor: '14', endFloor: '20', gsf: 22000, height: "10' 8\"", countsInGSF: true, expanded: false },
                { name: 'Penthouse', use: 'Residential', startFloor: '21', endFloor: '22', gsf: 18000, height: "11' 8\"", countsInGSF: true, expanded: false },
                { name: 'Roof - Mechanical', use: 'Mechanical', startFloor: '23', endFloor: '23', gsf: 5000, height: "15' 0\"", countsInGSF: false, expanded: false }
            ];
        }

        // ============================================
        // EXCEL GENERATION
        // ============================================

        async function generateExcel() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Stacking Diagram');
            
            // Define styles
            const headerStyle = {
                font: { bold: true, color: { argb: 'FFFFFFFF' }, size: 11 },
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1A1A1A' } },
                alignment: { horizontal: 'center', vertical: 'middle' },
                border: { bottom: { style: 'thin', color: { argb: 'FF000000' } } }
            };
            
            const totalStyle = {
                font: { bold: true, color: { argb: 'FFFFFFFF' }, size: 11 },
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1A1A1A' } },
                alignment: { vertical: 'middle' }
            };
            
            // Add title
            worksheet.mergeCells('A1:K1');
            const titleCell = worksheet.getCell('A1');
            titleCell.value = state.projectName;
            titleCell.font = { bold: true, size: 16 };
            titleCell.alignment = { horizontal: 'center' };
            
            // Add column headers
            const headers = ['Floor', 'Type', 'Use', 'Height', 'GSF', 'Efficiency', 'RSF', 'Parking SF', 'Calc Cars', 'Actual Cars'];
            const headerRow = worksheet.addRow(headers);
            headerRow.eachCell((cell) => {
                Object.assign(cell, headerStyle);
            });
            
            // Add blank row after header
            worksheet.addRow([]);
            
            // Set column widths
            worksheet.columns = [
                { width: 10 },  // Floor
                { width: 25 },  // Type
                { width: 12 },  // Use
                { width: 12 },  // Height
                { width: 15 },  // GSF
                { width: 12 },  // Efficiency
                { width: 15 },  // RSF
                { width: 15 },  // Parking SF
                { width: 12 },  // Calc Cars
                { width: 12 }   // Actual Cars
            ];
            
            // Generate floor data
            const allFloors = generateAllFloors();
            allFloors.sort((a, b) => b.sortOrder - a.sortOrder);
            
            const firstDataRow = 4; // Row 4 because of title, header, blank row
            let rowNum = firstDataRow;
            
            // Use color mapping
            const useColors = {
                'Residential': 'FFF0FDF4',
                'Parking': 'FFD1D5DB',      // Darker gray for parking
                'Retail': 'FFEFF6FF',
                'Amenity': 'FFFAF5FF',
                'Mechanical': 'FFFFF7ED',
                'Office': 'FFECFEFF'
            };
            
            // Below grade gets even darker gray
            const belowGradeColor = 'FF9CA3AF';
            
            allFloors.forEach((floor, index) => {
                const height = feetInchesToDecimal(floor.height);
                const efficiency = floor.use === 'Residential' ? state.efficiency : 0;
                const parkingSF = floor.use === 'Parking' ? (floor.parkingSF || floor.gsf) : 0;
                const isBelowGrade = floor.label.toUpperCase().startsWith('B');
                
                const row = worksheet.addRow([
                    floor.label,
                    floor.typeName,
                    floor.use,
                    height,
                    floor.countsInGSF ? floor.gsf : '',
                    floor.use === 'Residential' ? efficiency : '',
                    '', // RSF - formula
                    parkingSF > 0 ? parkingSF : '',
                    '', // Calc Cars - formula
                    floor.actualCars || ''  // Actual Cars
                ]);
                
                // Apply row color based on use type (darker for below grade)
                const rowColor = isBelowGrade ? belowGradeColor : (useColors[floor.use] || 'FFFFFFFF');
                row.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: rowColor }
                    };
                });
                
                // Format height as feet-inches
                row.getCell(4).numFmt = '0.00" ft"';
                
                // Format GSF
                row.getCell(5).numFmt = '#,##0';
                
                // Format Efficiency as percentage
                if (floor.use === 'Residential') {
                    row.getCell(6).numFmt = '0%';
                }
                
                // RSF Formula: =IF(F{row}>0, E{row}*F{row}, 0)
                if (floor.use === 'Residential' && floor.countsInGSF) {
                    row.getCell(7).value = { formula: `IF(F${rowNum}>0,E${rowNum}*F${rowNum},0)` };
                }
                row.getCell(7).numFmt = '#,##0';
                
                // Parking SF format
                row.getCell(8).numFmt = '#,##0';
                
                // Calc Cars Formula: =IF(H{row}>0, INT(H{row}/$sfPerCar), "")
                if (parkingSF > 0) {
                    row.getCell(9).value = { formula: `IF(H${rowNum}>0,INT(H${rowNum}/${state.sfPerCar}),"")` };
                }
                
                rowNum++;
            });
            
            const lastDataRow = rowNum - 1;
            
            // Add blank row before totals
            worksheet.addRow([]);
            rowNum++;
            
            // Add Totals Row
            const totalsRow = worksheet.addRow([
                'TOTALS',
                { formula: `COUNTA(B${firstDataRow}:B${lastDataRow}) & " Floors"` },
                '',
                { formula: `SUM(D${firstDataRow}:D${lastDataRow})` },
                { formula: `SUM(E${firstDataRow}:E${lastDataRow})` },
                '',
                { formula: `SUM(G${firstDataRow}:G${lastDataRow})` },
                { formula: `SUM(H${firstDataRow}:H${lastDataRow})` },
                { formula: `SUM(I${firstDataRow}:I${lastDataRow})` },
                { formula: `SUM(J${firstDataRow}:J${lastDataRow})` }
            ]);
            
            totalsRow.eachCell((cell, colNumber) => {
                Object.assign(cell, totalStyle);
                if (colNumber === 4) cell.numFmt = '0.00" ft"';
                if (colNumber === 5) cell.numFmt = '#,##0" GSF"';
                if (colNumber === 7) cell.numFmt = '#,##0" RSF"';
                if (colNumber === 8) cell.numFmt = '#,##0" SF"';
                if (colNumber === 9) cell.numFmt = '#,##0" cars"';
                if (colNumber === 10) cell.numFmt = '#,##0" cars"';
            });
            
            const totalsRowNum = rowNum;
            rowNum++;
            
            // Add blank row after totals
            worksheet.addRow([]);
            rowNum++;
            
            // Add Overall Efficiency row
            const effRow = worksheet.addRow(['', '', '', '', 'Overall Efficiency:', { formula: `IF(E${totalsRowNum}>0,G${totalsRowNum}/E${totalsRowNum},0)` }]);
            effRow.getCell(6).numFmt = '0.0%';
            effRow.getCell(5).font = { bold: true };
            effRow.getCell(6).font = { bold: true };
            rowNum++;
            
            // Add Delta to Goal row - using the efficiency goal from state
            const goalPercent = Math.round(state.efficiencyGoal * 100);
            const deltaRow = worksheet.addRow(['', '', '', '', `Delta to ${goalPercent}%:`, { formula: `G${totalsRowNum}-(E${totalsRowNum}*${state.efficiencyGoal})` }]);
            deltaRow.getCell(6).numFmt = '#,##0" RSF"';
            deltaRow.getCell(5).font = { bold: true };
            deltaRow.getCell(6).font = { bold: true };
            rowNum += 2;
            
            // Add Parking Summary Section - moved to column B
            const parkingSummaryHeader = worksheet.addRow(['', 'PARKING SUMMARY']);
            parkingSummaryHeader.getCell(2).font = { bold: true, size: 12 };
            worksheet.mergeCells(`B${rowNum}:D${rowNum}`);
            rowNum++;
            
            // Calculate required parking based on method
            let requiredFormula = '';
            if (state.parkingMethod === 'beds') {
                // Estimate beds from RSF (assumption: 1000 SF/unit, 1.8 beds/unit)
                requiredFormula = `ROUND(G${totalsRowNum}/1000*1.8*${state.parkingRatio},0)`;
            } else if (state.parkingMethod === 'units') {
                requiredFormula = `ROUND(G${totalsRowNum}/1000*${state.parkingRatio},0)`;
            } else {
                requiredFormula = `${state.fixedParking}`;
            }
            
            // Use Actual Cars total (column J) or Calc Cars (column I) if no actuals
            const providedRow = worksheet.addRow(['', 'Parking Provided:', { formula: `IF(J${totalsRowNum}>0,J${totalsRowNum},I${totalsRowNum})` }]);
            providedRow.getCell(3).numFmt = '#,##0" cars"';
            const providedRowNum = rowNum;
            rowNum++;
            
            const requiredRow = worksheet.addRow(['', 'Parking Required:', { formula: requiredFormula }]);
            requiredRow.getCell(3).numFmt = '#,##0" cars"';
            const requiredRowNum = rowNum;
            rowNum++;
            
            const surplusRow = worksheet.addRow(['', 'Surplus / (Deficit):', { formula: `C${providedRowNum}-C${requiredRowNum}` }]);
            surplusRow.getCell(3).numFmt = '#,##0" cars"';
            surplusRow.getCell(3).font = { bold: true };
            
            // Add assumptions note
            rowNum += 2;
            const notesRow = worksheet.addRow(['', `SF per Car: ${state.sfPerCar} SF | Parking Method: ${state.parkingMethod} | Ratio: ${state.parkingRatio}`]);
            notesRow.getCell(2).font = { italic: true, color: { argb: 'FF666666' } };
            
            // Generate file
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${state.projectName.replace(/[^a-z0-9]/gi, '_')}_Stacking.xlsx`;
            link.click();
            
            window.URL.revokeObjectURL(url);
            showToast('Excel file downloaded!', 'success');
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            state.floorTypes = getDefaultFloorTypes();
            renderFloorTypes();
            updatePreview();
        }

        // Start the app
        init();
    </script>
</body>
</html>
